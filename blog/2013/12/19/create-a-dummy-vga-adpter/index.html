<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content=lofyer><link href=https://docs.lofyer.org/blog/2013/12/19/create-a-dummy-vga-adpter/ rel=canonical><link href=../../16/%E4%BB%96%E4%BB%AC%E9%83%BD%E4%B8%8D%E8%A7%81%E4%BA%86/ rel=prev><link href=../../../../2014/01/19/2013-2014/ rel=next><link rel=icon href=../../../../../images/favicon.ico><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.5.34"><title>Create a dummy VGA adpter - Lofyer's Blog</title><link rel=stylesheet href=../../../../../assets/stylesheets/main.35f28582.min.css><link rel=stylesheet href=../../../../../assets/stylesheets/palette.06af60db.min.css><script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#qemu class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../../../.. title="Lofyer's Blog" class="md-header__button md-logo" aria-label="Lofyer's Blog" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Lofyer's Blog </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Create a dummy VGA adpter </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=查找> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/lofyer/lofyer.github.io title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> lofyer/lofyer.github.io </div> </a> </div> </nav> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../../.. class=md-tabs__link> Index </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../../../ class=md-tabs__link> Blog </a> </li> <li class=md-tabs__item> <a href=../../../../../datanote/ class=md-tabs__link> Docs </a> </li> <li class=md-tabs__item> <a href=../../../../../about/about/ class=md-tabs__link> About </a> </li> <li class=md-tabs__item> <a href=../../../../../template_password/ class=md-tabs__link> [密码保护]Template </a> </li> <li class=md-tabs__item> <a href=../../../../../tags/ class=md-tabs__link> Tags </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation hidden> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../../.. title="Lofyer's Blog" class="md-nav__button md-logo" aria-label="Lofyer's Blog" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> Lofyer's Blog </label> <div class=md-nav__source> <a href=https://github.com/lofyer/lofyer.github.io title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> lofyer/lofyer.github.io </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../.. class=md-nav__link> <span class=md-ellipsis> Index </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex> <span class=md-ellipsis> Blog </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Blog </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <a href=../../../../ class=md-nav__link> <span class=md-ellipsis> 首页 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../archive/2022/ class=md-nav__link> <span class=md-ellipsis> 归档 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../category/lab/ class=md-nav__link> <span class=md-ellipsis> 分类 </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../../datanote/ class=md-nav__link> <span class=md-ellipsis> Docs </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../../../../../about/about/ class=md-nav__link> <span class=md-ellipsis> About </span> </a> </li> <li class=md-nav__item> <a href=../../../../../template_password/ class=md-nav__link> <span class=md-ellipsis> [密码保护]Template </span> </a> </li> <li class=md-nav__item> <a href=../../../../../tags/ class=md-nav__link> <span class=md-ellipsis> Tags </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#result-i-failed-in-trying-passthrough-the-graphic-card-to-win7-or-xp-now-im-try-some-patchs-and-re-compile-xen-with-my-graphic-card-biosbin class=md-nav__link> <span class=md-ellipsis> Result: I failed in trying passthrough the graphic card to Win7 or XP. Now I'm try some patchs and re-compile Xen with my graphic card bios.bin. </span> </a> </li> <li class=md-nav__item> <a href=#0-disable-radeon-driver class=md-nav__link> <span class=md-ellipsis> 0. Disable Radeon Driver </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-content md-content--post" data-md-component=content> <div class="md-sidebar md-sidebar--post" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class="md-sidebar__inner md-post"> <nav class="md-nav md-nav--primary"> <div class=md-post__back> <div class="md-nav__title md-nav__container"> <a href=../../../../ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> <span class=md-ellipsis> 回到主页 </span> </a> </div> </div> <ul class="md-post__meta md-nav__list"> <li class="md-nav__item md-nav__item--section"> <div class=md-post__title> <span class=md-ellipsis> 元数据 </span> </div> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <div class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg> <time datetime="2013-12-19 00:00:00" class=md-ellipsis>2013年12月19日</time> </div> </li> <li class=md-nav__item> <div class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"/></svg> <span class=md-ellipsis> 分类于 <a href=../../../../category/others/ >others</a></span> </div> </li> <li class=md-nav__item> <div class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg> <span class=md-ellipsis> 需要 17 分钟阅读时间 </span> </div> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <article class="md-content__inner md-typeset"> <nav class=md-tags> <a href=../../../../../tags/#vdi class=md-tag>VDI</a> </nav> <h1 id=qemu>QEMU相关</h1> <p>创建一个“虚拟”显示适配器，适用于那些“你知道你想干什么并且在干什么”的人。 原文参考 <a href=http://www.geeks3d.com/20091230/vga-hack-how-to-make-a-vga-dummy-plug/ >http://www.geeks3d.com/20091230/vga-hack-how-to-make-a-vga-dummy-plug/</a> <a href="http://blog.zorinaq.com/?e=11">http://blog.zorinaq.com/?e=11</a></p> <p>手头有两块ATI显卡，而且都有这个DVI-I接口，并且目前我的状况是两个显示器都接到了两个主板显示（集显）接口。 <a href=http://blog.lofyer.org/2013/12/create-dummy-vga-adpter/sldldvi/ ><img alt=sldldvi src=/blog/images/sldldvi.jpg></a> 原文说需要一个75欧姆的电阻，我手里暂时只有100欧姆的，而且不多，如果强烈按照原作者的意思的话效果可能会有所不同，参考现有任意款VGA控制器原理。 [连接示意图] 来自第一个链接 <a href=http://blog.lofyer.org/2013/12/create-dummy-vga-adpter/vga_dummy_electronic_schema/ ><img alt=vga_dummy_electronic_schema src=/blog/images/vga_dummy_electronic_schema.jpg></a> [效果图] 请无视我的背景，如果有人好奇的话，那是上篇文章的eZ430以及一包十块白沙。 <a href=http://blog.lofyer.org/2013/12/create-dummy-vga-adpter/qq%e5%9b%be%e7%89%8720131220001003/ ><img alt=QQ图片20131220001003 src=/blog/images/QQ图片20131220001003-757x1024.jpg></a> [结果] <a href=http://blog.lofyer.org/2013/12/create-dummy-vga-adpter/qq%e6%88%aa%e5%9b%be20131220001602/ ><img alt=QQ截图20131220001602 src=/blog/images/QQ截图20131220001602.png></a></p> <p>看见第3个显示器没？ 就是它了，你可以拿它做很多事，比如你有多块显卡，并且你想充分利用其性能，参考lucid mvp，效果上类似吧。--- title: "Gpu Passthrough in Xen" date: 2013-07-22 categories: - "cloud-infra"</p> <hr> <p>Considering that Xen's gpu passthrough is about one year ahead of kvm, so let us try that. The process is something like kvm one as I wrote before. <a href=http://blog.lofyer.org/2013/05/pass-host-gpu-to-guest-via-qemu-ncursescurses/ title="KVM GPU-Passthrough, VGA-Passthrough">KVM GPU-Passthrough, VGA-Passthrough</a></p> <h2 id=result-i-failed-in-trying-passthrough-the-graphic-card-to-win7-or-xp-now-im-try-some-patchs-and-re-compile-xen-with-my-graphic-card-biosbin>Result: I failed in trying passthrough the graphic card to Win7 or XP. Now I'm try some patchs and re-compile Xen with my graphic card bios.bin.</h2> <p>HOST: CPU: i5-3470 GPU: ATI Radeon HD 7850 OS: openSuse 12.3 KDE</p> <h2 id=0-disable-radeon-driver>0. Disable Radeon Driver</h2> <h1 id=echo-blacklist-radeon-etcmodprobedmodprobeconf>echo "blacklist radeon" &gt;&gt; /etc/modprobe.d/modprobe.conf</h1> <h1 id=mkinitrd>mkinitrd</h1> <h2 id=1-install-xen-utils>1. Install Xen-utils</h2> <p>Install Xen and its utilities via Yast.</p> <h2 id=2-modify-grubcfg>2. Modify grub.cfg</h2> <p>... echo 'Loading Xen 4.3.0_06-1.3 ...' multiboot /xen-4.3.0_06-1.3.gz placeholder iommu=1 echo 'Loading Linux 3.10.1-3.g0cd5432-xen ...' module /vmlinuz-3.10.1-3.g0cd5432-xen placeholder root=UUID=da6ac064-2a5e-48c7-8834-307cbcb551c3 ro resume=/dev/disk/by-id/ata-ST500DM002-1BD142_Z3THR3V3-part3 splash=silent quiet showopts xen-pciback.hide=(00:00.0)(01:00.1) echo 'Loading initial ramdisk ...' module /initrd-3.10.1-3.g0cd5432-xen ...</p> <p>Then reboot the host.</p> <h2 id=3-bind-the-device>3. Bind the device</h2> <h3 id=using-scripts>Using Scripts</h3> <p>File: bind_lib.sh</p> <p>#!/bin/bash # # License: GPLv2 # Author: Peter Maloney # # Script to bind devices to pciback (or pci-stub)</p> <p>find_new_id() { device="<span class=arithmatex id=device>\(1" len=\)</span> if [ "<span class=arithmatex device:5:12=device:5:12>\(len" -eq 12 \]; then device="\)</span>" fi lspci -n | grep "${device}" | cut -d' ' -f3 | sed -r "s/:/ /" }</p> <p>bindstub() { device="$1" echo "binddevice $device"</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span></pre></div></td><td class=code><div><pre><span></span><code>   if \[ ! -e &quot;/sys/bus/pci/devices/$device&quot; \]; then
       echo &quot;    ERROR: Device does not exist... cancelling&quot;
       return
   fi

   # with pci-stub, you do new\_id, then unbind, then bind

   echo &quot;create new\_id&quot;
   chmod +w /sys/bus/pci/drivers/pci-stub/new\_id
   new\_id=&quot;$(find\_new\_id &quot;$device&quot;)&quot;
   echo &quot;    echo \\&quot;$new\_id\\&quot; &gt; /sys/bus/pci/drivers/pci-stub/new\_id&quot;
   echo &quot;$new\_id&quot; &gt; /sys/bus/pci/drivers/pci-stub/new\_id

   echo &quot;unbind&quot;
   if \[ ! -e &quot;/sys/bus/pci/devices/$device/driver&quot; \]; then
       echo &quot;    no driver to unbind&quot;
   else
       chmod +w &quot;/sys/bus/pci/devices/${device}/driver/unbind&quot;
       echo &quot;    echo -n \\&quot;$device\\&quot; &gt; \\&quot;/sys/bus/pci/devices/$device/driver/unbind\\&quot;&quot;
       echo -n &quot;$device&quot; &gt; &quot;/sys/bus/pci/devices/$device/driver/unbind&quot;
   fi

   echo &quot;bind&quot;
   chmod +w /sys/bus/pci/drivers/pci-stub/bind
   echo &quot;    echo -n \\&quot;$device\\&quot; &gt; /sys/bus/pci/drivers/pci-stub/bind&quot;
   echo -n &quot;$device&quot; &gt; /sys/bus/pci/drivers/pci-stub/bind

   echo
</code></pre></div></td></tr></table></div> <p>}</p> <p>bindback() { device="$1" echo "binddevice $device"</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span></pre></div></td><td class=code><div><pre><span></span><code>   if \[ ! -e &quot;/sys/bus/pci/devices/$device&quot; \]; then
       echo &quot;ERROR: Device does not exist... cancelling&quot;
       return
   fi

   # with pciback, you do unbind, then new\_slot, then bind

   echo &quot;unbind&quot;
   if \[ ! -e &quot;/sys/bus/pci/devices/$device/driver&quot; \]; then
       echo &quot;    no driver to unbind&quot;
   else
       chmod +w &quot;/sys/bus/pci/devices/${device}/driver/unbind&quot;
       echo &quot;    echo -n \\&quot;$device\\&quot; &gt; \\&quot;/sys/bus/pci/devices/$device/driver/unbind\\&quot;&quot;
       echo -n &quot;$device&quot; &gt; &quot;/sys/bus/pci/devices/$device/driver/unbind&quot;
   fi

   echo &quot;create new\_slot&quot;
   chmod +w /sys/bus/pci/drivers/pciback/new\_slot
   echo &quot;    echo -n \\&quot;$device\\&quot; &gt; /sys/bus/pci/drivers/pciback/new\_slot&quot;
   echo -n &quot;$device&quot; &gt; /sys/bus/pci/drivers/pciback/new\_slot

   echo &quot;bind&quot;
   chmod +w /sys/bus/pci/drivers/pciback/bind
   echo &quot;    echo -n \\&quot;$device\\&quot; &gt; /sys/bus/pci/drivers/pciback/bind&quot;
   echo -n &quot;$device&quot; &gt; /sys/bus/pci/drivers/pciback/bind

   echo
</code></pre></div></td></tr></table></div> <p>}</p> <h1 id=source-bind_libsh>source bind_lib.sh</h1> <h1 id=modprobe-xen-pciback>modprobe xen-pciback</h1> <h1 id=bindback-000001000>bindback "0000:01:00.0"</h1> <h1 id=bindback-000001001>bindback "0000:01:00.1"</h1> <h3 id=using-xen-tools>Using xen-tools</h3> <h1 id=xl-pci-assignable-add-01000>xl pci-assignable-add 01:00.0</h1> <h1 id=xl-pci-assignable-add-01001>xl pci-assignable-add 01:00.1</h1> <h1 id=xl-pci-attach-domain-0-01000>xl pci-attach Domain-0 01:00.0</h1> <h1 id=xl-pci-attach-domain-0-01001>xl pci-attach Domain-0 01:00.1</h1> <h2 id=4-create-vm>4. Create VM</h2> <p>File: win7</p> <p>name="win77" description="None" uuid="db64c1a6-1f84-4eff-48df-53c4b03b389e" memory=2048 maxmem=2048 vcpus=4 on_poweroff="destroy" on_reboot="destroy" on_crash="destroy" localtime=1</p> <p>builder="hvm" device_model="/usr/lib/xen/bin/qemu-dm" kernel="/usr/lib/xen/boot/hvmloader" boot="dc" disk=[ 'file:/var/lib/xen//blog/images/windowsvistax64/disk0.raw,hda,w','file:/home/lofyer/Driver.iso,hdc:cdrom,r' ]</p> <h1 id=vif-bridgevirbr0-mac00123e6c2f02-modelrtl8139>vif=[ 'bridge=virbr0, mac=00:12:3e:6c:2f:02, model=rtl8139' ]</h1> <p>stdvga=1 vnc=1 vnclisten="0.0.0.0" vncconsole=0</p> <h1 id=vncunused1>vncunused=1</h1> <p>soundhw="all"</p> <p>monitor=1 viridian=1 sdl=0</p> <h1 id=usb1>usb=1</h1> <p>acpi=1 apic=1 pae=1</p> <h1 id=usbdevicetablet>usbdevice='tablet'</h1> <p>serial="pty"</p> <h1 id=add-by-lofyer>Add by lofyer</h1> <p>device_model_version = "qemu-xen-traditional" gfx_passthru=0 pci_power_mgmt=1 xen_platform_pci=1 pci_msitranslate=1 hap=1 pci = [ '01:00.0' , '01:00.1' ]</p> <h1 id=xl-create-win7-remote-viewer-vnclocalhost5900>xl create win7 # remote-viewer vnc://localhost:5900</h1> <p>Then you should see Windows boot logo in vnc for few seconds, after that it will switch to the second monitor that attached to your ATI card.</p> <h3 id=gfx_gpupassthru>gfx_gpupassthru</h3> <p>As Xen wiki said:</p> <blockquote> <p>When you specify "gfx_passthru=1" the passthru graphics card will be made the primary graphics card in the VM, and the Xen Qemu-dm emulated Cirrus graphics card is disabled. If you use "gfx_passthru=0", or don't have gfx_passthru= option at all, then the Xen Qemu-dm emulated Cirrus graphics card will be the primary in the VM, and the passthru graphics card will be secondary.</p> </blockquote> <h2 id=so-alter-gfx_passthru-to-1>So, alter gfx_passthru to 1.</h2> <p>title: "mingw编译remoteviewer" date: 2012-11-17 categories: - "cloud-infra"</p> <hr> <p><strong>UPDATE 2015.3.18 fedora 21中编译： # yum install mingw* libtool* auto-buildrequires intltool glib2-devel icoutils msitools # ./autogen.sh # mingw64-configure # mingw64-make -j4 # rpmbuild -bb mingw-virt-viewer.spec 编译msi过程中，可能会提示缺少storageencryption.rng，从以下地址下载即可。 https://raw.githubusercontent.com/wido/libvirt/master/docs/schemas/storageencryption.rng</strong></p> <p>在fedora环境中，需要的有spice-gtk，libusbx，usbredir，remote-review，全部下载最新git源 spice-gtk，usbredir http://cgit.freedesktop.org/spice libusbx git://github.com/libusbx/libusbx.git remote-viewer git.fedorahosted.org/git/virt-viewer.git</p> <p>libusbx和usbredir：</p> <p>mingw32-configure;mingw32-make;mingw32-make install</p> <p>spice-gtk： mingw32-configure --with-sasl=no --with-audio=gstreamer --enable-smartcard=no --with-gtk=2.0 --without-python 因为virtviewer要gtk2.0的，所以这也就2.0的；mingw32下没找到pygtk，图省事儿就不要python了，其他的缺啥下啥</p> <p>mingw32-make mingw32-make install</p> <p>virt-viewer：</p> <p>mingw32-configure mingw32-make mingw32-make install</p> <p>生成remote viewer.exe</p> <p>安装包 运行nsiswrapper生成windows安装包</p> <p>nsiswrapper --run --name "Virt-Viewer" --outfile "Virt-Viewer-for-Windows.exe" --with-gtk /usr/i686-pc-mingw32/sys-root/mingw/bin/virt-viewer.exe</p> <p>缺少的dll从网上下或者windows环境中安装的virtviewer加到$PATH中 这样会缺少三个xml文件，在virtviewer/src里，直接copy过去</p> <p>export PATH=$PATH:/usr/i686-pc-mingw32/sys-root/mingw/bin:.</p> <p>windows client中使用usbredir： 需要libwdi或者zadig或者usbclerk <a href=http://lists.freedesktop.org/archives/spice-devel/2012-November/011629.html title="usbredir in windows client">链接</a></p> <h2 id=todo-libvirt>todo: 只有libvirt不是最新的了，可是目前来看没影响</h2> <p>title: "NVIDIA GRID vGPU and KVMGT for KVM" date: 2017-10-25 categories: - "cloud-infra"</p> <hr> <p>This article will tell you how to use NVIDIA vGPU and KVMGT in KVM hypervisor with mdev. I'll use NVIDIA M60 and RHEL 7.4 for testing.</p> <h1 id=1-nvidia-vgpu>1. NVIDIA vGPU</h1> <h2 id=11-prepare-drivers-and-utilities>1.1. Prepare drivers and utilities</h2> <h2 id=12-create-vgpu-with-command-line>1.2. Create vGPU with command line</h2> <h2 id=13-passthrough-vgpu-to-vm>1.3. Passthrough vGPU to vm</h2> <h1 id=2-kvmgt>2. KVMGT</h1> <h2 id=21-prepare-drivers-and-utilities>2.1. Prepare drivers and utilities</h2> <h2 id=22-create-vgpu-with-command-line>2.2. Create vGPU with command line</h2> <h2 id=23-passthrough-vgpu-to-vm>2.3. Passthrough vGPU to vm</h2> <h1 id=3-amd-vgpu>3. AMD vGPU</h1> <h2 id=31-prepare-drivers-and-utilities>3.1. Prepare drivers and utilities</h2> <h2 id=32-create-vgpu-with-command-line>3.2. Create vGPU with command line</h2> <h2 id=33-passthrough-vgpu-to-vm>3.3. Passthrough vGPU to vm</h2> <h1 id=ref>Ref:</h1> <h2 id=httpswwwkraxelorgblogtagvgpu><a href=https://www.kraxel.org/blog/tag/vgpu/ >https://www.kraxel.org/blog/tag/vgpu/</a></h2> <p>title: "QEMU 3D" date: 2016-12-29 categories: - "cloud-infra"</p> <hr> <p>Except from virgl(virtio-vga), KVMGT/XenGT, CUDA vGPU, I will introduce you another way of using 3D app in QEMU, c'est la <a href=http://xqemu.com/ >XQEMU</a></p> <p><a href=https://blog.lofyer.org/wp-content/uploads/EmuCR-XQEMU-20170109.7z>Download prebuilt EmuCR-XQEMU-20170109</a></p> <p><a href=https://www.emuparadise.me/roms-isos-games.php>Download games!</a></p> <p>As you can see, this is a emulator forked from QEMU to let you playing XBOX games in PC.(not interested though...)</p> <h2 id=get-xqemu>Get XQEMU</h2> <p>git clone https://github.com/espes/xqemu.git</p> <h2 id=compile-xqemu><a href=https://github.com/espes/xqemu/wiki/Getting-Started#compile-xqemu></a>Compile XQEMU</h2> <h3 id=for-mac-os-x><a href=https://github.com/espes/xqemu/wiki/Getting-Started#for-mac-os-x></a>For Mac OS X</h3> <p>./configure --cc=clang --enable-opengl --disable-vnc --disable-user --target-list=xbox-softmmu --extra-cflags="-march=native" --enable-debug make</p> <h3 id=for-windows><a href=https://github.com/espes/xqemu/wiki/Getting-Started#for-windows></a>For Windows</h3> <ol> <li>Install MSYS2 x86_64: Follow all the steps on <a href=http://msys2.github.io/ >http://msys2.github.io/</a></li> <li> <p>Open the "MinGW-w64 Win64 Shell" and run:</p> <p>pacman -S git python2 make autoconf automake-wrapper mingw-w64-x86_64-libtool mingw-w64-x86_64-gcc mingw-w64-x86_64-pkg-config mingw-w64-x86_64-glib2 mingw-w64-x86_64-glew mingw-w64-x86_64-SDL git clone https://github.com/espes/xqemu cd xqemu git submodule update --init pixman</p> <p>./configure --cc=gcc --python=python2 --enable-opengl --disable-vnc --disable-user --target-list=xbox-softmmu --extra-cflags="-march=native" --enable-debug make</p> </li> </ol> <p><strong>There's a bug with timers on Windows that makes it run much slower than it should. YOU should fix it for me.</strong></p> <h3 id=for-linux><a href=https://github.com/espes/xqemu/wiki/Getting-Started#for-linux></a>For Linux</h3> <h4 id=requirements><a href=https://github.com/espes/xqemu/wiki/Getting-Started#requirements></a>Requirements:</h4> <ul> <li><a href=http://wiki.qemu.org/Hosts/Linux>Everything QEMU requires</a></li> <li>OpenGL with GLX and GLEW</li> </ul> <p>For <strong>Debian</strong> most build dependencies can be installed by running:</p> <p>apt-get build-dep qemu apt-get install libglew-dev libtxc-dxtn-s2tc0</p> <h4 id=building><a href=https://github.com/espes/xqemu/wiki/Getting-Started#building></a>Building:</h4> <p>./configure --python=python2 --enable-opengl --disable-vnc --disable-user --enable-kvm --disable-xen --audio-drv-list=alsa --target-list=xbox-softmmu --extra-cflags="-march=native" --disable-werror --enable-debug make</p> <h2 id=run-xqemu><a href=https://github.com/espes/xqemu/wiki/Getting-Started#run-xqemu></a>Run XQEMU</h2> <p>XQEMU is a Low-Level Emulator, so you need to find a copy of the stuff the Xbox runs when it turns on:</p> <h4 id=xbox-mcp-x-boot-rom><a href=https://github.com/espes/xqemu/wiki/Getting-Started#xbox-mcp-x-boot-rom></a>Xbox MCP-X boot rom</h4> <p>MD5 (mcpx_1.0.bin) = d49c52a4102f6df7bcf8d0617ac475ed</p> <p>If your mcpx dump has an MD5 of 196a5f59a13382c185636e691d6c323d you dumped it badly and it's a couple bytes off. It should start with 0x33 0xC0 and end with 0x02 0xEE.</p> <h4 id=xbox-10-compatible-bios-cromwell-3944-4034-4036><a href=https://github.com/espes/xqemu/wiki/Getting-Started#xbox-10-compatible-bios-cromwell-3944-4034-4036-></a>Xbox 1.0 compatible bios (cromwell, 3944, 4034, 4036, ...)</h4> <p>You can use a retail bios <em>or</em> a modified 'debug' bios. Just like a real xbox, running a retail bios will not boot unofficial software.</p> <h5 id=debug-bios><a href=https://github.com/espes/xqemu/wiki/Getting-Started#debug-bios></a>Debug BIOS</h5> <p>People have reported success with the 'COMPLEX 4627' modified debug bios. It's convenient to note that this bios does <em>not</em> necessarily require a <em>populated</em> hard disk image to load an application from DVD (though an empty drive still needs to be attached), so you can skip the next step in some cases.</p> <p>v1.0.2 1M dump: MD5 (Complex_4627Debug.bin) = 19b5c6d3d42a707bba620634fe6d4baf</p> <p><em>or sometimes</em></p> <p>1MB dump: MD5 (complex_4627debug.bin) = e8dd61cc6abdbd06aac185e371312dc1</p> <h5 id=retail-bios><a href=https://github.com/espes/xqemu/wiki/Getting-Started#retail-bios></a>Retail BIOS</h5> <p>1M dump: MD5 (3944.bin) = e8b39b98cf775496c1c76e4f7756e6ed</p> <p><em>or sometimes</em></p> <p>256k dump: MD5 (3944.bin) = 542c62cb976a4993c8c5027dff9638ce</p> <h4 id=xbox-dashboard-files-on-a-hard-disk-image><a href=https://github.com/espes/xqemu/wiki/Getting-Started#xbox-dashboard-files-on-a-hard-disk-image></a>Xbox dashboard files on a hard disk image</h4> <p>Create an Xbox hard-disk image, using xboxhdm or otherwise:</p> <ul> <li>Create an <a href=http://sourceforge.net/projects/xboxhdm2/ >xboxhdm</a> cd-rom with the dashboard files</li> <li>Create a blank hard-disk file: <code>qemu-img create -f qcow2 xbox_harddisk.qcow2 8G</code></li> <li>Run xboxhdm with qemu or something: <code>i386-softmmu/qemu-system-i386 -hda xbox_harddisk.qcow2 -cdrom linux.iso</code></li> </ul> <hr> <p>Launch XQEMU with something like...</p> <p>xbox-softmmu/qemu-system-xbox -cpu pentium3 -machine xbox,bootrom=mcpx_rom.bin -m 64 -drive file=xbox_harddisk.qcow2,index=0,media=disk,locked=on -drive index=1,media=cdrom -bios xbox_bios.bin -usb -device usb-hub,bus=usb-bus.0,port=3 -device usb-xbox-gamepad,bus=usb-bus.0,port=3.2</p> <p>On Linux, you can use <a href=http://www.linux-kvm.org/page/Main_Page>KVM</a> by passing <code>accel=kvm,kernel_irqchip=off</code> to -machine. This is not yet recommended.</p> <p>To skip the Xbox logo animation you can pass <code>short_animation</code> to the -machine option (Example: <code>-machine xbox,short_animation,bootrom=mcpx_rom.bin</code>).</p> <h2 id=to-run-a-game-from-a-xbox-dvd-image-you-must-specify-a-file-for-the-dvd-device>To run a game from a Xbox DVD image you must specify a <code>file</code> for the DVD device</h2> <p>title: "qemu uefi" date: 2015-06-08 categories: - "cloud-infra"</p> <hr> <p>Here's a collection of kinds of bioses.</p> <p><a href=https://www.kraxel.org/repos/jenkins/ >https://www.kraxel.org/repos/jenkins/</a></p> <p>Download <strong>edk2.git-ovmf-x64*.rpm</strong>, and extract it:</p> <p>(root)# rpm2cpi edk2.git-ovmf-x64-0-20150606.b1038.g5d832d6.noarch.rpm|cpio -mvid ./usr/share/doc/edk2.git-ovmf-x64-0 ./usr/share/doc/edk2.git-ovmf-x64-0/License.txt ./usr/share/doc/edk2.git-ovmf-x64-0/README ./usr/share/edk2.git ./usr/share/edk2.git/ovmf-x64 ./usr/share/edk2.git/ovmf-x64/OVMF-pure-efi.fd ./usr/share/edk2.git/ovmf-x64/OVMF-with-csm.fd ./usr/share/edk2.git/ovmf-x64/OVMF_CODE-pure-efi.fd ./usr/share/edk2.git/ovmf-x64/OVMF_CODE-with-csm.fd ./usr/share/edk2.git/ovmf-x64/OVMF_VARS-pure-efi.fd ./usr/share/edk2.git/ovmf-x64/OVMF_VARS-with-csm.fd ./usr/share/edk2.git/ovmf-x64/UefiShell.iso 22227 blocks</p> <p>Run qemu with these fd bios files like this:</p> <p>qemu --boot loader_type=pflash,loader_ro=yes,loader=OVMF_CODE-pure-efi.fd,nvram_template=OVMF_VARS-pure-efi.fd XXX</p> <p>or</p> <h2 id=qemu-bios-ovmf-pure-efifd-xxx>qemu -bios OVMF-pure-efi.fd XXX</h2> <p>title: "Add usbdevice to libvirt by modifying cgroup" date: 2013-10-31 categories: - "cloud-infra" tags: - "Libvirt" - "Device Redirection"</p> <hr> <p>CGROUP means Control group. In my case, usb-redir works fine while usb-host not. <a href=https://www.kernel.org/doc/Documentation/cgroups/devices.txt title="Cgroup HowTO">https://www.kernel.org/doc/Documentation/cgroups/devices.txt</a></p> <h2 id=just-do-it>Just do it</h2> <h1 id=sed-i-sdevices-devices>sed -i 's/devices /#devices /'</h1> <h1 id=reboot>reboot</h1> <h2 id=add-fine-control-list>Add fine control list</h2> <h3 id=review-the-rules-to-libvirt-and-leave-all-the-character-device-to-it>Review the rules to libvirt, and leave all the character device to it</h3> <h1 id=cgget-libvirt>cgget libvirt</h1> <p>To remove "c" device</p> <h1 id=echo-c-sysfscgrouplibvirtdevicesdeny>echo c &gt; /sys/fs/cgroup/libvirt/devices.deny</h1> <p>To add all the "c" devices</p> <h1 id=echo-c-rwm-sysfscgrouplibvirtdevicesallow>echo "c *:* rwm" &gt; /sys/fs/cgroup/libvirt/devices.allow</h1> <p>devices.deny/allow is something like end-point.</p> <h3 id=about-hierarchy>About hierarchy</h3> <h2 id=a-child-will-not-have-more-permission-than-its-parent><strong>A child will not have more permission than its parent.</strong></h2> <p>title: "Intel iGVT-g vGPU in KVM - KVMGT howto" date: 2015-01-22 categories: - "cloud-infra"</p> <hr> <p>As previous article says, this is a vGPU solution in KVM by Intel.(All these genius)</p> <p><a href=https://01.org/zh/kvm/blogs/albcamus/2014/kvmgt-first-release title=https://01.org/zh/kvm/blogs/albcamus/2014/kvmgt-first-release>https://01.org/zh/kvm/blogs/albcamus/2014/kvmgt-first-release</a></p> <h2 id=cpu-i5-4460-os-ubuntu-1404-desktop>CPU: i5-4460 OS: Ubuntu 14.04 Desktop</h2> <p>title: "KVMGT in Linux 4.10 - 流媒体服务器、游戏、车载大屏等场景的应用技术预研" date: 2017-04-12 categories: - "cloud-infra"</p> <hr> <p>UPDATE: 2018-04，现在KVMGT相关upstream基本已全部进入master，可以参考<a href=http://GVTg_Setup_Guide>GVTg_Setup_Guide</a>或者<a href=https://github.com/intel/gvt-linux/wiki/GVTd_Setup_Guide>GVTd_Setup_Guide</a>，如果需要本地显示参考<a href=https://github.com/intel/gvt-linux/wiki/Dma_Buf_User_Guide>DMA_BUF User Guide</a>。</p> <p>UPDATE: 2017-08-08，Intel有了X系列处理器i9，这个核数肯定适合跑桌面了。</p> <p>UPDATE：鉴于KVMGT的产品化集成难度较之前有所降低，所以最近有很多人都打算搞搞集成，那我先来集成一把吧。</p> <p>果不其然，直接并进内核了（书要改吗。。当然不，本文简单增补即可。。）</p> <p>4.10非常具有的代表性即是添加了Mediated Device(vfio-mdev)，Intel有自家方案，nVidia也要支持，但Linux社区说你俩给个统一框架吧，要不太乱，于是就有了它。如此以来，N家的显卡便可以很快开发出对应的驱动（不要相信他们家销售说的话，14年偶尔问了一下说要支持的，都过去80年啦），可以看看N家去年(2016.9)放的PPT，<a href=https://blog.lofyer.org/wp-content/uploads/02x03-Neo_Jia_and_Kirti_Wankhede-vGPU_on_KVM-A_VFIO_based_Framework.pdf>02x03-Neo_Jia_and_Kirti_Wankhede-vGPU_on_KVM-A_VFIO_based_Framework</a>。</p> <p>相较于之前的文章<a href=https://blog.lofyer.org/intel-igvt-g-vgpu-in-kvm-kvmgt-howto/ >intel-igvt-g-vgpu-in-kvm-kvmgt-howto</a>，这次的并入减少了我们的不少工作。</p> <p>4.10 ChangeLog：<a href=https://kernelnewbies.org/Linux_4.10>https://kernelnewbies.org/Linux_4.10</a></p> <p>参考<a href=https://github.com/01org/gvt-linux/wiki/GVTg_Setup_Guide>https://github.com/01org/gvt-linux/wiki/GVTg_Setup_Guide</a></p> <p>另外，RHEL 7.4也已加入了KVMGT/XenGT，可以试用一下。</p> <p>来看看支持哪些CPU吧：</p> <blockquote> <p>As a long-standing member of the open source community, Intel works upstream to ensure that full, open source implementations of Intel® GVT exist for open source virtualization hypervisors, KVM* and Xen*, known respectively as KVMGT and XenGT. KVMGT and XenGT deliver excellent virtual GPU performance in VMs across 5th and 6th generation Intel® Core™ processors (Intel® Core™ i3, Intel® Core™ i5, and Intel® Core™ i7 processors) with Intel Processor Graphics as well as Intel® Xeon® processors E3 v4 family with Intel Processor Graphics.</p> </blockquote> <p>首先安装并编译4.10的内核：</p> <p>$ git clone https://github.com/01org/gvt-linux $ sudo yum install openssl-devel ncurses-devel $ cd gvt-linux $ git checkout gvt-stable-4.10 $ echo ""|make oldconfig $ make menuconfig</p> <p>搜索关键字kvmgt, mdev,vfio-iommu-type1，并将其标记为“M”。 模块标记完成后，进行编译安装。</p> <p>$ make -j4 $ sudo make modules_install $ sudo make install $ sudo grub2-mkconfig -o /boot/grub2/grub.cfg</p> <p>从elrepo安装的缺少模块和编译环境。</p> <h1 id=rpm-import-httpswwwelrepoorgrpm-gpg-key-elrepoorg>rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</h1> <h1 id=rpm-uvh-httpwwwelrepoorgelrepo-release-70-2el7elreponoarchrpm>rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm</h1> <h1 id=yum-enablerepoelrepo-kernel-install-kernel-ml-kernel-ml-devel>yum --enablerepo=elrepo-kernel install kernel-ml kernel-ml-devel</h1> <p>然后修改grub文件：</p> <p>menuentry 'CentOS Linux (4.10.10) 7 (Core)' --class centos --class gnu-linux --class gnu --class os --unrestricted <span class=arithmatex>\(menuentry\_id\_option 'gnulinux-3.10.0-514.10.2.el7.x86\_64-advanced-6a3987e2-9cb7-4b38-9a53-1642aefada46' { load\_video set gfxpayload=keep insmod gzio insmod part\_msdos insmod ext2 set root='hd0,msdos1' if \[ x\)</span>feature_platform_search_hint = xy ]; then search --no-floppy --fs-uuid --set=root --hint-bios=hd0,msdos1 --hint-efi=hd0,msdos1 --hint-baremetal=ahci0,msdos1 --hint='hd0,msdos1' 3fc34ea6-30d7-491e-931d-d0941884fb6b else search --no-floppy --fs-uuid --set=root 3fc34ea6-30d7-491e-931d-d0941884fb6b fi linux16 /vmlinuz-4.10.10 root=/dev/mapper/cl-root ro rd.lvm.lv=cl/root rd.lvm.lv=cl/swap rhgb quiet LANG=en_US.UTF-8 i915.enable_gvt=1 kvm.ignore_msrs=1 initrd16 /initramfs-4.10.10.img }</p> <p>为什么添加ignore_msrs呢？</p> <blockquote> <p>Since some windows guest 3rd patry application / tools (like GPU-Z / Passmark9.0) will trigger MSR read / write directly, if it access the unhandled msr register, guest will trigger BSOD soon. So we added the "kvm.ignore_msrs=1" into grub for workaround.</p> </blockquote> <p>然后继续编译QEMU，这次只要下载upstream的即可。</p> <p>$ git clone git://git.qemu.org/qemu.git $ cd qemu $ git checkout v2.8.1 $ git submodule update --init roms/seabios $ ./configure --prefix=/usr \ --enable-kvm \ --disable-xen \ --enable-debug-info \ --enable-debug \ --enable-sdl \ --enable-vhost-net \ --enable-spice \ --disable-debug-tcg \ --target-list=x86_64-softmmu $ make -j4 $ cd roms/seabios $ make -j8 $ cd - $ sudo make install $ sudo cp roms/seabios/out/bios.bin /usr/bin/bios.bin</p> <hr> <p>title: "Slic for qemu-kvm" date: 2013-12-25 categories: - "cloud-infra"</p> <hr> <p>This article is a howto for activation-ready of Windows. SLIC 2.0 is for 2003 &amp; XP, and 2.1 for Win7 &amp; 2008 Original seabios reads slic table from exactly the host. However, if your motherboard(not OEM) happen to own none, you will most probably make one by your self.</p> <h3 id=seabios>Seabios</h3> <p>You could get the lastest code from here.</p> <p>git clone git://git.seabios.org/seabios.git seabios</p> <p>Or, you can download from here.</p> <p><a href=http://code.coreboot.org/p/seabios/downloads/get/seabios-1.7.2.2.tar.gz title=seabios-1.7.2.2.tar.gz>seabios-1.7.2.2.tar.gz</a></p> <h3 id=slic-bin>SLIC-BIN</h3> <p>Here's a collection of various slic table. <a href=http://blog.lofyer.org/slic-for-qemu-kvm/slic-2-1-bins/ >SLIC 2.1 BINS</a></p> <h3 id=seaslic-patch>Seaslic patch</h3> <p>This is patch for seabios to make it slic table enabled. Download from here.</p> <p><a href="https://cloud.lofyer.org/public.php?service=files&t=3aa0db051506d88bce8e6d03d621f47e" title=Seaslic.tar.xz>Seaslic.tar.xz, seabios-1.7.2 compatible</a> Here's the patch content.</p> <p>--- a/src/acpi.c 2013-01-19 06:44:54.000000000 +0600 +++ b/src/acpi.c 2013-05-07 01:16:30.000000000 +0600 @@ -214,6 +214,11 @@</p> <p>#include "acpi-dsdt.hex"</p> <p>+#define CONFIG_OEM_SLIC +#ifdef CONFIG_OEM_SLIC +#include "acpi-slic.hex" +#endif + static void build_header(struct acpi_table_header *h, u32 sig, int len, u8 rev) { @@ -226,6 +231,10 @@ h-&gt;oem_revision = cpu_to_le32(1); memcpy(h-&gt;asl_compiler_id, CONFIG_APPNAME4, 4); h-&gt;asl_compiler_revision = cpu_to_le32(1); + #ifdef CONFIG_OEM_SLIC + if (sig == RSDT_SIGNATURE) // only RSDT is checked by win7 &amp; vista + memcpy(h-&gt;oem_id, ((struct acpi_table_header*)SLIC)-&gt;oem_id, 14); + #endif h-&gt;checksum -= checksum(h, len); }</p> <p>@@ -827,6 +836,15 @@ ACPI_INIT_TABLE(build_srat()); if (pci-&gt;device == PCI_DEVICE_ID_INTEL_ICH9_LPC) ACPI_INIT_TABLE(build_mcfg_q35()); + #ifdef CONFIG_OEM_SLIC + void *buf = malloc_high(sizeof(SLIC)); + if (!buf) + warn_noalloc(); + else { + memcpy(buf, SLIC, sizeof(SLIC)); + ACPI_INIT_TABLE(buf); + } + #endif</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code> u16 i, external\_tables = qemu\_cfg\_acpi\_additional\_tables();
</code></pre></div></td></tr></table></div> <h3 id=compile>Compile</h3> <p>You don't have to apply the seaslic patch with patch.sh, you can do that by hand. Before you start, do this:</p> <p>xxd -i /sys/firmware/acpi/tables/SLIC | grep -v len | sed 's/unsigned ch ar.*/static char SLIC[] = {/' &gt; seabios.submodule/src/acpi-slic.hex</p> <p>Or,</p> <p>xxd -i DELL.BIN | grep -v len | sed 's/unsigned ch ar.*/static char SLIC[] = {/' &gt; seabios.submodule/src/acpi-slic.hex</p> <p>After applying the patch, you can compile the bios.bin, and copy that to <strong>/usr/share/qemu-kvm/my-bios.bin</strong> or rewrite <strong>bios.bin</strong> instead. Here's my bios.bin with Dell[DELL-QA09-NVDA]2.1.BIN from SLIC BIN</p> <p><a href=https://raw.githubusercontent.com/lofyer/qemu-cmd-reloaded/master/qemu-slic/my-bin.tar.xz>my-bin.tar.xz</a></p> <h3 id=qemu-cmd>Qemu-cmd</h3> <p>qemu-kvm XXX -bios /usr/share/qemu-kvm/my-bios.bin -acpitable file=Dell[DELL-QA09-NVDA]2.1.BIN</p> <h2 id=in-the-guest-you-could-see-that-slic-by-sysfirmwareacpitablesslic-in-linux-or-slic_toolkit-in-windows>In the guest, you could see that SLIC by /sys/firmware/acpi/tables/SLIC in Linux or SLIC_Toolkit in Windows.</h2> <p>title: "GPU Passthrough, VGA Passthrough in KVM" date: 2013-05-23 categories: - "cloud-infra" - "linux-admin"</p> <hr> <p>To inspire you, I've got a video from someone else. Better mutt the volume by the way. <a href="http://www.youtube.com/watch?v=Qi1LdFkRzIs" title="Arch Linux KVM Crysis HD Gpu Passthrough">Arch Linux KVM Crysis HD Gpu Passthrough</a> Or you can download it to see. <a href=http://blog.lofyer.org/wp-content/uploads/Arch-Linux-KVM-Crysis-HD.flv title="Download the video">Download the video in HD</a> </p> <p>Here's the links I refer to: <a href=http://thread.gmane.org/gmane.comp.emulators.kvm.devel/71981 title=http://thread.gmane.org/gmane.comp.emulators.kvm.devel/71981>http://thread.gmane.org/gmane.comp.emulators.kvm.devel/71981</a> <a href="https://bbs.archlinux.org/viewtopic.php?id=162768" title="https://bbs.archlinux.org/viewtopic.php?id=162768">https://bbs.archlinux.org/viewtopic.php?id=162768</a> <a href="https://docs.google.com/document/d/1ef_nfl652L0HLn_wGvnpgjsBJd9LZzaV_-rIcEEoK8Y/edit?pli=1" title="https://docs.google.com/document/d/1ef_nfl652L0HLn_wGvnpgjsBJd9LZzaV_-rIcEEoK8Y/edit?pli=1">https://docs.google.com/document/d/1ef_nfl652L0HLn_wGvnpgjsBJd9LZzaV_-rIcEEoK8Y/edit?pli=1</a> <a href=http://www.linux-kvm.org/page/VGA_device_assignment title=http://www.linux-kvm.org/page/VGA_device_assignment>http://www.linux-kvm.org/page/VGA_device_assignment</a> <a href=http://www.linux-kvm.org/page/VGA_device_assignment title=http://www.linux-kvm.org/page/VGA_device_assignment>http://www.linux-kvm.org/page/How_to_assign_devices_with_VT-d_in_KVM</a></p> <h2 id=result-vgapassthrough-success-in-host-f19-guest-windows7-gpupassthrough-success-in-fedora-rawhide>Result: VGAPassthrough: success in host F19, guest Windows7 GPUPassthrough: success in Fedora-Rawhide</h2> <p>HOST: CPU: Core i5 3470 GPU: ATI HD Radeon 7850 OS: Fedora-Rawhide QEMU: qemu-1.5.1 <a href=http://blog.lofyer.org/2013/05/pass-host-gpu-to-guest-via-qemu-ncursescurses/kvm-vgapassthrough/ ><img alt=kvm-vgapassthrough src=/blog/images/kvm-vgapassthrough.png></a> So, here's the steps</p> <h2 id=0-enable-the-mainboard-vxt-iommu-and-alter-the-video-device-to-intel-hd>0. Enable the mainboard VxT, iommu and alter the video device to Intel HD</h2> <h2 id=1-see-what-we-have-got-now>1. See what we have got now.</h2> <p>lspci;lspci -n</p> <p>We have output below</p> <p>... 01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Pitcairn PRO [Radeon HD 7850] 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde/Pitcairn HDMI Audio [Radeon HD 7700/7800 Series] ...</p> <p>... 01:00.0 0300: 1002:6819 01:00.1 0403: 1002:aab0 ...</p> <p>You can see the pci bus and vendor.</p> <h2 id=2-modify-the-kernel-parameter-morprobed-and-libvirtconf>2. Modify the kernel parameter, morprobe.d and libvirt.conf</h2> <p>Add follow parameters to grub.conf</p> <p>intel_iommu=on pci-stub.ids=1002:6819,1002:aab0,vfio_iommu_type1.allow_unsafe_interrupts=1</p> <p>NOTE: If you have got an AMD cpu, please replace "interl_iommu=on" with "iommu=pt iommu=1" Add modprobe.conf to /etc/modprobe.d/ with this content:</p> <p>blacklist radeon options kvm ignore_msrs=1 options kvm allow_unsafe_interrupts=1 options kvm-amd npt=0 options kvm_intel emulate_invalid_guest_state=0 options vfio_iommu_type1 allow_unsafe_interrupts=1</p> <p>change the following options in /etc/libvirt/qemu.conf:</p> <h1 id=the-user-id-for-qemu-processes-run-by-the-system-instance>The user ID for QEMU processes run by the system instance.</h1> <p>user = "root"</p> <h1 id=the-group-id-for-qemu-processes-run-by-the-system-instance>The group ID for QEMU processes run by the system instance.</h1> <p>group = "root"</p> <p>......</p> <h1 id=if-clear_emulator_capabilities-is-enabled-libvirt-will-drop-all>If clear_emulator_capabilities is enabled, libvirt will drop all</h1> <h1 id=privileged-capabilities-of-the-qemukvm-emulator-this-is-enabled-by>privileged capabilities of the QEmu/KVM emulator. This is enabled by</h1> <h1 id=default>default.</h1> <h1 id=_1></h1> <h1 id=warning-disabling-this-option-means-that-a-compromised-guest-can>Warning: Disabling this option means that a compromised guest can</h1> <h1 id=exploit-the-privileges-and-possibly-do-damage-to-the-host>exploit the privileges and possibly do damage to the host.</h1> <h1 id=_2></h1> <p>clear_emulator_capabilities = 0</p> <p>Reboot.</p> <h2 id=3-using-scripts-below>3. Using scripts below</h2> <h3 id=version-1-vfio-passthrough>Version 1: VFIO-Passthrough</h3> <p>File: vfio-bind</p> <h1 id=binbash>!/bin/bash</h1> <p>modprobe vfio-pci for var in "<span class=arithmatex>\(@"; do for dev in <span class=arithmatex>\((ls /sys/bus/pci/devices/\)</span>var/iommu\_group/devices); do vendor=\)</span>(cat /sys/bus/pci/devices/<span class=arithmatex>\(dev/vendor) device=\)</span>(cat /sys/bus/pci/devices/<span class=arithmatex>\(dev/device) if \[ -e /sys/bus/pci/devices/\)</span>dev/driver ]; then echo <span class=arithmatex>\(dev &gt; /sys/bus/pci/devices/\)</span>dev/driver/unbind fi echo $vendor $device &gt; /sys/bus/pci/drivers/vfio-pci/new_id done done</p> <p>Bind the device</p> <p>./vfio-bind 0000:01:00.0 0000:01:00.1</p> <p>Start VM</p> <h1 id=binbash_1>!/bin/bash</h1> <p>sudo modprobe vfio-pci</p> <p>sudo qemu-system-x86_64 -no-user-config -nodefaults -m 2048M -smp 4 -boot menu=on \ -net nic -net user -enable-kvm -monitor stdio -vga qxl -global qxl-vga.vram_size=67108864 \ -spice port=6000,ipv4,disable-ticketing \ -device intel-hda,id=sound0,bus=pcie.0,addr=0x4 -device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0 \ -drive file=Windows7.iso,if=none,id=drive-ide0-1-0,readonly=on,format=raw -device ide-cd,bus=ide.1,unit=0,drive=drive-ide0-1-0,id=ide0-1-0 \ -drive file=/home/lofyer/gpu_passthrough/f17.qcow2,if=none,id=drive-virtio-disk0,format=qcow2,cache=none,werror=stop,rerror=stop,aio=threads -device virtio-blk-pci,scsi=off,bus=pcie.0,addr=0x7,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 \ -device virtio-balloon-pci,id=balloon0,bus=pcie.0,addr=0x8 \ -M q35 \ -device piix4-ide,bus=pcie.0 \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 \ -fda virtio.vfd</p> <h3 id=version-2-pci-passthrough>Version 2: PCI-Passthrough</h3> <p>Bind device</p> <h1 id=binbash_2>!/bin/bash</h1> <p>modprobe pci-stub for id in 6819 aab0; do echo 1002 $id &gt; /sys/bus/pci/drivers/pci-stub/new_id done for pci in 0000:01:00.{0,1}; do echo <span class=arithmatex>\(pci &gt; "/sys/bus/pci/devices/\)</span>pci/driver/unbind" echo $pci &gt; /sys/bus/pci/drivers/pci-stub/bind done</p> <p>Start VM</p> <h1 id=binbash_3>!/bin/bash</h1> <p>qemu-system-x86_64 \ -hda ../f17.qcow2 \ -cdrom /run/media/lofyer/Cache/OS_ISO/cn_windows_7_ultimate_with_sp1_x64_dvd_u_677408.iso \ -m 2048 -balloon virtio -smp 4 -enable-kvm \ -device pci-assign,host=01:00.0</p> <hr> <p>title: "kvm perfermance test, including periphery virtual device" date: 2013-09-14 categories: - "cloud-infra" - "linux-admin"</p> <hr> <p>I mean <em><strong>test</strong></em>, not <em><strong>profiling</strong></em>.</p> <h2 id=to-virtual-server-and-virtual-desktop-we-should-inspect-them-from-different-standards>To virtual server and virtual desktop, we should inspect them from different standards.</h2> <p>For an server: response time, throughput, concurrent, utilization For and desktop: response time, video/audio latency, utilization</p> <h2 id=tools-we-can-use-to-test>Tools we can use to test</h2> <h3 id=cpu>CPU:</h3> <p>SPEC(open, but not free) Unixbench Super PI Compile linux kernel pcmark(not open, not free, but cracked can be found..) ffmpeg convert</p> <h3 id=graphic>graphic:</h3> <p>3dmark</p> <h3 id=fshd>fs,hd:</h3> <p>hdparm iozone blogbench dbench</p> <h3 id=net>net:</h3> <p>iperf</p> <h3 id=ram>ram</h3> <p>ramspeed</p> <h2 id=how-to-start>How to start</h2> <p>Initial host env: i5-3470, 8G, gentoo-linux-3.11+, qemu-1.6.0 Kernel para:</p> <p>TBD</p> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2008 - 2022 lofyer </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../../../..", "features": ["search.suggest", "search.highlight", "navigation.tabs", "navigation.tabs.sticky", "navigation.tracking", "navigation.prune"], "search": "../../../../../assets/javascripts/workers/search.07f07601.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script> <script src=../../../../../assets/javascripts/bundle.56dfad97.min.js></script> <script src=../../../../../javascripts/config.js></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> </body> </html>