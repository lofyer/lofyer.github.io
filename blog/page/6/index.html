<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content=lofyer><link href=https://docs.lofyer.org/blog/page/6/ rel=canonical><link href=../../../inthecloud/frontline-storage/ rel=prev><link href=../../category/lab/ rel=next><link rel=icon href=../../../images/favicon.ico><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.5.34"><title>首页 - Lofyer's Blog</title><link rel=stylesheet href=../../../assets/stylesheets/main.35f28582.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.06af60db.min.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#_1 class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../.. title="Lofyer's Blog" class="md-header__button md-logo" aria-label="Lofyer's Blog" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Lofyer's Blog </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> 首页 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=查找> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/lofyer/lofyer.github.io title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> lofyer/lofyer.github.io </div> </a> </div> </nav> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Index </a> </li> <li class=md-tabs__item> <a href=../../../wangsheng/ class=md-tabs__link> WangSheng </a> </li> <li class=md-tabs__item> <a href=../../../datanote/ class=md-tabs__link> Archive Docs </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../ class=md-tabs__link> Archive Blog </a> </li> <li class=md-tabs__item> <a href=../../../tags/ class=md-tabs__link> Tags </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="Lofyer's Blog" class="md-nav__button md-logo" aria-label="Lofyer's Blog" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> Lofyer's Blog </label> <div class=md-nav__source> <a href=https://github.com/lofyer/lofyer.github.io title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> lofyer/lofyer.github.io </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> Index </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../wangsheng/ class=md-nav__link> <span class=md-ellipsis> WangSheng </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../datanote/ class=md-nav__link> <span class=md-ellipsis> Archive Docs </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> Archive Blog </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=true> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Archive Blog </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <a href=../../ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> 首页 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../archive/2022/ class=md-nav__link> <span class=md-ellipsis> 归档 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../category/lab/ class=md-nav__link> <span class=md-ellipsis> 分类 </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../tags/ class=md-nav__link> <span class=md-ellipsis> Tags </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <div class=md-content__inner> <header class=md-typeset> <h1 id=_1>首页</h1> </header> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2014-04-21 00:00:00">2014年4月21日</time></li> <li class=md-meta__item> 分类于 <a href=../../category/inthecloud/ class=md-meta__link>inthecloud</a></li> <li class=md-meta__item> 需要 2 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=9-glusterfs><a href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/ class=toclink>9. glusterfs应用示例及技巧</a></h2> <h3 id=_1><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#_1>文件权限</a></h3> <p>glusterfs在创建卷时会更改砖块所有者为root.root，对于某些应用请注意更改砖块目录所有者（比如在_/etc/rc.local_中添加chown，不要更改砖块下隐藏目录.glusterfs）。</p> <h3 id=_2><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#_2>砖块分割</a></h3> <p>前文所述的砖块划分方式在某些场景下不是很好，可以在/brickX下创建目录，比如data1，同时在创建glusterfs卷的时候使用HOST:/brickX/data1作为砖块，以合理利用存储空间。</p> <h3 id=normalreplicastriped><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#normalreplicastriped>normal、replica、striped卷组合</a></h3> <p>砖块的划分排序：striped（normal）优先，replica在striped（normal）基础上做冗余；计算大小时，同一replica组中的brick进行合并（多个算作一个），一个striped组可看做一个有效块，。 假设我们有4个主机，8个砖块，每个砖块都是5GB，如下图，</p> <p><a href=http://blog.lofyer.org/5-4-gluster-trick/brick-base/ ><img alt=brick-base src=/blog/images/brick-base.png></a></p> <p>创建卷时，使用如下命令：</p> <h2 id=gluster-volume-create-gluster-vol1-stripe-2-replica-2-host1brick1-host1brick2-host2brick1-host2brick2-host3brick1-host3brick2-host4brick1-host4brick2-force><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#gluster-volume-create-gluster-vol1-stripe-2-replica-2-host1brick1-host1brick2-host2brick1-host2brick2-host3brick1-host3brick2-host4brick1-host4brick2-force>gluster volume create gluster-vol1 stripe 2 replica 2 host1:/brick1 host1:/brick2 host2:/brick1 host2:/brick2 host3:/brick1 host3:/brick2 host4:/brick1 host4:/brick2 force</a></h2> <p>则会进行下列组合：</p> <p><a href=http://blog.lofyer.org/5-4-gluster-trick/brick-1/ ><img alt=brick-1 src=/blog/images/brick-1.png></a></p> <p>创建卷时，使用如下命令：</p> <h2 id=gluster-volume-create-gluster-vol1-stripe-2-replica-2-host1brick1-host2brick1-host3brick1-host4brick1-host1brick2-host2brick2-host3brick2-host4brick2-force><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#gluster-volume-create-gluster-vol1-stripe-2-replica-2-host1brick1-host2brick1-host3brick1-host4brick1-host1brick2-host2brick2-host3brick2-host4brick2-force>gluster volume create gluster-vol1 stripe 2 replica 2 host1:/brick1 host2:/brick1 host3:/brick1 host4:/brick1 host1:/brick2 host2:/brick2 host3:/brick2 host4:/brick2 force</a></h2> <p>则会进行下列组合（注意颜色，可改为实虚线）：</p> <p><a href=http://blog.lofyer.org/5-4-gluster-trick/brick-2/ ><img alt=brick-2 src=/blog/images/brick-2.png></a></p> <h3 id=nfs><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#nfs>作为nfs挂载</a></h3> <p><strong>由于glusterfs占用了2049端口，所以其与nfs server一般不能共存于同一台服务器，除非更改nfs服务端口。</strong></p> <p>mount -t nfs -o vers=3 server1:/volume1 /mnt</p> <h3 id=cifs><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#cifs>作为cifs挂载</a></h3> <p>先在某一服务器或者客户端将起挂载，再以cifs方式导出</p> <p>[glustertest] comment = For testing a Gluster volume exported through CIFS path = /mnt/glusterfs read only = no guest ok = yes</p> <h3 id=_3><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#_3>进阶手册</a></h3> <h4 id=1-split-brain><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#1-split-brain>1. 裂脑(split-brain)修复</a></h4> <p>裂脑发生以后，各节点信息可能会出现不一致。可以通过以下步骤查看并修复。</p> <p><strong>定位裂脑文件</strong> 通过命令</p> <h2 id=gluster-volume-heal-info-split-brain><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#gluster-volume-heal-info-split-brain>gluster volume heal info split-brain</a></h2> <p>或者查看在客户端仍然是Input/Output错误的文件。 <strong>关闭已经打开的文件或者虚机</strong> <strong>确定正确副本</strong> <strong>恢复扩展属性</strong></p> <h4 id=2><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#2>2. 砖块重用</a></h4> <p>当一个volume正在使用时，你删除了其中一个brick，会出现“/bricks/app or a prefix of it is already part of a volume”，对于3.3版本以后的glusterfs有此问题。 解决方法：</p> <h2 id=setfattr-x-trustedglusterfsvolume-id-brick_path><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#setfattr-x-trustedglusterfsvolume-id-brick_path>setfattr -x trusted.glusterfs.volume-id $brick_path</a></h2> <h2 id=setfattr-x-trustedgfid-brick_path><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#setfattr-x-trustedgfid-brick_path>setfattr -x trusted.gfid $brick_path</a></h2> <h2 id=rm-rf-brick_pathglusterfs><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#rm-rf-brick_pathglusterfs>rm -rf $brick_path/.glusterfs</a></h2> <h4 id=3><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#3>3. 扩展</a></h4> <p>对于中等以上规模的部署，需要使用dns服务器去解析各个节点以免去修改hosts文件的麻烦。</p> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2014-04-11 00:00:00">2014年4月11日</time></li> <li class=md-meta__item> 分类于 <a href=../../category/inthecloud/ class=md-meta__link>inthecloud</a></li> <li class=md-meta__item> 需要 5 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=8-glusterfs><a href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/ class=toclink>8. 搭建glusterfs作为基础存储</a></h2> <p>既然要搭建一个稳健的基础，那么glusterfs在此使用distributed striped replicated方式，这里使用4台预装CentOS 6(SELINUX设置为permissive)的机器。</p> <p><a href=http://blog.lofyer.org/5-3-glusterfs-howto/distributed_striped_replicated_volume-2/ ><img alt=Distributed_Striped_Replicated_Volume src=/blog/images/Distributed_Striped_Replicated_Volume1.png></a></p> <h3 id=dnshosts><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#dnshosts>添加DNS或者修改hosts文件</a></h3> <p>鉴于笔者所在环境中暂时没有配置独立的DNS，此处先修改hosts文件以完成配置（每台机器上都如此设置）：</p> <h2 id=echo-e-19216810101tgs1examplecomn19216810102tgs2examplecomn19216810103tgs3examplecomn19216810104tgs4examplecom-etchosts><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#echo-e-19216810101tgs1examplecomn19216810102tgs2examplecomn19216810103tgs3examplecomn19216810104tgs4examplecom-etchosts>echo -e "192.168.10.101\tgs1.example.com\n192.168.10.102\tgs2.example.com\n192.168.10.103\tgs3.example.com\n192.168.10.104\tgs4.example.com" &gt;&gt; /etc/hosts</a></h2> <h3 id=repo><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#repo>添加repo</a></h3> <p>[epel] name=Extra Packages for Enterprise Linux 6 - $basearch</p> <h2 id=baseurlhttpdownloadfedoraprojectorgpubepel6basearch><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#baseurlhttpdownloadfedoraprojectorgpubepel6basearch>baseurl=http://download.fedoraproject.org/pub/epel/6/$basearch</a></h2> <p>mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-6&amp;arch=$basearch failovermethod=priority enabled=1 gpgcheck=0 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6</p> <p>[glusterfs-epel] name=GlusterFS is a clustered file-system capable of scaling to several petabytes. baseurl=http://download.gluster.org/pub/gluster/glusterfs/LATEST/EPEL.repo/epel-<span class=arithmatex>\(releasever/\)</span>basearch/ enabled=1 skip_if_unavailable=1 gpgcheck=1 gpgkey=http://download.gluster.org/pub/gluster/glusterfs/LATEST/EPEL.repo/pub.key</p> <p>[glusterfs-noarch-epel] name=GlusterFS is a clustered file-system capable of scaling to several petabytes. baseurl=http://download.gluster.org/pub/gluster/glusterfs/LATEST/EPEL.repo/epel-$releasever/noarch enabled=1 skip_if_unavailable=1 gpgcheck=1 gpgkey=http://download.gluster.org/pub/gluster/glusterfs/LATEST/EPEL.repo/pub.key</p> <p>[glusterfs-source-epel] name=GlusterFS is a clustered file-system capable of scaling to several petabytes. - Source baseurl=http://download.gluster.org/pub/gluster/glusterfs/LATEST/EPEL.repo/epel-$releasever/SRPMS enabled=0 skip_if_unavailable=1 gpgcheck=1 gpgkey=http://download.gluster.org/pub/gluster/glusterfs/LATEST/EPEL.repo/pub.key</p> <h3 id=_1><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#_1>准备磁盘</a></h3> <p>每一个节点都可以看做gluster server，安装xfs用户空间工具：</p> <h2 id=yum-install-y-glusterfs-glusterfs-fuse-glusterfs-server-xfsprogs><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#yum-install-y-glusterfs-glusterfs-fuse-glusterfs-server-xfsprogs>yum install -y glusterfs glusterfs-fuse glusterfs-server xfsprogs</a></h2> <h2 id=etcinitdglusterd-start><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#etcinitdglusterd-start>/etc/init.d/glusterd start</a></h2> <h2 id=etcinitdglusterfsd-start><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#etcinitdglusterfsd-start>/etc/init.d/glusterfsd start</a></h2> <h2 id=chkconfig-glusterfsd-on><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#chkconfig-glusterfsd-on>chkconfig glusterfsd on</a></h2> <h2 id=chkconfig-glusterd-on><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#chkconfig-glusterd-on>chkconfig glusterd on</a></h2> <p>假如每台机器除系统盘之外都有2块1T SATA硬盘。 对其进行分区，创建逻辑卷，格式化并挂载：</p> <h2 id=fdisk-devsdx-eof><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#fdisk-devsdx-eof>fdisk /dev/sdX &lt;&lt; EOF</a></h2> <p>n p 1</p> <p>w EOF</p> <p>直接使用物理盘：</p> <h2 id=mkfsxfs-i-size-512-devsdb1><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#mkfsxfs-i-size-512-devsdb1>mkfs.xfs -i size 512 /dev/sdb1</a></h2> <h2 id=mkfsxfs-i-size-512-devsdc1><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#mkfsxfs-i-size-512-devsdc1>mkfs.xfs -i size 512 /dev/sdc1</a></h2> <h2 id=mkdir-gluster_brick0><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#mkdir-gluster_brick0>mkdir /gluster_brick0</a></h2> <h2 id=mkdir-gluster_brick1><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#mkdir-gluster_brick1>mkdir /gluster_brick1</a></h2> <h2 id=echo-e-devsdb1tgluster_brick0txfstdefaultst0-0ndevsdc1tgluster_brick1txfstdefaultst0-0-etcfstab><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#echo-e-devsdb1tgluster_brick0txfstdefaultst0-0ndevsdc1tgluster_brick1txfstdefaultst0-0-etcfstab>echo -e "/dev/sdb1\t/gluster_brick0\txfs\tdefaults\t0 0\n/dev/sdc1\t/gluster_brick1\txfs\tdefaults\t0 0" &gt;&gt; /etc/fstab</a></h2> <h2 id=mount-a><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#mount-a>mount -a</a></h2> <p>或者使用逻辑卷：</p> <h2 id=pvcreate-devsdb1-devsdc1><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#pvcreate-devsdb1-devsdc1>pvcreate /dev/sdb1 /dev/sdc1</a></h2> <h2 id=vgcreate-vg_gluster-devsdb1-devsdc1><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#vgcreate-vg_gluster-devsdb1-devsdc1>vgcreate vg_gluster /dev/sdb1 /dev/sdc1</a></h2> <h2 id=lvcreate-name-lv_gluster-size-2500g-vg_gluster><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#lvcreate-name-lv_gluster-size-2500g-vg_gluster>lvcreate --name lv_gluster --size 2500G vg_gluster</a></h2> <h2 id=mkfsxfs-i-size-512-devvg_gluster-lv_gluster><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#mkfsxfs-i-size-512-devvg_gluster-lv_gluster>mkfs.xfs -i size 512 /dev/vg_gluster-lv_gluster</a></h2> <h2 id=mkdir-gluster_brick><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#mkdir-gluster_brick>mkdir /gluster_brick</a></h2> <h2 id=echo-e-devmappervg_gluster-lv_glustertgluster_bricktxfstdefaultst0-0-etcfstab><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#echo-e-devmappervg_gluster-lv_glustertgluster_bricktxfstdefaultst0-0-etcfstab>echo -e "/dev/mapper/vg_gluster-lv_gluster\t/gluster_brick\txfs\tdefaults\t0 0" &gt;&gt; /etc/fstab</a></h2> <h2 id=mount-a_1><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#mount-a_1>mount -a</a></h2> <p><em>为什么要用XFS？</em> XFS具有元数据日志功能，可以快速恢复数据；同时，可以在线扩容及碎片整理。其他文件系统比如EXT3，EXT4未做充分测试。</p> <h3 id=volume><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#volume>配置节点，添加volume</a></h3> <p>在其中任何一台机器上，比如gs2.example.com，执行：</p> <h2 id=gluster><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#gluster>gluster</a></h2> <blockquote> <p>peer probe gs1.example.com peer probe gs2.example.com</p> </blockquote> <p>添加brick至volume，<strong>合理调整砖块顺序</strong>：</p> <h2 id=gluster_1><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#gluster_1>gluster</a></h2> <blockquote> <p>volume create gluster-vol1 stripe 2 replica 2 gs1.example.com:/gluster_brick0 gs1.example.com:/gluster_brick1 gs2.example.com:/gluster_brick0 gs2.example.com:/gluster_brick1 gs3.example.com:/gluster_brick0 gs3.example.com:/gluster_brick1 gs4.example.com:/gluster_brick0 gs4.example.com:/gluster_brick1 force volume start gluster-vol1 volume status Status of volume: gluster-vol1 Gluster process Port Online Pid</p> </blockquote> <hr> <p>Brick gs1.example.com:/gluster_brick0 49152 Y 1984 Brick gs1.example.com:/gluster_brick1 49153 Y 1995 Brick gs2.example.com:/gluster_brick0 49152 Y 1972 Brick gs2.example.com:/gluster_brick1 49153 Y 1983 Brick gs3.example.com:/gluster_brick0 49152 Y 1961 Brick gs3.example.com:/gluster_brick1 49153 Y 1972 Brick gs4.example.com:/gluster_brick0 49152 Y 1975 Brick gs4.example.com:/gluster_brick1 49153 Y 1986 NFS Server on localhost 2049 Y 1999 Self-heal Daemon on localhost N/A Y 2006 NFS Server on gs2.example.com 2049 Y 2007 Self-heal Daemon on gs2.example.com N/A Y 2014 NFS Server on gs2.example.com 2049 Y 1995 Self-heal Daemon on gs2.example.com N/A Y 2002 NFS Server on gs3.example.com 2049 Y 1986 Self-heal Daemon on gs3.example.com N/A Y 1993</p> <h3 id=task-status-of-volume-gluster-vol1><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#task-status-of-volume-gluster-vol1>Task Status of Volume gluster-vol1</a></h3> <p>There are no active volume tasks</p> <blockquote> <p>volume info all gluster volume info all</p> </blockquote> <p>Volume Name: gluster-vol1 Type: Distributed-Striped-Replicate Volume ID: bc8e102c-2b35-4748-ab71-7cf96ce083f3 Status: Started Number of Bricks: 2 x 2 x 2 = 8 Transport-type: tcp Bricks: Brick1: gs1.example.com:/gluster_brick0 Brick2: gs1.example.com:/gluster_brick1 Brick3: gs2.example.com:/gluster_brick0 Brick4: gs2.example.com:/gluster_brick1 Brick5: gs3.example.com:/gluster_brick0 Brick6: gs3.example.com:/gluster_brick1 Brick7: gs4.example.com:/gluster_brick0 Brick8: gs4.example.com:/gluster_brick1</p> <h3 id=glusterfs><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#glusterfs>客户端挂载glusterfs</a></h3> <p>当用glusterfs-fuse挂载时，客户端的hosts文件里需要有gluster server中的任一节点做解析：</p> <p>127.0.0.1 localhost.localdomain localhost ::1 localhost6.localdomain6 localhost6</p> <p>192.168.1.81 gs1.example.com</p> <p>安装glusterfuse，将gluster卷作为glusterfs挂载，并写入1M文件查看其在各砖块分配：</p> <h2 id=yum-install-glusterfs-glusterfs-fuse><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#yum-install-glusterfs-glusterfs-fuse>yum install glusterfs glusterfs-fuse</a></h2> <h2 id=mountglusterfs-192168181gluster-vol1-mnt><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#mountglusterfs-192168181gluster-vol1-mnt>mount.glusterfs 192.168.1.81:/gluster-vol1 /mnt</a></h2> <h2 id=cd-mnt><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#cd-mnt>cd /mnt</a></h2> <h2 id=dd-ifdevzero-ofaimg-bs1k-count1k><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#dd-ifdevzero-ofaimg-bs1k-count1k>dd if=/dev/zero of=a.img bs=1k count=1k</a></h2> <h2 id=cp-aimg-bimg-cp-aimg-cimg-cp-aimg-dimg><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#cp-aimg-bimg-cp-aimg-cimg-cp-aimg-dimg>cp a.img b.img; cp a.img c.img; cp a.img d.img</a></h2> <p>在四台服务端分别查看：</p> <p>[root@gs1 ~]# ls -lh /gluster_brick* /gluster_brick0: total 1.0M -rw-r--r--. 2 root root 512K Apr 22 17:13 a.img -rw-r--r--. 2 root root 512K Apr 22 17:13 d.img /gluster_brick1: total 1.0M -rw-r--r--. 2 root root 512K Apr 22 17:13 a.img -rw-r--r--. 2 root root 512K Apr 22 17:13 d.img</p> <p>[root@gs2 ~]# ls -lh /gluster_brick* /gluster_brick0: total 1.0M -rw-r--r--. 2 root root 512K Apr 22 17:13 a.img -rw-r--r--. 2 root root 512K Apr 22 17:13 d.img /gluster_brick1: total 1.0M -rw-r--r--. 2 root root 512K Apr 22 17:13 a.img -rw-r--r--. 2 root root 512K Apr 22 17:13 d.img</p> <p>[root@gs3 ~]# ls -lh /gluster_brick* /gluster_brick0: total 1.0M -rw-r--r--. 2 root root 512K Apr 22 17:13 b.img -rw-r--r--. 2 root root 512K Apr 22 17:13 c.img /gluster_brick1: total 1.0M -rw-r--r--. 2 root root 512K Apr 22 17:13 b.img -rw-r--r--. 2 root root 512K Apr 22 17:13 c.img</p> <p>[root@gs4 ~]# ls -lh /gluster_brick* /gluster_brick0: total 1.0M -rw-r--r--. 2 root root 512K Apr 22 17:13 b.img -rw-r--r--. 2 root root 512K Apr 22 17:13 c.img /gluster_brick1: total 1.0M -rw-r--r--. 2 root root 512K Apr 22 17:13 b.img -rw-r--r--. 2 root root 512K Apr 22 17:13 c.img</p> <p>至此，所有配置结束，下一篇说一下使用以及部分trick。</p> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2014-04-03 00:00:00">2014年4月3日</time></li> <li class=md-meta__item> 分类于 <a href=../../category/inthecloud/ class=md-meta__link>inthecloud</a></li> <li class=md-meta__item> 需要 1 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=6-fuse><a href=../../2014/04/03/6--fuse/ class=toclink>6. FUSE</a></h2> <p>既然是文件系统，那就不得不了解一下FUSE。</p> <p>FUSE全名Filesystem in Userspace，是在类UNIX系统下的一个机制，可以让普通用户创建修改访问文件系统。功能大体就是连接内核接口与用户控件程序的一座“桥”，目前普遍存在于多个操作系统中，比如Linux、BSD、Solaris、OSX、Android等。</p> <p><a href=http://blog.lofyer.org/5-1-1-fuse/490px-fuse_structure-svg/ ><img alt=490px-FUSE_structure.svg src=/blog/images/490px-FUSE_structure.svg_.png></a> <strong>图5-1</strong></p> <p>FUSE来源于AVFS，不同于传统文件系统从磁盘读写数据，FUSE在文件系统或磁盘中有“转换”的角色，本身并不会存储数据。</p> <p>在Linux系统中的实现有很多，比如即将要用到的glusterfs-fuse。</p> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2014-04-03 00:00:00">2014年4月3日</time></li> <li class=md-meta__item> 分类于 <a href=../../category/inthecloud/ class=md-meta__link>inthecloud</a></li> <li class=md-meta__item> 需要 2 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=7-gluster><a href=../../2014/04/03/7-gluster%E7%AE%80%E8%BF%B0/ class=toclink>7. Gluster简述</a></h2> <p>这一节会简述下glusterfs功能和特性。</p> <p>glusterfs设计符合奥卡姆剃刀原则，即“若无必要，勿增实体”。</p> <p><a href=http://blog.lofyer.org/5-2-cloud-gluster-src/cloud-5-2-1/ ><img alt=cloud-5.2-1 src=/blog/images/cloud-5.2-1.png></a></p> <h3 id=_1><a class=toclink href=../../2014/04/03/7-gluster%E7%AE%80%E8%BF%B0/#_1>功能特性</a></h3> <p>gluster集群组成的存储可以通过NFS、CIFS、Glusterfs、HTTP、FTP协议交给用户使用；</p> <p><a href=http://blog.lofyer.org/5-2-cloud-gluster-des/glusterfs_architecture/ ><img alt=GlusterFS_Architecture src=/blog/images/GlusterFS_Architecture.png></a></p> <p>gluster支持四种存储逻辑组合：Striped、Replicated、Striped-Replicated、Distributed；</p> <p><a href=http://blog.lofyer.org/5-2-cloud-gluster-des/distributed_volume/ ><img alt=Distributed_Volume src=/blog/images/Distributed_Volume.png></a></p> <p><a href=http://blog.lofyer.org/5-2-cloud-gluster-des/distributed_striped_volume/ ><img alt=Distributed_Striped_Volume src=/blog/images/Distributed_Striped_Volume.png></a></p> <p><a href=http://blog.lofyer.org/5-2-cloud-gluster-des/distributed_replicated_volume/ ><img alt=Distributed_Replicated_Volume src=/blog/images/Distributed_Replicated_Volume.png></a></p> <p><a href=http://blog.lofyer.org/5-2-cloud-gluster-des/distributed_striped_replicated_volume/ ><img alt=Distributed_Striped_Replicated_Volume src=/blog/images/Distributed_Striped_Replicated_Volume.png></a></p> <p>支持跨网备份（geo-replication）；</p> <p><a href=http://blog.lofyer.org/5-2-cloud-gluster-des/geo-rep_lan/ ><img alt=Geo-Rep_LAN src=/blog/images/Geo-Rep_LAN.png></a></p> <p><a href=http://blog.lofyer.org/5-2-cloud-gluster-des/geo-rep_wan/ ><img alt=Geo-Rep_WAN src=/blog/images/Geo-Rep_WAN.png></a></p> <p><a href=http://blog.lofyer.org/5-2-cloud-gluster-des/geo-rep03_internet/ ><img alt=Geo-Rep03_Internet src=/blog/images/Geo-Rep03_Internet.png></a></p> <p><a href=http://blog.lofyer.org/5-2-cloud-gluster-des/geo-rep04_cascading/ ><img alt=Geo-Rep04_Cascading src=/blog/images/Geo-Rep04_Cascading.png></a></p> <p>统一对象视图，与UNIX设计哲学类似，所有皆对象；</p> <p>跨平台兼容性高，可作为hadoop、openstack、ovirt、Amazon EC的后端；</p> <h3 id=_2><a class=toclink href=../../2014/04/03/7-gluster%E7%AE%80%E8%BF%B0/#_2>名词解释</a></h3> <p>砖块（brick）：即服务器节点上导出的一个目录，作为glusterfs的最基本单元；</p> <p>扩展属性（xattr）：用户/程序以之将数据和元数据关联起来；</p> <p>GFID：glusterfs中的每一个文件或者目录都有一个独立的128位GFID，与普通文件系统中的inode类似；</p> <p>glusterd：运行于所有服务器中的管理守护程序；</p> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2014-04-01 00:00:00">2014年4月1日</time></li> <li class=md-meta__item> 分类于 <a href=../../category/inthecloud/ class=md-meta__link>inthecloud</a></li> <li class=md-meta__item> 需要 1 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=5><a href=../../2014/04/01/5-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8%E7%9A%84%E6%95%85%E4%BA%8B/ class=toclink>5. 分布式存储的故事</a></h2> <p>计算机领域中有诸多有意思的东西可以把玩，在这儿且看看分布式存储。</p> <p><strong>集群文件系统</strong>在某些场景下又可以称作网络文件系统、并行文件系统，在70年代由IBM提出并实现原型。</p> <p>有几种方法可以实现集群形式，但多数仅仅是节点直连存储而不是将存储之上的文件系统进行合理“分布”。分布式文件系统同时挂载于多个服务器上，并在它们之间共享，可以提供类似于位置无关的数据定位或冗余等特点。并行文件系统是一种集群式的文件系统，它将数据分布于多个节点，其主要目的是提供冗余和提高读写性能。</p> <p><strong>共享磁盘（Shared-disk）/Storage-area network(SAN)</strong></p> <p>从应用程序使用的文件级别，到SAN之间的块级别的操作，诸如权限控制和传输，都是发生在客户端节点上。共享磁盘（Shared-disk）文件系统，在并行控制上做了很多工作，以至于其拥有比较一致连贯的文件系统视图，从而避免了多个客户端试图同时访问同一设备时数据断片或丢失的情况发生。其中有种技术叫做围栏（Fencing），就是在某个或某些节点发生断片时，集群自动将这些节点隔离（关机、断网、自恢复），保证其他节点数据访问的正确性。<strong>元数据（Metadata）</strong>类似目录，可以让所有的机器都能查找使用所有信息，在不同的架构中有不同的保存方式，有的均匀分布于集群，有的存储在中央节点。</p> <p>实现的方式有SCSI，iSCSI，AoE，FC，Infiniband等，比较著名的产品有Redhat GFS、Sun QFS、Vmware VMFS等。</p> <p><strong>分布式文件系统</strong></p> <p>分布式文件系统则不是块级别的共享的形式了，所有加进来的存储（文件系统）都是整个文件系统的一部分，所有数据的传输也是依靠网络来的。</p> <p>它的设计有这么几个原则：</p> <ul> <li><em>访问透明</em>   客户端在其上的文件操作与本地文件系统无异</li> <li>_位置透明  _ 其上的文件不代表其存储位置，只要给了全名就能访问</li> <li><em>并发透明</em>   所有客户端持有的文件系统的状态在任何时候都是一致的，不会出现A修改了F文件，但是B愣了半天才发现。</li> <li>_失败透明  _ 理解为阻塞操作，不成功不回头。</li> <li><em>异构性</em>   文件系统可以在多种硬件以及操作系统下部署使用。</li> <li><em>扩展性</em>        随时添加进新的节点，无视其资格新旧。</li> <li><em>冗余透明</em>   客户端不需要了解文件存在于多个节点上这一事实。</li> <li><em>迁移透明</em>   客户端不需要了解文件根据负载均衡策略迁移的状况。</li> </ul> <p>实现的方式有NFS、CIFS、SMB、NCP等，比较著名的产品有Google GFS、Hadoop HDFS、GlusterFS、Lustre等。</p> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2014-03-28 00:00:00">2014年3月28日</time></li> <li class=md-meta__item> 分类于 <a href=../../category/inthecloud/ class=md-meta__link>inthecloud</a></li> <li class=md-meta__item> 需要 2 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=4-><a href=../../2014/03/28/4-%E5%9C%A8%E4%BA%91%E7%AB%AF--%E7%9B%AE%E5%BD%95--%E8%BF%9B%E5%BA%A6/ class=toclink>4. 在云端--目录--进度</a></h2> <p><strong>UPDATE: 2015-05-30 下半部分不如预期中容易，每个算法都要验证并说出所以然，恕小弟不才。</strong></p> <p><strong>UPDATE: 2015-01-01 上半部分基本完结，下半部分正在添加，<a href=https://inthecloud.readthedocs.org title=InTheCloud>在线阅读</a>。如果要成书的话，需要大量添加截图、行动指导以及概念说明。</strong></p> <p><strong>UPDATE: 2014-06-01 移步<a href=http://github.com/lofyer/InTheCloud title=http://github.com/lofyer/InTheCloud>http://github.com/lofyer/InTheCloud</a></strong></p> <p><strong>UPDATE: 2014-05-30 放入github，以rst格式编写。</strong></p> <p><strong>UPDATE: 2014-05-15 oVirt章节完成以后整理成word文档，内容更加丰富。</strong></p> <p>每一章节都可扩展，避免局部发胖，可以从新调整目录结构，比如再加一级父目录和子目录。 硬件部分在搭建的时候可以穿插进来，并不设专门章节讲解。 角度不要起太高，容易扯淡。 不忘资源整合，要有数据。 兼顾智能家居（家庭云）。</p> <p>第一章 随便说些什么 ...1.1 我所看到的 ...1.2 今天天气怎样 ...1.3 根据需求来架构 第二章 一个可靠的存储后端 ...2.1 谈谈分布式存储 ...2.2 Glusterfs简述 ......功能特性 ...2.3 搭建Glusterfs作为基础存储 ......添加DNS或者修改hosts文件 ......准备磁盘作为砖块 ......添加卷 ......挂载卷 ...2.4 Glusterfs应用示例及技巧 ......文件权限 ......砖块组合 ......normal、replica、striped卷组合 ......作为nfs挂载 ......作为cifs挂载 ......修复裂脑（split-brain） ......砖块复用 ......高可用业务IP 第三章 一个合适的虚拟化平台 ...3.1 虚拟化平台简介 ...3.2 搭建oVirt管理引擎 ......系统准备 ......添加repo ......搭建普通oVirt虚拟化平台 ......搭建管理端高可用oVirt（hosted engine） ...3.3 添加节点以及存储域 ......添加节点（宿主机） ......添加存储域 ...3.4 连接虚拟机 ......Spice-Html5 ......浏览器插件 ......本地客户端 ......spice proxy - gateway - squid代理 ......RDP插件（仅适用于Windows虚机及IE浏览器） ...3.5 oVirt使用进阶 ......engine-config参数配置 ......engine-config参数配置 ......ovirt-shell与API ......主机hooks ......主机策略 ......虚拟机文件系统扩容 ......P2V/V2P ......UI 插件 ......使用SysPrep/Cloud-Init重置虚拟机信息 ......与其他平台集成、与认证服务器集成 ......后端（libvirt/qemu/kernel）优化 第四章 数据抓取与机器学习算法 ...4.1 数据收集 ......简单抓取 ......分布式抓取 ......使用Nutch + Solr ...4.2 爬虫示例 ......58同城 ......知乎 ......新浪微博 ...4.3 numpy 快查 ...4.4 机器学习常用分类算法及Python实现 ......信息分类基础 ......K邻近算法 ......决策树 ......朴素贝叶斯 ......Logistic回归 ......SVM ......AdaBoost ...4.5 无监督学习 ...4.6 数据可视化 ......数据统计 ......地理位置表示 ...4.7 机器学习工具 第五章 Hadoop部署及使用 ...5.1 Hadoop简介 ...5.2 模块部署（单机/集群） ......单节点部署 ......集群部署 ...5.3 本地数据处理 ...5.4 实时数据处理 ...5.5 使用进阶 ......基于Solr和Nutch的搜索引擎 附录一 OpenStack/Docker/Foreman 以及其他很有用的资源 ...OpenStack RDO快速部署 ......RDO快速部署 ......添加镜像 ......从ISO安装新实例 ......与owncloud集成 ......oVirt使用Glance与Neutron服务 ...Docker 使用以及相关集成 ......镜像操作 ......Registry操作 ...Foreman 部署指导 ...常用性能测量及优化工具 ...SDN学习/mininet ...HAProxy ...常用运维工具 ......Ganglia ......zabbix ......nagios ......foreman ......chef ......puppet 附录二 公有云参考 ...虚拟机占用主机资源隔离 ......网络 ......CPU ......磁盘IO ......设备 ...资源用度、计费 附录三 PaaS ...这是什么 ...当前的形势 附录四 文档参考资源以及建议书单 ...Server World ...OVF ...快速安装脚本 ...常用爬虫 ...Django based WebAdmin ...书单 实践 构建先进的家居云 ...系统架构 ...构建元素 ...OS X Server</p> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2014-03-25 00:00:00">2014年3月25日</time></li> <li class=md-meta__item> 分类于 <a href=../../category/inthecloud/ class=md-meta__link>inthecloud</a></li> <li class=md-meta__item> 需要 1 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=2><a href=../../2014/03/25/2-%E7%95%85%E6%83%B3%E5%90%A7/ class=toclink>2. 畅想吧</a></h2> <p>单纯人与人的连接关系渐渐已经不能够描述社会这个复杂体了，工业机器也开始走进人的生活，并开始和人互动。Google在2013年一口气收了8家机器人公司，这让我感到...对的，兴奋。</p> <p>有人说到2020年全球数据总量将达到40ZB，这其中就包含“你幸福吗？”、“你小康了吗？”、“今天中午吃什么？”...你觉得，从数据能判断你的什么？我觉得，该了解的不该了解的，基本都有了。</p> <p>那我们能拿这些数据做什么呢？</p> <p><strong>你现在所能看到的，找到的，听到的，都将会是你进行创造的来源，它们为你服务。</strong></p> <p>我有一只狗，名字叫卡尔， 它能听懂我说话， 帮我发个邮件给阿牛，它会去做。 帮我开台桌面一会儿我要连上去画图，它会去开。 帮我预定曹阳影城的两张门票，它会去订。 帮我找点有意思的新闻，它会整理发送给我。 帮我去给东东和小李送个快递，它也会去送。 帮我买一身衣服，它会买你喜欢的风格。 帮我把找找另外一只拖鞋在哪，它屁颠屁颠的找到了。 ......</p> <p>有很多事情可以帮你甚至代替你去做（原谅我这个robot控）况且，“云”落地总要实体化的。</p> <p><strong>健壮的身体里，同样要有个健康的灵魂。</strong></p> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2014-03-25 00:00:00">2014年3月25日</time></li> <li class=md-meta__item> 分类于 <a href=../../category/inthecloud/ class=md-meta__link>inthecloud</a></li> <li class=md-meta__item> 需要 1 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=3><a href=../../2014/03/25/3-%E8%A6%81%E6%9C%89%E5%85%89/ class=toclink>3. 要有光</a></h2> <p>在这里，是整个系统的不同角度视图。</p> <p>+-------------------------------------+ | +--------------------------------+ | | | +---------------------------+ | | | | | +-----------------------+ | | | | | | | | | | | | | | | appliance | | | | | | | +-----------------------+ | | | | | | vm+map_reduce | | | | | +---------------------------+ | | | | hdfs + hypervisor | | | +--------------------------------+ | <br> | glusterfs | +-------------------------------------+</p> <p>Cluster | +--Board | | | +--Storage | | | +--Dev_Extension_Board | +--Network | +--UPS | | | +--Active/Backup | +--Safety | | | +--TSL | | | +--Supervision</p> <p>整个存储是比较倾向gluster作为后端，当然，hdfs是可以使用gluster作为后端的。hdfs的优势之一是可移植性高，可以用廉价的硬件组建（扩展）对性能要求不苛刻的集群。</p> <p>每一个hypervisor都承载一定数量的计算，当然主要是靠虚拟机内的MapReduce。TBD</p> <p>Appliance的是使本地计算资源以及互联网资源的融合，作为集群的表现点，拥有识别并体现彼此特征的能力。</p> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2014-03-24 00:00:00">2014年3月24日</time></li> <li class=md-meta__item> 分类于 <a href=../../category/inthecloud/ class=md-meta__link>inthecloud</a></li> <li class=md-meta__item> 需要 1 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=1><a href=../../2014/03/24/1-%E4%BC%97%E8%AF%B4%E7%BA%B7%E7%BA%AD/ class=toclink>1. 众说纷纭</a></h2> <p>作为公司的一名小小员工，从客户交流到现场部署、从SDN交换机到Neutron、从QEMU到IAAS，我都有过了解或接触，并将其记录成文，<strong>是总结，亦是探索</strong>。期间难免会有这样或者那样的想法，<strong>而将这些想法实践出来的过程是会让人觉得生活依旧是美好的</strong>。</p> <h3 id=_1><a class=toclink href=../../2014/03/24/1-%E4%BC%97%E8%AF%B4%E7%BA%B7%E7%BA%AD/#_1>状况</a></h3> <p>接下来是以我目前水平能看到的： 和多数行业一样，不管哪个公司，他们技术和关系，在不同客户那里都有不同的权重，这点的南北差异尤为明显； 风（宏观调控）让云去哪，云就去哪； AppEngine或者OpenShift目前更像是资源（公共数据中心）一厢情愿的产物；</p> <h3 id=_2><a class=toclink href=../../2014/03/24/1-%E4%BC%97%E8%AF%B4%E7%BA%B7%E7%BA%AD/#_2>需求</a></h3> <p>以我所遇到的客户来看，部分客户不会明确的说使用“云”，他们的需求在多数情况下可以有这样或者那样的传统方案替代； 明确要求使用“云”的客户，总会要求周边指标（用户接入、终端协议、视频流占用带宽、UPS、存储复用等）以及各种各样的定制。 所以，在需求上的灵活变通，也是有些许重要性的，<strong>不要把技术人员的固执带到客户那</strong>。</p> <h3 id=_3><a class=toclink href=../../2014/03/24/1-%E4%BC%97%E8%AF%B4%E7%BA%B7%E7%BA%AD/#_3>还有什么</a></h3> <p>TBD</p> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2014-03-21 00:00:00">2014年3月21日</time></li> <li class=md-meta__item> 分类于 <a href=../../category/inthecloud/ class=md-meta__link>inthecloud</a></li> <li class=md-meta__item> 需要 1 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=0><a href=../../2014/03/21/0-%E4%BB%8A%E5%A4%A9%E5%A4%A9%E6%B0%94%E6%80%8E%E4%B9%88%E6%A0%B7/ class=toclink>0. 今天天气怎么样？</a></h2> <p>7:50 手机闹铃响了，随之而来的是你订阅的RSS、Flipboard推送的新闻。随手翻阅下，完后Siri说今天天气挺暖和的，可以穿你最喜欢的高领毛衣，起床。 8:30 高速公路上，地图告诉你前方拥堵，正好这时领导打来电话，你告诉Siri说“接听”。挂了电话以后，红灯亮了，汽车记录下你这次堵车的时间，并默默再次计算预计到时。 9:20 到达公司门口，没有保安，取而代之的是连接公司LDAP服务器的瞳孔识别。 10:00 收到信息，来自楼下快件派发柜，你订购的球鞋到了。 10:30 客户预约的拜访，你告诉Siri说把公司地址导航路线发送给客户张三。 11:10 通过公司IM告诉前台临时允许车牌号为K9031的车辆进来并发送车位信息给客户。 11:20 和客户在临时会客厅谈话，期间你把演说内容通过手势（食指一划）推送到客户邮箱，他们感到很意外（<strong>加分点</strong>）。</p> <p>12:30 午餐时间，Siri还记得你在决心减肥期间，提醒你不要吃最喜欢的红烧肉，末了来一句“两个人被老虎追，谁最危险？Bingo，胖的那个”。 14:30 有客户如约送来了10T的财务数据，你通知技术部小李对这些数据进行方案II处理，百分之30的处理任务交给武汉机房的机器，因为这些从机柜到主板都是你依照节能环保的原则主持设计的。 16:00 Siri告诉你，抱歉，六点钟有局部降雨。 17:00 你把今天的备忘录存进公司派发给你的虚拟桌面，下班。 19:00 老婆大人的晚饭做好了，你也再次连上虚拟桌面把备忘录整理归档。 20:30 跑步结束，它告诉你这几周换季期间，要增加运动量，你说“可以”。 23:00 休息，Siri通过文字悄悄告诉你，明天结婚纪念日，记住。</p> <p><strong>所有已知未知的暗流，让人有了继续折腾下去的欲望。</strong></p> <p>我是一个着重实践的人，是的，比如磁盘不拆开的话我可能就对扇区、磁道、柱面没什么深刻概念（拆了也就有助于理解驱动，见下图）。所以，这一些列文章将尽量从操作或者现象中总结规律。一些原理性的东西会尽量用我觉得容易理解的形式表现出来。</p> <p><a href=http://blog.lofyer.org/cloud-0-how-is-today/img_20140428_100857/ ><img alt=IMG_20140428_100857 src=/blog/images/IMG_20140428_100857.png></a></p> <p>整本“书”的结构将会是这个样子： 介绍下主流“云”的现状，会引用许多现成（尽量）客观的信息片段；<strong>畅想一下</strong>；从中选择部分组成一个完整系统，进行搭建（或模拟）并本地调优（避免过早优化）；避免烂尾，结尾送两首短诗吧。</p> </div> </article> <nav class=md-pagination> <a href=../../ class=md-pagination__link>1</a> <span class=md-pagination__dots>..</span> <a href=../4/ class=md-pagination__link>4</a> <a href=../5/ class=md-pagination__link>5</a> <span class=md-pagination__current>6</span> <a href=../7/ class=md-pagination__link>7</a> <a href=../8/ class=md-pagination__link>8</a> <span class=md-pagination__dots>..</span> <a href=../25/ class=md-pagination__link>25</a> </nav> </div> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2008 - 2024 lofyer </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["search.suggest", "search.highlight", "navigation.tabs", "navigation.tabs.sticky", "navigation.tracking", "navigation.prune", "navigation.instant", "navigation.instant.progess"], "search": "../../../assets/javascripts/workers/search.07f07601.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script> <script src=../../../assets/javascripts/bundle.56dfad97.min.js></script> <script src=../../../javascripts/config.js></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> </body> </html>