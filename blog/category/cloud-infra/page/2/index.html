<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content=lofyer><link href=https://docs.lofyer.org/blog/category/cloud-infra/page/2/ rel=canonical><link href=../../../ai/ rel=prev><link href=../../../collect/ rel=next><link rel=icon href=../../../../../images/favicon.ico><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.5.39"><title>cloud-infra - Lofyer's Blog</title><link rel=stylesheet href=../../../../../assets/stylesheets/main.8c3ca2c6.min.css><link rel=stylesheet href=../../../../../assets/stylesheets/palette.06af60db.min.css><script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#cloud-infra class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../../../.. title="Lofyer's Blog" class="md-header__button md-logo" aria-label="Lofyer's Blog" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Lofyer's Blog </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> cloud-infra </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=查找> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/lofyer/lofyer.github.io title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> lofyer/lofyer.github.io </div> </a> </div> </nav> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../../.. class=md-tabs__link> Index </a> </li> <li class=md-tabs__item> <a href=../../../../../wangsheng/ class=md-tabs__link> WangSheng </a> </li> <li class=md-tabs__item> <a href=../../../../../datanote/ class=md-tabs__link> Archive Docs </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../../../ class=md-tabs__link> Archive Blog </a> </li> <li class=md-tabs__item> <a href=../../../../../tags/ class=md-tabs__link> Tags </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../../.. title="Lofyer's Blog" class="md-nav__button md-logo" aria-label="Lofyer's Blog" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> Lofyer's Blog </label> <div class=md-nav__source> <a href=https://github.com/lofyer/lofyer.github.io title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> lofyer/lofyer.github.io </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../.. class=md-nav__link> <span class=md-ellipsis> Index </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../../wangsheng/ class=md-nav__link> <span class=md-ellipsis> WangSheng </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../../datanote/ class=md-nav__link> <span class=md-ellipsis> Archive Docs </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> Archive Blog </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=true> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Archive Blog </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../ class=md-nav__link> <span class=md-ellipsis> 首页 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../archive/2022/ class=md-nav__link> <span class=md-ellipsis> 归档 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_3 checked> <label class=md-nav__link for=__nav_4_3 id=__nav_4_3_label tabindex=0> <span class=md-ellipsis> 分类 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_3_label aria-expanded=true> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> 分类 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../lab/ class=md-nav__link> <span class=md-ellipsis> Lab </span> </a> </li> <li class=md-nav__item> <a href=../../../abm/ class=md-nav__link> <span class=md-ellipsis> abm </span> </a> </li> <li class=md-nav__item> <a href=../../../ai/ class=md-nav__link> <span class=md-ellipsis> ai </span> </a> </li> <li class=md-nav__item> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <a href=../../ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> cloud-infra </span> </a> </li> <li class=md-nav__item> <a href=../../../collect/ class=md-nav__link> <span class=md-ellipsis> collect </span> </a> </li> <li class=md-nav__item> <a href=../../../devices/ class=md-nav__link> <span class=md-ellipsis> devices </span> </a> </li> <li class=md-nav__item> <a href=../../../diary/ class=md-nav__link> <span class=md-ellipsis> diary </span> </a> </li> <li class=md-nav__item> <a href=../../../draft/ class=md-nav__link> <span class=md-ellipsis> draft </span> </a> </li> <li class=md-nav__item> <a href=../../../filecoin/ class=md-nav__link> <span class=md-ellipsis> filecoin </span> </a> </li> <li class=md-nav__item> <a href=../../../followmyheart/ class=md-nav__link> <span class=md-ellipsis> followmyheart </span> </a> </li> <li class=md-nav__item> <a href=../../../fpga/ class=md-nav__link> <span class=md-ellipsis> fpga </span> </a> </li> <li class=md-nav__item> <a href=../../../hpc/ class=md-nav__link> <span class=md-ellipsis> hpc </span> </a> </li> <li class=md-nav__item> <a href=../../../inthecloud/ class=md-nav__link> <span class=md-ellipsis> inthecloud </span> </a> </li> <li class=md-nav__item> <a href=../../../linux-admin/ class=md-nav__link> <span class=md-ellipsis> linux-admin </span> </a> </li> <li class=md-nav__item> <a href=../../../modeling/ class=md-nav__link> <span class=md-ellipsis> modeling </span> </a> </li> <li class=md-nav__item> <a href=../../../my-books/ class=md-nav__link> <span class=md-ellipsis> my-books </span> </a> </li> <li class=md-nav__item> <a href=../../../mylife/ class=md-nav__link> <span class=md-ellipsis> mylife </span> </a> </li> <li class=md-nav__item> <a href=../../../new-world/ class=md-nav__link> <span class=md-ellipsis> new-world </span> </a> </li> <li class=md-nav__item> <a href=../../../others/ class=md-nav__link> <span class=md-ellipsis> others </span> </a> </li> <li class=md-nav__item> <a href=../../../ovs/ class=md-nav__link> <span class=md-ellipsis> ovs </span> </a> </li> <li class=md-nav__item> <a href=../../../tech/ class=md-nav__link> <span class=md-ellipsis> tech </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../../tags/ class=md-nav__link> <span class=md-ellipsis> Tags </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <div class=md-content__inner> <header class=md-typeset> <h1 id=cloud-infra>cloud-infra</h1> </header> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2017-07-12 00:00:00">2017年7月12日</time></li> <li class=md-meta__item> 分类于 <a href=../../ class=md-meta__link>cloud-infra</a></li> <li class=md-meta__item> 需要 4 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=zstack><a href=../../../../2017/07/12/zstack%E7%AC%94%E8%AE%B0/ class=toclink>ZStack笔记</a></h2> <h3 id=zstackneutron2017-07><a class=toclink href=../../../../2017/07/12/zstack%E7%AC%94%E8%AE%B0/#zstackneutron2017-07>ZStack与Neutron集成的探索(2017-07)</a></h3> <p>这篇文章较之前的ZStack+Neutron更为简单，由于ZStack的vxlan实现没有使用ovs，所以。。我不管了，直接ovs吧。另外，你如果使用了vyos，我没研究，可以等到下一期处理。</p> <p>以下方法仅仅从实现角度出发，理应适用于其他平台，如果是正经的集成，请自己编写模块。</p> <p>环境：单台主机有两个网卡，相同网段（纯粹方便使用而搞，不要学习），ZStack已经安装，其中eno16780032为管理网络，eno33561344为ZStack二层网络接口，三层网络novlan。</p> <h4 id=ovsodl><a class=toclink href=../../../../2017/07/12/zstack%E7%AC%94%E8%AE%B0/#ovsodl>集成OVS/ODL</a></h4> <ol> <li>于计算节点中安装openvswitch。</li> </ol> <p>wget https://repos.fedorapeople.org/repos/openstack/openstack-ocata/rdo-release-ocata-3.noarch.rpm rpm -i rdo-release-ocata-3.noarch.rpm yum --enablerepo=* install -y openvswitch</p> <h2 id=yum-enablerepo-install-y-openvswitch-ovn><a class=toclink href=../../../../2017/07/12/zstack%E7%AC%94%E8%AE%B0/#yum-enablerepo-install-y-openvswitch-ovn>yum --enablerepo=* install -y openvswitch-ovn*</a></h2> <p>systemctl enable openvswitch systemctl start openvswitch</p> <ol> <li>接下来我给你解释一下，要怎么做了。 首先，由于ZStack的flat网络使用了network namespace，通过一对pair将其与linuxbridge相连，ns内的叫inner0，外部的叫outer0；其中ns中会有dnsmasq启动的dhcp服务，我们将ns看作一个带dhcp的功能交换机好了，仅仅提供dhcp能力。</li> </ol> <p>然后，我们要创建一个ovs，为了将虚拟机的网口vnic1.0能够通过ovs进行控制，同时与dhcp交换机接通，我们需要一根线将ovs与linuxbridge接起来，如此一来，看下图（幸苦画的ASCII图没了！）。</p> <p><a href=https://blog.lofyer.org/wp-content/uploads/untitled_page.png><img alt src=/blog/images/untitled_page.png></a></p> <h2 id=ovs><a class=toclink href=../../../../2017/07/12/zstack%E7%AC%94%E8%AE%B0/#ovs>创建ovs</a></h2> <p>ovs-vsctl add-br ovs-br0 ip link set dev ovs-br0 up</p> <h2 id=_1><a class=toclink href=../../../../2017/07/12/zstack%E7%AC%94%E8%AE%B0/#_1>创建接口对</a></h2> <p>ip link add name veth0 type veth peer name veth0p</p> <h2 id=_2><a class=toclink href=../../../../2017/07/12/zstack%E7%AC%94%E8%AE%B0/#_2>开始扎物理网线</a></h2> <p>brctl delif br_eno16780032 eno16780032 ovs-vsctl add-port ovs-br0 br_eno16780032</p> <h2 id=_3><a class=toclink href=../../../../2017/07/12/zstack%E7%AC%94%E8%AE%B0/#_3>扎接口对</a></h2> <p>brctl addif br_eno16780032 veth0 ovs-vsctl add-port ovs-br0 veth0p ip link set dev veth0 up ip link set dev veth0p up</p> <p>最后由于我们的虚拟机接口vnic1.0每次都会创建到linuxbridge上，所以我们要把它拔下来插ovs上从而可以进行流表控制（可以保存为脚本）。</p> <p>brctl delif br_eno16780032 vnic1.0 ovs-vsctl add-port ovs-br0 vnic1.0</p> <blockquote> <p>Q: 为啥要把物理网口eno33561344放到ovs里？ A: 为了保持纯粹 ：）</p> <p>Q: 为啥不把outer0直接放到ovs里？ A: ZStack逻辑每次创建虚拟机都会试图把outer0加到linuxbridge里，如果已经加到其他网桥虚拟机创建会失败。</p> </blockquote> <p>最后，把物理机的OVS实例交给ODL处理吧，不画图了。</p> <p>ovs-vsctl set-manager tcp:opendaylight_ip:6640</p> <h2 id=_4><a class=toclink href=../../../../2017/07/12/zstack%E7%AC%94%E8%AE%B0/#_4>也可以单独设置网桥的控制器，如果不想全被控制的话</a></h2> <p>ovs-vsctl set-controller ovs-br0 tcp:controller_ip:6633</p> <h2 id=odl><a class=toclink href=../../../../2017/07/12/zstack%E7%AC%94%E8%AE%B0/#odl>安装ODL的插件</a></h2> <p>cd ODL_DIR ./bin/bash ./bin/client</p> <h2 id=netvirtdluxnetvirtyang><a class=toclink href=../../../../2017/07/12/zstack%E7%AC%94%E8%AE%B0/#netvirtdluxnetvirtyang>安装netvirt与dlux界面，安装netvirt与yang</a></h2> <p>opendaylight-user@root&gt; feature:install odl-netvirt-openstack odl-dlux-all odl-dlux-yangman odl-mdsal-apidocs odl-netvirt-ui</p> <p><a href=https://blog.lofyer.org/wp-content/uploads/微信截图_20170616131118.png><img alt src=/blog/images/微信截图_20170616131118.png></a></p> <blockquote> <p>物理机关机了或者新建主机了咋办？ 自己写网络配置文件、手撸脚本，方便的话可以进ZStack公司报名学习。</p> </blockquote> <p><strong>集成DPDK</strong></p> <p>为什么要做这件事儿呢？因为Intel说将DPDK与OVS结合会极大提升传输效率，<a href=https://download.01.org/packet-processing/ONPS2.1/Intel_ONP_Release_2.1_Performance_Test_Report_Rev1.0.pdf/ >https://download.01.org/packet-processing/ONPS2.1/Intel_ONP_Release_2.1_Performance_Test_Report_Rev1.0.pdf</a>。</p> <p>OK，那就开始换模块插网线吧，如果对DPDK不熟悉的同学可以去http://dpdk.org扫一眼tutorial。</p> <p><a href=https://blog.lofyer.org/wp-content/uploads/微信图片_20170905154354.jpg><img alt src=/blog/images/微信图片_20170905154354.jpg></a></p> <p>首先修改grub文件，在kernel启动参数中加入如下内容，尺寸自己酌情添加。</p> <p>iommu=pt intel_iommu=on hugepages=16 hugepagesz=2M hugepages=2048 iommu=pt intel_iommu=on isolcpus=0-3</p> <p>将上述内容加入到/etc/default/grub的CMDLINE后，执行“grub2-mkconfig &gt; /boot/grub2/grub.cfg”并重启。</p> <p>然后启用CentOS的Extra源并安装DPDK，这步操作较DPDK刚出来的时候已经良心很多了。。</p> <p>yum install dpdk dpdk-tools driverctl</p> <p>将网卡与vfio_pci绑定，没错，Intel的万兆卡。</p> <p>modprobe vfio_pci</p> <p>driverctl -v list-devices|grep Ether 0000:02:00.0 XXX driverctl set-override 0000:02:00.0 vfio-pci</p> <p>在OVS中配置使用dpdk，这里我们创建另外一个OVS桥。</p> <p>ovs-vsctl add-br ovs-br1</p> <p>ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-init=true</p> <p>ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-socket-mem="1024,0"</p> <p>ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-lcore-mask=0xf</p> <p>ovs-vsctl set Open_vSwitch . other_config:pmd-cpu-mask=0xf</p> <p>systemctl restart openvswitch</p> <p>ovs-vsctl list Open_vSwitch [dpdk, dpdkr, dpdkvhostuser, dpdkvhostuserclient, geneve, gre, internal, ipsec_gre, lisp, patch, stt, system, tap, vxlan]</p> <p>然后，创建ovs-br1并塞俩vhost接口。</p> <p>ovs-vsctl add-br ovs-br1 -- set bridge ovs-br1 datapath_type=netdev ovs-vsctl add-port ovs-br1 vhost-user1 -- set Interface vhost-user1 type=dpdkvhostuser ovs-vsctl add-port ovs-br1 vhost-user2 -- set Interface vhost-user2 type=dpdkvhostuser</p> <p>到这里，工作基本完成，然后修改ZStack计算节点的虚拟机定义，目的是添加以下参数。</p> <p>-chardev socket,id=char1,path=/run/openvswitch/vhost-user1 \ -netdev type=vhost-user,id=mynet1,chardev=char1,vhostforce \ -device virtio-net-pci,mac=00:00:00:00:00:01,netdev=mynet1 \ -object memory-backend-file,id=mem,size=1G,mem-path=/dev/hugepages,share=on -numa node,memdev=mem -mem-prealloc</p> <p>怎么加呢？先virsh shutdown 1，然后virsh edit 1，并找到合适的地方加如下内容（开启平台设置中的NUMA选项）。</p> <p>...</p> <p><interface type=vhostuser> <model type=virtio /> <source mode=server path=/var/run/openvswitch/vhost-user1 type=unix> <link state=up> <bandwidth/> </interface> ...</p> <p>最后virsh start 1。</p> <p>然后同样方法启动第2台虚拟机，在虚拟机里尝试 iperf，对比一下数据，整体来说都会获得些许提升以榨干网卡能力。</p> <p><strong>注意：以上内容仅仅是为了好玩，不要轻易在自己的ZStack生产环境中测试！</strong></p> <p>参考： https://software.intel.com/en-us/articles/set-up-open-vswitch-with-dpdk-on-ubuntu-server https://www.ovirt.org/blog/2017/09/ovs-dpdk/ https://libvirt.org/formatdomain.html</p> <hr> <p>title: "ZStack Glusterfs 超融合方案" date: 2017-07-14 categories: - "cloud-infra" - "draft"</p> <hr> <p>ZStack 2.1版本中已经支持了NFS作为MNHA节点的存储，那么我们可以按照之前glusterfs组件oVirt超融合的方式直接使用，过程如下。</p> <p><strong>实验环境</strong> 服务器3台，双千兆网口，均已安装ZStack专家模式操作系统。</p> <p><strong>部署三节点无条带双副本分布式glusterfs存储</strong> 节点安装ZStack计算节点后，分别在三台上使用如下命令安装glusterfs。</p> <h3 id=zstack-ha-glusterfszstackglusterfsmnhanfsglusterfsipglusterfs><a class=toclink href=../../../../2017/07/12/zstack%E7%AC%94%E8%AE%B0/#zstack-ha-glusterfszstackglusterfsmnhanfsglusterfsipglusterfs><strong>部署ZStack HA管理节点</strong> 将glusterfs的路径分别挂载至/zstack/glusterfs/mnha/，但要注意NFS/glusterfs的IP，因为glusterfs到服务端的连接不同于</a></h3> <p>title: "ZStack OpenStack API wrapper" date: 2017-09-14 categories: - "cloud-infra"</p> <hr> <h3 id=this-is-a-flag><a class=toclink href=../../../../2017/07/12/zstack%E7%AC%94%E8%AE%B0/#this-is-a-flag>This is a flag.</a></h3> <p>title: "在ZStack中集成OpenStack Neutron组件" date: 2017-06-26 categories: - "cloud-infra" - "draft" tags: - "Cloud Computing" - "TBD"</p> <hr> <p>以笔者目前对ZStack源码的掌握，并不能较为产品化地集成Neutron，所以只能用点稍微hack的技巧将其用起来。</p> <p>实验材料：ZStack单机版，OpenStack Neutron with Dashboard and OVS bridge</p> <p>实验目的：通过修改ZStack实例的开机xml(或者新建主机时修改网络为openvswitch bridge)，调用Neutron API，并将实例网络桥接至OVS网桥。</p> <p>实验步骤：</p> <ol> <li> <p>搭建ZStack，略。</p> </li> <li> <p>搭建OpenStack Neutron实例，参考脚本https://...</p> </li> <li> <p>编写hook脚本</p> </li> <li> <p>开机测试</p> </li> <li> <p>通过OpenStack Dashboard查看</p> </li> </ol> <p>实验思考：</p> <p>这就是KVM平台的好处，互操作性杠杠的。另外，Neutron可作为VM Appliance单独提供，加上Cloud-Init就更好了。</p> <p>实验过程：</p> <p><strong>1. 集成oVirt与Neutron</strong></p> <p><strong>2. 集成ZStack与Neutron</strong></p> <p><strong>3. Neutron与其产品的集成</strong></p> <p>参考链接：</p> <p><a href=http://www.ovirt.org/develop/release-management/features/cloud/neutronvirtualappliance/ >http://www.ovirt.org/develop/release-management/features/cloud/neutronvirtualappliance/</a></p> <p>TBD</p> <p><a href=https://blog.lofyer.org/wp-content/uploads/Neutron-appliance-topology.png><img alt src=/blog/images/Neutron-appliance-topology.png></a></p> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2017-06-24 00:00:00">2017年6月24日</time></li> <li class=md-meta__item> 分类于 <a href=../../ class=md-meta__link>cloud-infra</a>, <a href=../../../draft/ class=md-meta__link>draft</a></li> <li class=md-meta__item> 需要 2 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=linuxbridgeovsvxlanvtep><a href=../../../../2017/06/24/%E5%9C%A8linuxbridgeovs%E4%B8%AD%E4%BD%BF%E7%94%A8vxlan%E7%BB%84%E7%BD%91%E4%BB%A5%E5%8F%8A%E5%88%9B%E5%BB%BAvtep/ class=toclink>在LinuxBridge/OVS中使用VxLAN组网以及创建VTEP</a></h2> <p>这是一篇入门文章，帮助初学者理清VxLAN的基本原理与使用，ovs只是工具，新版本内核也可使用ip命令直接创建。</p> <p>本篇内容分为两篇，第一篇是使用简单VxLAN通道网络，第二篇会接入OVS模拟的VTEP设备。</p> <h2 id=vxlan><a class=toclink href=../../../../2017/06/24/%E5%9C%A8linuxbridgeovs%E4%B8%AD%E4%BD%BF%E7%94%A8vxlan%E7%BB%84%E7%BD%91%E4%BB%A5%E5%8F%8A%E5%88%9B%E5%BB%BAvtep/#vxlan>一、使用VxLAN通道</a></h2> <p>原理是在网络命名空间上（仅测试环境），创建对端接口（peer/patch，虚拟化环境中即是虚拟机veth设备接口与OVS tun接口），以通过VxLAN通道与彼此通信。</p> <p>host1拥有物理接口eth0（192.168.0.101），host2拥有物理接口eth0（192.168.0.102），两者在同一局域网中。</p> <p>实验拓扑如下图。</p> <p><a href=https://blog.lofyer.org/wp-content/uploads/1.png><img alt src=/blog/images/1.png></a></p> <p>在host1上创建veth与对端接口，对端接口会与ovs网桥相连，其中veth1代表虚拟机接口（地址为10.0.0.1），veth1p代表与ovs网桥相连的接口。</p> <h2 id=_1><a class=toclink href=../../../../2017/06/24/%E5%9C%A8linuxbridgeovs%E4%B8%AD%E4%BD%BF%E7%94%A8vxlan%E7%BB%84%E7%BD%91%E4%BB%A5%E5%8F%8A%E5%88%9B%E5%BB%BAvtep/#_1>添加网络命名空间</a></h2> <p>ip netns add ns-host1</p> <h2 id=_2><a class=toclink href=../../../../2017/06/24/%E5%9C%A8linuxbridgeovs%E4%B8%AD%E4%BD%BF%E7%94%A8vxlan%E7%BB%84%E7%BD%91%E4%BB%A5%E5%8F%8A%E5%88%9B%E5%BB%BAvtep/#_2>添加对端接口</a></h2> <p>ip link add name veth1 type veth peer name veth1p</p> <h2 id=_3><a class=toclink href=../../../../2017/06/24/%E5%9C%A8linuxbridgeovs%E4%B8%AD%E4%BD%BF%E7%94%A8vxlan%E7%BB%84%E7%BD%91%E4%BB%A5%E5%8F%8A%E5%88%9B%E5%BB%BAvtep/#_3>将虚拟机接口放入命名空间</a></h2> <p>ip link set dev veth1 netns ns-host1</p> <h2 id=ip><a class=toclink href=../../../../2017/06/24/%E5%9C%A8linuxbridgeovs%E4%B8%AD%E4%BD%BF%E7%94%A8vxlan%E7%BB%84%E7%BD%91%E4%BB%A5%E5%8F%8A%E5%88%9B%E5%BB%BAvtep/#ip>设置虚拟机接口IP</a></h2> <p>ip netns exec ns-host1 ifconfig veth1 10.0.0.1/24 up</p> <h2 id=ovs><a class=toclink href=../../../../2017/06/24/%E5%9C%A8linuxbridgeovs%E4%B8%AD%E4%BD%BF%E7%94%A8vxlan%E7%BB%84%E7%BD%91%E4%BB%A5%E5%8F%8A%E5%88%9B%E5%BB%BAvtep/#ovs>添加ovs网桥</a></h2> <p>ovs-vsctl add-br ovs-vxlan</p> <h2 id=_4><a class=toclink href=../../../../2017/06/24/%E5%9C%A8linuxbridgeovs%E4%B8%AD%E4%BD%BF%E7%94%A8vxlan%E7%BB%84%E7%BD%91%E4%BB%A5%E5%8F%8A%E5%88%9B%E5%BB%BAvtep/#_4>将虚拟机的对端接口放入命名空间</a></h2> <p>ovs-vsctl add-port ovs-vxlan veth1p</p> <h2 id=_5><a class=toclink href=../../../../2017/06/24/%E5%9C%A8linuxbridgeovs%E4%B8%AD%E4%BD%BF%E7%94%A8vxlan%E7%BB%84%E7%BD%91%E4%BB%A5%E5%8F%8A%E5%88%9B%E5%BB%BAvtep/#_5>激活接口</a></h2> <p>ip link set ovs-vxlan up ip link set veth1p up</p> <p>同样在host2上创建。</p> <p>ip netns add ns-host2 ip link add name veth1 type veth peer name veth1p ip link set dev veth1 netns ns-host2 ip netns exec ns-host2 ifconfig veth1 10.0.0.2/24 up</p> <p>ovs-vsctl add-br ovs-vxlan ovs-vsctl add-port ovs-vxlan veth1p ip link set ovs-vxlan up ip link set veth1p up</p> <p>然后，分别在host1与host2上创建VxLAN通道。</p> <p>host1，将VxLAN的对端指向host2的eth0，VNI（VXLAN Network Identifier）为123。</p> <p>ovs-vsctl add-port ovs-vxlan vxlan0 -- set interface vxlan0 type=vxlan options:remote_ip=192.168.0.102 options:key=123</p> <p>host2，将VxLAN的对端指向host2的eth0。</p> <p>ovs-vsctl add-port ovs-vxlan vxlan0 -- set interface vxlan0 type=vxlan options:remote_ip=192.168.0.101 options:key=123</p> <p>这样即可完成最简单的OVS VxLAN实验准备，在host2上的虚拟机尝试ping host1上的虚拟机。</p> <p>ip netns exec ns-host2 ping 10.0.0.1 PING 10.0.0.1 (10.0.0.1) 56(84) bytes of data. 64 bytes from 10.0.0.1: icmp_seq=1 ttl=64 time=1.74 ms 64 bytes from 10.0.0.1: icmp_seq=2 ttl=64 time=0.734 ms 64 bytes from 10.0.0.1: icmp_seq=3 ttl=64 time=0.669 ms</p> <p>这里可以将主机上的物理接口，比如eth1加入到ovs-vxlan中，从而使得与其相连的主机或者网络设备能够接入此VxLAN网络； 当添加第三台主机时，使用gre网络需要在每个gre0中设置remote_ip以两两相连，可以是星形或者环形（打开ovs生成树协议，ovs-vsctl set bridge ovs-gre stp_enable=true），而VxLAN网络</p> <h2 id=vxlan_1><a class=toclink href=../../../../2017/06/24/%E5%9C%A8linuxbridgeovs%E4%B8%AD%E4%BD%BF%E7%94%A8vxlan%E7%BB%84%E7%BD%91%E4%BB%A5%E5%8F%8A%E5%88%9B%E5%BB%BAvtep/#vxlan_1>二、使用VxLAN通道连接虚拟机与物理机</a></h2> <h2 id=ovs-vtep><a class=toclink href=../../../../2017/06/24/%E5%9C%A8linuxbridgeovs%E4%B8%AD%E4%BD%BF%E7%94%A8vxlan%E7%BB%84%E7%BD%91%E4%BB%A5%E5%8F%8A%E5%88%9B%E5%BB%BAvtep/#ovs-vtep>三、接入OVS VTEP设备</a></h2> <p>参考： <a href=https://sgros-students.blogspot.com/2013/11/comparison-of-brctl-and-bridge-commands.html>brctl与bridge命令对比</a> <a href=https://github.com/lofyer/scripts/blob/6e9fd04cd6209459745f83dc8b303494992b2544/libvirt/ovs-howto.txt>在oVirt中使用ovs gre网络</a> <a href=https://www.sdnlab.com/5365.html>搭建基于Open vSwitch的VxLAN隧道实验</a> <a href=http://docs.openvswitch.org/en/latest/howto/userspace-tunneling/ >Connecting VMs Using Tunnels (Userspace)</a></p> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2017-06-02 00:00:00">2017年6月2日</time></li> <li class=md-meta__item> 分类于 <a href=../../ class=md-meta__link>cloud-infra</a>, <a href=../../../linux-admin/ class=md-meta__link>linux-admin</a>, <a href=../../../draft/ class=md-meta__link>draft</a></li> <li class=md-meta__item> 需要 1 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=opendedup><a href=../../../../2017/06/02/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%B9%B3%E5%8F%B0%E9%95%9C%E5%83%8F%E5%8E%BB%E5%86%97%E6%B5%8B%E8%AF%95opendedup/ class=toclink>虚拟化平台镜像去冗测试（opendedup）</a></h2> <p>OpenDedup，是一款开源去重文件系统，https://github.com/opendedup/sdfs，可以分布式，支持NFS、iSCSI等，感觉非常厉害，作者是Veritas的银堡（Sam Silverberg）。</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>RedHat 7就开始带了VDO，但是还没测过。</p> </div> <p>可以去官网下载镜像，或者是笔者认为更加实用的NAS系统。</p> <h3 id=_1><a class=toclink href=../../../../2017/06/02/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%B9%B3%E5%8F%B0%E9%95%9C%E5%83%8F%E5%8E%BB%E5%86%97%E6%B5%8B%E8%AF%95opendedup/#_1>简单测试</a></h3> <p>目的是减少更多本地环境占用，使用opendedup测试。</p> <ol> <li> <p>首先测试我新闻服务器上的数据，以索引文件为主，经常变动，有大有小。</p> </li> <li> <p>然后选择一款kvm软件平台。</p> </li> </ol> <p>安装：</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span></pre></div></td><td class=code><div><pre><span></span><code>wget http://www.opendedup.org/downloads/sdfs-latest.deb
sudo dpkg -i sdfs-latest.deb

sudo su
echo &quot;* hardnofile 65535&quot; &gt;&gt; /etc/security/limits.conf
echo &quot;* soft nofile 65535&quot; &gt;&gt; /etc/security/limits.conf
exit
sudo mkfs.sdfs --volume-name=pool0 --volume-capacity=256GB
sudo mkdir /media/pool0 
sudo mount.sdfs pool0 /media/pool0/
</code></pre></div></td></tr></table></div> <p>数据拷贝进去后，原9.3GB索引数据降为8.5GB，效果不如想象中好。</p> <p>可能原因：</p> <p>sdfs提供了丰富的命令行选项，我没有使用，使用后可能会达到预期，比如更小的block。</p> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2017-05-21 00:00:00">2017年5月21日</time></li> <li class=md-meta__item> 分类于 <a href=../../ class=md-meta__link>cloud-infra</a></li> <li class=md-meta__item> 需要 10 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=openstackopendaylightsdn><a href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/ class=toclink>OpenStack、OpenDayLight、硬件SDN交换机集成</a></h2> <p>本文将讲述如何在OpenStack中使用SDN交换机，同时将OpenDayLight作为控制器，测试网络类型为vxlan。</p> <p>本文适用目标为OpenStack Neutron组件，但理论上说包括任何可使用Neutron组件服务的云管理平台，比如oVirt。</p> <p>在搭建Neutron时，笔者使用了现成的OpenStack单节点平台（可以参考https://github.com/lofyer/openstack-pxe-deployment，为防止出现3.1节末的错误，请使用Newton之前版本，我手贱部署了最新的），但为了减少搭建部署的麻烦，我会在后期尝试直接使用Neutron VM Appliance，方便集成（暂不确定是否影响性能）。</p> <p>update 2017-05-27: 当前版本zstack的云路由功能vyos所实现的nfv软路由，笔者会考虑将Neutron移植到ZStack中，如此以来SDN即可将注意力主要放在Neutron。</p> <p>update 2017-06-01: 加入盛科交换机，4.10内核的vtep可直接内核实现，参考<a href=https://www.kernel.org/doc/Documentation/networking/vxlan.txt>Linux doc</a> 。</p> <p>update 2017-06-07: OpenStack版本从Ocata切换为Newton，实验3.3重新做了。</p> <p>update 2017-06-12: 使用 Neutron appliance，并添加<a href=https://github.com/oVirt/vdsm/tree/master/vdsm_hooks/openstacknet>hooks</a>，构建ZStack SDN解决方案，来源可自行搜索oVirt的相关资料</p> <h2 id=1><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#1>1. 环境准备</a></h2> <p>Pica8 P-5101 48+4*8 10Gb SDN交换机2台（吵地脑袋疼），OpenStack Ocata，OpenDayLight Lastest,管理机器。</p> <p>mininet虚拟机地址：192.168.0.68</p> <p>操作机地址：192.168.0.55</p> <h2 id=2-mininet><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#2-mininet>2. 架构方案与mininet环境模拟实验</a></h2> <p>拓扑使用miniedit制作，同时首选项中打开“Start CLI”，操作机“ssh -Y mininet@MININET_IP”后，运行“sudo ~/mininet/examples/mininet.py”以开启。</p> <h3 id=21><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#21>2.1. 基础模拟实验——交换机互联</a></h3> <p>文字描述可参考<a href=http://blog.scottlowe.org/2012/11/27/connecting-ovs-bridges-with-patch-ports/ >http://blog.scottlowe.org/2012/11/27/connecting-ovs-bridges-with-patch-ports/</a>以及其中链接。</p> <p>miniedit拓扑：</p> <p><a href=https://blog.lofyer.org/wp-content/uploads/WX20170521-164516.png><img alt src=/blog/images/WX20170521-164516.png></a></p> <p>目的：连接两个交换机，使得h1与h3互通。</p> <p>方法：将两个交换机上的一个端口组组成patch。</p> <p>ovs-vsctl -- add-port s1 patch1 -- set interface patch1 type=patch options:peer=patch2 -- add-port s2 patch2 -- set interface patch2 type=patch options:peer=patch1</p> <p><strong>结果：</strong></p> <p>root@mininet-vm:/home/mininet# ovs-vsctl show 918037ec-b307-45d7-a75a-f1ac4337d135 Bridge "s1" Controller "tcp:127.0.0.1:6633" is_connected: true fail_mode: secure Port "s1" Interface "s1" type: internal Port "s1-eth2" Interface "s1-eth2" Port "s1-eth1" Interface "s1-eth1" Port "patch1" Interface "patch1" type: patch options: {peer="patch2"} Bridge "s2" Controller "tcp:127.0.0.1:6633" is_connected: true fail_mode: secure Port "s2-eth1" Interface "s2-eth1" Port "s2" Interface "s2" type: internal Port "patch2" Interface "patch2" type: patch options: {peer="patch1"} ovs_version: "2.0.2"</p> <p><a href=https://blog.lofyer.org/wp-content/uploads/WX20170521-174927.png><img alt src=/blog/images/WX20170521-174927.png></a></p> <h3 id=22><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#22>2.2. 进阶实验——流表</a></h3> <p>miniedit拓扑：同上。</p> <p>目的：阻断h1与h2、h2与h3，使得h1与h3互通。</p> <p>方法：下发如下流表。</p> <p>阻断h2与h1/h3的协议封包： ovs-ofctl add-flow s1 in_port=2,arp,ip,nw_dst=10.0.0.1,actions=drop ovs-ofctl add-flow s1 in_port=2,arp,ip,nw_dst=10.0.0.3,actions=drop</p> <p><strong>结果</strong></p> <p>mininet&gt; h1 ping h2 -c 2 PING 10.0.0.2 (10.0.0.2) 56(84) bytes of data. ^C --- 10.0.0.2 ping statistics --- 2 packets transmitted, 0 received, 100% packet loss, time 1006ms</p> <p>mininet&gt; h2 ping h1 -c 2 PING 10.0.0.1 (10.0.0.1) 56(84) bytes of data. ^C --- 10.0.0.1 ping statistics --- 2 packets transmitted, 0 received, 100% packet loss, time 1000ms</p> <p>mininet&gt; h3 ping h2 -c 2 PING 10.0.0.2 (10.0.0.2) 56(84) bytes of data. ^C --- 10.0.0.2 ping statistics --- 2 packets transmitted, 0 received, 100% packet loss, time 999ms</p> <p>mininet&gt; h2 ping h3 -c 2 PING 10.0.0.3 (10.0.0.3) 56(84) bytes of data. ^C --- 10.0.0.3 ping statistics --- 2 packets transmitted, 0 received, 100% packet loss, time 1006ms</p> <p>mininet&gt; h1 ping h3 -c 2 PING 10.0.0.3 (10.0.0.3) 56(84) bytes of data. 64 bytes from 10.0.0.3: icmp_seq=1 ttl=64 time=2.37 ms 64 bytes from 10.0.0.3: icmp_seq=2 ttl=64 time=0.561 ms</p> <p>--- 10.0.0.3 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1001ms rtt min/avg/max/mdev = 0.561/1.466/2.372/0.906 ms mininet&gt; h3 ping h1 -c 2 PING 10.0.0.1 (10.0.0.1) 56(84) bytes of data. 64 bytes from 10.0.0.1: icmp_seq=1 ttl=64 time=2.49 ms 64 bytes from 10.0.0.1: icmp_seq=2 ttl=64 time=0.548 ms</p> <p>--- 10.0.0.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1001ms rtt min/avg/max/mdev = 0.548/1.521/2.494/0.973 ms mininet&gt; </p> <p>root@mininet-vm:~# ovs-ofctl dump-flows s1 NXST_FLOW reply (xid=0x4): cookie=0x0, duration=485.308s, table=0, n_packets=0, n_bytes=0, idle_age=485, ip,in_port=2,nw_dst=10.0.0.1 actions=drop cookie=0x0, duration=483.569s, table=0, n_packets=3, n_bytes=294, idle_age=183, ip,in_port=2,nw_dst=10.0.0.3 actions=drop cookie=0x0, duration=1715.894s, table=0, n_packets=93, n_bytes=3906, idle_age=202, arp,in_port=1,arp_tpa=10.0.0.2 actions=drop cookie=0x0, duration=715.43s, table=0, n_packets=4, n_bytes=392, idle_age=400, ip,in_port=1,nw_dst=10.0.0.2 actions=drop</p> <h2 id=3><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#3>3. 综合实验环境配置</a></h2> <p>首先来看一下实验拓扑：</p> <p>图。。。。。。</p> <p><strong>SDN交换机</strong> 管理地址：192.168.0.250/24,</p> <p><strong>OpenStack Controller/Neutron</strong> IP: 192.168.0.80</p> <p><strong>OpenDayLight</strong> IP: 192.168.0.90 Web: http://192.168.0.90:8181/index.html</p> <h3 id=31-opendaylight><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#31-opendaylight>3.1. 设置OpenDayLight</a></h3> <p>在主机192.168.0.90上下载启动Boron版本<a href=https://www.opendaylight.org/downloads>OpenDayLight（其他版本未测试）</a>，然后解压运行（需要Java环境）：</p> <p>unzip distribution-karaf-0.5.3-Boron-SR3.zip cd distribution-karaf-0.5.3-Boron-SR3</p> <h2 id=odl><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#odl>启动ODL服务</a></h2> <p>./bin/start</p> <h2 id=openvswitch><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#openvswitch>本地安装并启动OpenvSwitch以作测试</a></h2> <p>yum localinstall -y https://repos.fedorapeople.org/repos/openstack/openstack-ocata/rdo-release-ocata-3.noarch.rpm systemctl enable openvswitch systemctl start openvswitch ovs-vsctl set-manager tcp:192.168.0.90:6640</p> <h2 id=_1><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#_1>进入客户端</a></h2> <p>./bin/client</p> <h2 id=netvirtdluxyangmanui><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#netvirtdluxyangmanui>安装netvirt与dlux界面，其中yangman为包管理器UI</a></h2> <p>opendaylight-user@root&gt; feature:install odl-netvirt-openstack odl-dlux-all odl-dlux-yangman odl-mdsal-apidocs odl-netvirt-ui</p> <p>然后访问http://192.168.0.90:8181/index.html，用户密码为admin/admin，可以看到我们刚刚添加的本地OVS。</p> <h3 id=33-openstackopendaylight><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#33-openstackopendaylight>3.3. OpenStack与OpenDayLight集成</a></h3> <p>首先要清除原有的实例和neutron网络。</p> <h2 id=_2><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#_2>实例</a></h2> <p>openstack server list +--------------------------------------+-----------+---------+------------+-------------+------------------------------------------------------+ | ID | Name | Status | Task State | Power State | Networks | +--------------------------------------+-----------+---------+------------+-------------+------------------------------------------------------+ | d45b1646-b559-4d6d-963c-af3da205aa36 | instance3 | SHUTOFF | - | Shutdown | flat-ens39=192.168.0.108; sharednet1=192.168.118.203 | +--------------------------------------+-----------+---------+------------+-------------+------------------------------------------------------+</p> <p>openstack server delete instance3</p> <h2 id=_3><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#_3>网络</a></h2> <p>openstack subnet list +--------------------------------------+-------------+--------------------------------------+------------------+ | ID | Name | Network | Subnet | +--------------------------------------+-------------+--------------------------------------+------------------+ | b0acb3ad-22d4-491c-94e7-488aca906398 | flat-subnet | b8f95552-9a45-49ae-b080-2e0041d4b2a0 | 192.168.0.0/24 | | c066992d-294d-4cd6-a3fb-0386619922c7 | subnet1 | 5ac25e6f-bf49-4217-abbc-11bf171c0a3e | 192.168.118.0/24 | +--------------------------------------+-------------+--------------------------------------+------------------+</p> <p>openstack router list +------------------------------+-------------------+--------+-------+-------------+-------+------------------------------+ | ID | Name | Status | State | Distributed | HA | Project | +------------------------------+-------------------+--------+-------+-------------+-------+------------------------------+ | 78507b26-38f0-4b4a- | router-flat-ens39 | ACTIVE | UP | False | False | de2aea51161642759a687b5768b2 | | a3c6-13d15c4f9665 | | | | | | 3b7e | +------------------------------+-------------------+--------+-------+-------------+-------+------------------------------+ ........</p> <h2 id=portroutersubnet><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#portroutersubnet>删除所有port、router、subnet后，再用如下命令检查一遍，应该为空</a></h2> <p>openstack port list</p> <p>接下来，我们将控制节点（neutron管理节点）与计算节点的OVS交于ODL管理。 首先停止相应服务。</p> <h2 id=_4><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#_4>计算节点，如果与控制节点相同则优先运行此部分内容</a></h2> <p>systemctl stop neutron-openvswitch-agent systemctl disable neutron-openvswitch-agent systemctl stop neutron-l3-agent systemctl disable neutron-l3-agent</p> <h2 id=neutron><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#neutron>Neutron控制节点</a></h2> <p>systemctl stop neutron-server systemctl stop neutron-l3-agent</p> <p>然后清空OVS数据库。</p> <p>systemctl stop openvswitch rm -rf /var/log/openvswitch/* rm -rf /etc/openvswitch/conf.db systemctl start openvswitch</p> <h2 id=_5><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#_5>清空后可看到如下</a></h2> <p>ovs-vsctl show bdf45776-c7c2-4df4-9911-007e89b67bbe ovs_version: "2.6.1"</p> <p>将其交予ODL管理。</p> <p>ovs-vsctl set-manager tcp:192.168.0.90:6640</p> <p>然后在控制节点与计算节点设置用来vxlan通信的本地端，这里只有一个节点192.168.0.80。</p> <p>ovs-vsctl set Open_vSwitch . other_config:local_ip=192.168.0.80</p> <p>设置好以后可以在节点上看到ODL自动创建了一个连接到ODL控制器的br-int。</p> <p>ovs-vsctl show bdf45776-c7c2-4df4-9911-007e89b67bbe Manager "tcp:192.168.0.90:6640" is_connected: true Bridge br-int Controller "tcp:192.168.0.90:6653" is_connected: true fail_mode: secure Port br-int Interface br-int type: internal ovs_version: "2.6.1"</p> <p local_ip=192.168.0.80>ovs-vsctl get Open_vSwitch . other_config</p> <p>此时reloadODL界面，可以看到多了个OVS。<a href=https://blog.lofyer.org/wp-content/uploads/QQ截图20170603215631.png><img alt src=/blog/images/QQ截图20170603215631-1024x474.png></a></p> <p>接下来让neutron使用ODL，我们首先需要在neutron控制节点上安装一个对应包。</p> <p>对于将ODL放置于OS控制节点的同学可以参考如下内容以修改swift端口：</p> <blockquote> <p>First, ensure that port 8080 (which will be used by OpenDaylight to listen for REST calls) is available. By default, swift-proxy-service listens on the same port, and you may need to move it (to another port or another host), or disable that service. It can be moved to a different port (e.g. 8081) by editing /etc/swift/proxy-server.conf and /etc/cinder/cinder.conf, modifying iptables appropriately, and restarting swift-proxy-service. Alternatively, OpenDaylight can be configured to listen on a different port, by modifying the jetty.port property value in etc/jetty.conf.</p> </blockquote> <p>yum install -y python-networking-odl</p> <p>修改/etc/neutron/plugins/ml2/ml2_conf.ini并添加内容。</p> <p>crudini --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 mechanism_drivers opendaylight crudini --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 tenant_network_types vxlan</p> <h2 id=ml2_conf_odlinineutron-server><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#ml2_conf_odlinineutron-server>ml2_conf_odl.ini中的设置无效且报错，可能是我姿势不对，原因是我忘了修改neutron-server的启动命令。</a></h2> <p>cat &lt;&gt; /etc/neutron/plugins/ml2/ml2_conf.ini [ml2_odl] url = http://192.168.0.90:8080/controller/nb/v2/neutron password = admin username = admin EOF</p> <p>然后修改服务后端为ODL。</p> <p>crudini --set /etc/neutron/neutron.conf DEFAULT service_plugins odl-router crudini --set /etc/neutron/dhcp_agent.ini DEFAULT force_metadata True crudini --set /etc/neutron/dhcp_agent.ini ovs ovsdb_interface vsctl</p> <p>重置neutron数据库并重启服务。</p> <p>mysql -e "DROP DATABASE IF EXISTS neutron_ml2;" -uroot -p mysql -e "CREATE DATABASE neutron_ml2 CHARACTER SET utf8;" -uroot -p neutron-db-manage --config-file /etc/neutron/neutron.conf --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head systemctl start neutron-server</p> <p>验证是否成功。</p> <p>curl -u admin:admin http://192.168.0.90:8080/controller/nb/v2/neutron/networks { "networks" : [ ] }</p> <p>最后在openstack中创建网络与实例。</p> <p>neutron router-create router1 neutron net-create private neutron subnet-create private --name=private_subnet 10.10.5.0/24 neutron router-interface-add router1 private_subnet nova boot --flavor <flavor> --image <image id> --nic net-id=<network id> test1 nova boot --flavor <flavor> --image <image id> --nic net-id=<network id> test2</p> <p>添加浮动IP。</p> <p>ovs-vsctl set Open_vSwitch . other_config:provider_mappings=physnet1:eth1 neutron net-create public-net -- --router:external --is-default --provider:network_type=flat --provider:physical_network=physnet1 neutron subnet-create --allocation-pool start=10.10.10.2,end=10.10.10.254 --gateway 10.10.10.1 --name public-subnet public-net 10.10.0.0/16 -- --enable_dhcp=False neutron router-gateway-set router1 public-net</p> <p>neutron floatingip-create public-net nova floating-ip-associate test1 <floating_ip></p> <p><a href=https://blog.lofyer.org/wp-content/uploads/微信截图_20170616131118.png><img alt src=/blog/images/微信截图_20170616131118.png></a></p> <p>在OpenStack O版中创建网络时ODL与OS分别出现如下错误。</p> <p>ODL: 2017-06-03 11:27:10,768 | ERROR | pool-46-thread-1 | QosInterfaceStateChangeListener | 350 - org.opendaylight.netvirt.neutronvpn-impl - 0.3.3.Boron-SR3 | Qos:Exception caught in Interface Operational State Up event java.lang.IllegalArgumentException: Supplied value "tapd5e5b153-39" does not match required pattern "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}<span class=arithmatex>\(" at com.google.common.base.Preconditions.checkArgument(Preconditions.java:145)[65:com.google.guava:18.0.0] at org.opendaylight.yang.gen.v1.urn.ietf.params.xml.ns.yang.ietf.yang.types.rev130715.Uuid.&lt;init&gt;(Uuid.java:55)[80:org.opendaylight.mdsal.model.ietf-yang-types-20130715:2013.7.15.9_3-Boron-SR3] at org.opendaylight.netvirt.neutronvpn.QosInterfaceStateChangeListener.add(QosInterfaceStateChangeListener.java:61)[350:org.opendaylight.netvirt.neutronvpn-impl:0.3.3.Boron-SR3] at org.opendaylight.netvirt.neutronvpn.QosInterfaceStateChangeListener.add(QosInterfaceStateChangeListener.java:27)[350:org.opendaylight.netvirt.neutronvpn-impl:0.3.3.Boron-SR3] at org.opendaylight.genius.datastoreutils.AsyncDataTreeChangeListenerBase\)</span>DataTreeChangeHandler.run(AsyncDataTreeChangeListenerBase.java:136)[310:org.opendaylight.genius.mdsalutil-api:0.1.3.Boron-SR3] at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)[:1.8.0_131] at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)[:1.8.0_131] at java.lang.Thread.run(Thread.java:748)[:1.8.0_131]</p> <p>OS: ERROR neutron.plugins.ml2.managers [req-8174eb6e-6a01-428e-9c3d-d9f115dfa36b - - - - -] Failed to bind port d5e5b153-390a-4129-babd-7work': None, 'id': u'f01e69c5-096e-4d01-a239-5dbe37005e9b', 'network_type': u'vxlan'}]</p> <p>原因可能是版本传参变了，ODL没及时更新，但我不会Java，会也不想去改ODL，所以我推荐读者用个老版本的Neutron，比如M版、N版啥的。</p> <h3 id=34-ovsvtep><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#34-ovsvtep>3.4. OVS创建vtep</a></h3> <p>IP： 192.168.0.101</p> <h3 id=35-openstacksdn><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#35-openstacksdn>3.5. OpenStack与SDN交换机集成</a></h3> <p>在ODL结束以后，我们再来试一下OpenStack与SDN交换机的集成，与上一节相互独立，即一个全新的OpenStack Newton环境。</p> <p>由于商业法务问题，我不会将Pica8的OpenStack插件源码全部放出来，另外放出来意义也不大，现有SDN交换机的同学可以直接向厂商索要。</p> <p>/usr/lib/python2.7/site-packages/neutron/plugins/ml2/drivers/</p> <p>Pica8交换机工作在OVS模式下，需要将neutron server与OVS Manager相连（管理网口），或许有其他方法。</p> <p>首先将插件文件拷贝至/usr/lib/python2.7/site-packages/neutron/plugins/ml2/drivers/，目录结构如下。</p> <p>/usr/lib/python2.7/site-packages/neutron/plugins/ml2/drivers/pica8/ ├── config.pyc ├── db.pyc ├── exceptions.pyc ├── <strong>init</strong>.pyc ├── mechanism_pica8.pyc ├── ml2_conf_pica8.ini ├── rpc.pyc └── vtep.ovsschema</p> <p>修改/usr/lib/python2.7/site-packages/neutron-9.3.1-py2.7.egg-info/entry_points.txt添加neutron驱动。</p> <p>... [neutron.ml2.mechanism_drivers] ... pica8 = neutron.plugins.ml2.drivers.pica8.mechanism_pica8:Pica8Driver ...</p> <p>创建/etc/neutron/plugins/ml2/ml2_conf_pica8.ini，并添加如下内容。</p> <p>[ml2_pica8]</p> <h2 id=listopt-list-of-other-vteps-ip-address-either-a-software-vtep-or><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#listopt-list-of-other-vteps-ip-address-either-a-software-vtep-or>(ListOpt) List of other VTEPs' IP address, either a software vtep or</a></h2> <h2 id=other-vendors-hardware-vtep><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#other-vendors-hardware-vtep>other vendor's hardware vtep.</a></h2> <h2 id=_6><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#_6></a></h2> <h2 id=example-vtep_list100010010001011000102><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#example-vtep_list100010010001011000102>Example: vtep_list=10.0.0.100,10.0.0.101,10.0.0.102</a></h2> <p>vtep_list=192.168.0.101</p> <h2 id=intopt-sync-interval-in-seconds-between-neutron-plugin-and-picaos><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#intopt-sync-interval-in-seconds-between-neutron-plugin-and-picaos>(IntOpt) Sync interval in seconds between Neutron plugin and PicaOS.</a></h2> <h2 id=this-field-defines-how-often-the-synchronization-is-performed><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#this-field-defines-how-often-the-synchronization-is-performed>This field defines how often the synchronization is performed.</a></h2> <h2 id=this-is-an-optional-field-if-not-set-a-value-of-180-seconds><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#this-is-an-optional-field-if-not-set-a-value-of-180-seconds>This is an optional field. If not set, a value of 180 seconds</a></h2> <h2 id=is-assumed><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#is-assumed>is assumed.</a></h2> <h2 id=_7><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#_7></a></h2> <p>sync_interval = 60</p> <h2 id=example-sync_interval-60><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#example-sync_interval-60>Example: sync_interval = 60</a></h2> <p>openstack_version = newton</p> <h2 id=example-openstack_version-kilo><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#example-openstack_version-kilo>Example: openstack_version = kilo</a></h2> <h2 id=picos-switch-configurations><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#picos-switch-configurations>PicOS Switch configurations.</a></h2> <h2 id=each-switch-to-be-managed-by-openstack-neutron-must-be-configured-here><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#each-switch-to-be-managed-by-openstack-neutron-must-be-configured-here>Each switch to be managed by Openstack Neutron must be configured here.</a></h2> <h2 id=format><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#format>Format:</a></h2> <p>[ml2_mech_pica_switch:192.168.0.250] =:,,... =: # =:project_name,,vni, # ...</p> <h2 id=ovsdb_port><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#ovsdb_port>ovsdb_port=</a></h2> <h2 id=example><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#example>Example:</a></h2> <h2 id=ml2_mech_pica_switch1921680250><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#ml2_mech_pica_switch1921680250>[ml2_mech_pica_switch:192.168.0.250]</a></h2> <h2 id=te-111physnet1dev-1dev-2dev-3><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#te-111physnet1dev-1dev-2dev-3>te-1/1/1=physnet1:dev-1,dev-2,dev-3</a></h2> <h2 id=te-112physnet2dev-4><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#te-112physnet2dev-4>te-1/1/2=physnet2:dev-4</a></h2> <h2 id=te-113physnet1project_nameadminvni3535><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#te-113physnet1project_nameadminvni3535>te-1/1/3=physnet1:project_name,admin,vni,3535</a></h2> <h2 id=ovsdb_port6640><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#ovsdb_port6640>ovsdb_port=6640</a></h2> <h2 id=source_ip192168080><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#source_ip192168080>source_ip=192.168.0.80</a></h2> <p>修改/usr/lib/systemd/system/neutron-server.service文件，在${DAEMON_ARGS}字段添加pica8的引导配置，需要停止neutron-server服务并systemctl daemon-reload。</p> <p>--config-file=/etc/neutron/plugins/ml2/ml2_conf_pica8.ini</p> <p>修改/etc/neutron/plugins/ml2/ml2_conf.ini，如下。</p> <p>type_drivers = vlan,vxlan project_network_types = vxlan mechanism_drivers = pica8,openvswitch</p> <h2 id=make-sure-the-is-consistent-in-the-following-configuration><a class=toclink href=../../../../2017/05/21/openstackopendaylight%E7%A1%AC%E4%BB%B6sdn%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E6%88%90/#make-sure-the-is-consistent-in-the-following-configuration>Make sure the <physical_network> is consistent in the following configuration</a></h2> <p>bridge_mappings=<physical_network>:br-ex network_vlan_ranges = <physical_network>:1:4094</p> <p>安装python-ovs库。</p> <p>yum install -y python-pip pip install ovs</p> <p>运行如下命令创建pica8插件数据库动作。</p> <p>neutron-db-manage --config-file /etc/neutron/neutron.conf --config-file /etc/neutron/plugins/ml2/ml2_conf.ini revision -m "add pica8 mechanism driver" --expand</p> <p>在生成的/usr/lib/python2.7/site-packages/neutron/db/migration/alembic_migrations/versions/newton/expand/94ca4fc9191b_add_pica8_mechanism_driver.py文件中添加如下内容。</p> <p>def upgrade(): op.create_table( 'pica8_interfaces_v2', sa.Column('id', sa.String(length=36), nullable=False, primary_key=True), sa.Column('switch', sa.String(length=36), nullable=False), sa.Column('interface', sa.String(10), nullable=False) ) op.create_table( 'pica8_vlan_allocations_v2', sa.Column('id', sa.String(length=36), nullable=False, primary_key=True), sa.Column('project_id', sa.String(length=255), nullable=False), sa.Column('network_id', sa.String(length=36), nullable=False), sa.Column('segmentation_id', sa.Integer, nullable=False), sa.Column('vlan_id', sa.Integer, nullable=False), sa.Column('vm_reference', sa.Integer, nullable=False, default=0), sa.Column('interface_id', sa.String(length=36), nullable=True), sa.ForeignKeyConstraint(['interface_id'], ['pica8_interfaces_v2.id'], ondelete='CASCADE') ) def downgrade(): op.drop_table('pica8_interfaces') op.drop_table('pica8_vlan_allocations_v2')</p> <p>执行如下命令升级数据库（如果失败请将最后参数替换为head）。</p> <p>neutron-db-manage --config-file /etc/neutron/neutron.conf --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade 94ca4fc9191b</p> <p>重启服务。</p> <p>systemctl restart openstack-nova-api systemctl restart neutron-server</p> <p>物理主机接入配置。</p> <p>Edit the file /etc/neutron/plugins/ml2/ml2_conf_pica8.ini to contain the following content: <interface_name>=<physical_network>:project_name,<project_name>,vni,<vxlan_id> <interface_name> is the interface of Pica8 switch connected to the physical host &lt; project_name &gt; is the name of the project owning the physical host <vxlan_id> is the vxlan id of the project network the physical host connects to</p> <p><a href=http://www.brianlinkletter.com/how-to-use-miniedit-mininets-graphical-user-interface/ >miniedit使用</a> <a href=http://www.pica8.com/document/v2.3/html/picos-routing-and-switching-configuration-guide>Pica8手册</a> <a href=http://docs.opendaylight.org/en/stable-boron/ >ODL手册</a> <a href=http://docs.opendaylight.org/en/stable-boron/opendaylight-with-openstack/index.html>OpenDaylight with Openstack Guide</a> <a href=http://docs.opendaylight.org/en/stable-boron/submodules/netvirt/docs/openstack-guide/openstack-with-netvirt.html#installing-opendaylight-on-an-existing-openstack>OpenStack with NetVirt</a> <a href=http://docs.opendaylight.org/en/stable-boron/submodules/netvirt/docs/openstack-guide/openstack-with-netvirt.html#installing-openstack-and-opendaylight-using-devstack>Installing OpenStack and OpenDaylight using DevStack</a> <a href=https://wiki.opendaylight.org//blog/images/5/59/CloudIntegrationwithOpenStackOVSDBNetVirt.pdf>https://wiki.opendaylight.org//blog/images/5/59/CloudIntegrationwithOpenStackOVSDBNetVirt.pdf</a></p> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2017-04-10 00:00:00">2017年4月10日</time></li> <li class=md-meta__item> 分类于 <a href=../../ class=md-meta__link>cloud-infra</a></li> <li class=md-meta__item> 需要 4 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=pid><a href=../../../../2017/04/10/%E4%B8%80%E7%A7%8D%E5%BA%94%E7%94%A8%E4%BA%8E%E4%BA%91%E5%B9%B3%E5%8F%B0%E8%B4%9F%E8%BD%BD%E7%9A%84pid%E9%9D%9E%E7%BA%BF%E6%80%A7%E6%8E%A7%E5%88%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/ class=toclink>一种应用于云平台负载的PID非线性控制系统设计</a></h2> <p>本文的实现效率尚有待考证，极有可能沦为扯淡文，但如果在网络资源部分可以快速应用测试。</p> <p>众所周知，很多计算机系统里的设计都可以描述为线性模型，但正如金融系统的发展，计算机系统直接面向大众以后，也会呈现出非线性的特征，比如典型的DDoS即是在系统设计之外。接下来，笔者将使用自控知识来设计一种自适应负载的云计算控制器，不仅适用于计算、也会适用于网络、存储等服务资源。</p> <p>以OpenStack平台的计算（虚拟机）为例，当用户的计算需求被量化后，那么我们就能根据其需求直接给出相应数量的计算节点。假如用户的计算需求是变化的，其值为R，且我们的程序员也是个直肠子，给出相应的计算能力为C，那么他设计的程序很有可能就是这个公式：</p> <p>N=10, R=n<em>N, C=(n+2)</em>N</p> <p>每台虚拟机的计算能力N为10，虚拟机数量为n。</p> <p>可以看出他给了两台的冗余量，啊哈，还不错。所以他期望的场景应该是这样的。</p> <p><a href=https://blog.lofyer.org/wp-content/uploads/figure_1.png><img alt src=/blog/images/figure_1.png></a></p> <p>其中黄色为实际需求，蓝色为平台提供,绿色为虚拟机数量。</p> <p>但是，假如需求呈现出短时间大量波动的话，比如下图。</p> <p><a href=https://blog.lofyer.org/wp-content/uploads/figure_2.png><img alt src=/blog/images/figure_2.png></a> 这个时候事情就不是那么美妙了，平台在即时响应的同时，伴随着大量虚拟机的上线/下线，从而造成一定的资源请求拥堵，降低控制性能。</p> <p>接下来，我们尝试引入PID回馈控制器，就是这个样子的。</p> <p><a href=https://blog.lofyer.org/wp-content/uploads/Pid-feedback-nct-int-correct.png><img alt src=/blog/images/Pid-feedback-nct-int-correct-1024x471.png></a></p> <p>PID的Python代码实现如下：</p> <p>!/usr/bin/python</p> <p>import time</p> <p>class PID: def <strong>init</strong>(self, P=0.2, I=0.0, D=0.0):</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span>
<span class=normal>59</span>
<span class=normal>60</span>
<span class=normal>61</span>
<span class=normal>62</span>
<span class=normal>63</span>
<span class=normal>64</span>
<span class=normal>65</span>
<span class=normal>66</span>
<span class=normal>67</span>
<span class=normal>68</span>
<span class=normal>69</span>
<span class=normal>70</span>
<span class=normal>71</span>
<span class=normal>72</span></pre></div></td><td class=code><div><pre><span></span><code>    self.Kp = P
    self.Ki = I
    self.Kd = D

    self.sample_time = 0.00
    self.current_time = time.time()
    self.last_time = self.current_time

    self.clear()

def clear(self):
    #Clears PID computations and coefficients
    self.SetPoint = 0.0

    self.PTerm = 0.0
    self.ITerm = 0.0
    self.DTerm = 0.0
    self.last_error = 0.0

    # Windup Guard
    self.int_error = 0.0
    self.windup_guard = 20.0

    self.output = 0.0

def update(self, feedback_value):
    # Calculates PID value for given reference feedback

    error = self.SetPoint - feedback_value

    self.current_time = time.time()
    delta_time = self.current_time - self.last_time
    delta_error = error - self.last_error

    if (delta_time &gt;= self.sample_time):
        self.PTerm = self.Kp * error
        self.ITerm += error * delta_time

        if (self.ITerm &lt; -self.windup_guard):
            self.ITerm = -self.windup_guard
        elif (self.ITerm &gt; self.windup_guard):
            self.ITerm = self.windup_guard

        self.DTerm = 0.0
        if delta_time &gt; 0:
            self.DTerm = delta_error / delta_time

        # Remember last time and last error for next calculation
        self.last_time = self.current_time
        self.last_error = error

        self.output = self.PTerm + (self.Ki * self.ITerm) + (self.Kd * self.DTerm)

def setKp(self, proportional_gain):
    # Determines how aggressively the PID reacts to the current error with setting Proportional Gain
    self.Kp = proportional_gain

def setKi(self, integral_gain):
    # Determines how aggressively the PID reacts to the current error with setting Integral Gain
    self.Ki = integral_gain

def setKd(self, derivative_gain):
    # Determines how aggressively the PID reacts to the current error with setting Derivative Gain
    self.Kd = derivative_gain

def setWindup(self, windup):
    # unwound
    self.windup_guard = windup

def setSampleTime(self, sample_time):
    # PID that should be updated at a regular interval.
    self.sample_time = sample_time
</code></pre></div></td></tr></table></div> <p>然后在上图条件下进行PID控制，代码如下：</p> <p>import PID import time import matplotlib.pyplot as plt import numpy as np from scipy.interpolate import spline</p> <p>def test_pid(P = 0.2, I = 0.0, D= 0.0, L=100): """Self-test PID class</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span>
<span class=normal>59</span>
<span class=normal>60</span>
<span class=normal>61</span>
<span class=normal>62</span></pre></div></td><td class=code><div><pre><span></span><code>.. note::
    ...
    for i in range(1, END):
        pid.update(feedback)
        output = pid.output
        if pid.SetPoint &gt; 0:
            feedback += (output - (1/i))
        if i&gt;9:
            pid.SetPoint = 1
        time.sleep(0.02)
    ---
&quot;&quot;&quot;
pid = PID.PID(P, I, D)
pid.clear()
pid.SetPoint=0.0
pid.setSampleTime(0.01)

END = L
feedback = 0

feedback_list = []
time_list = []
setpoint_list = []

for i in range(1, END):
    pid.update(feedback)
    output = pid.output
    if pid.SetPoint &gt; 0:
        feedback += (output - (1/i))
    if i&lt;10:
        pid.SetPoint = 20
    if i&gt;20:
        pid.SetPoint = 50
    if i&gt;22:
        pid.SetPoint = 100
    if i&gt;24:
        pid.SetPoint = 10
    if i&gt;28:
        pid.SetPoint = 200
    if i&gt;30:
        pid.SetPoint = 200
    if i&gt;70:
        pid.SetPoint = 20

    feedback_list.append(feedback)
    setpoint_list.append(pid.SetPoint)
    time_list.append(i)
    time.sleep(0.02)

time_sm = np.array(time_list)
time_smooth = np.linspace(time_sm.min(), time_sm.max(), 300)
feedback_smooth = spline(time_list, feedback_list, time_smooth)

plt.plot(time_smooth, feedback_smooth)
plt.plot(time_list, setpoint_list)
plt.xlim((0, L))
plt.ylim((min(feedback_list)-0.5, max(feedback_list)+0.5))
plt.xlabel(&#39;time (s)&#39;)
plt.ylabel(&#39;PID C-R&#39;)

plt.grid(True)
plt.show()
</code></pre></div></td></tr></table></div> <p>if <strong>name</strong> == "<strong>main</strong>": test_pid(1.01, 1, 0.001, L=100)</p> <p>然后看看现在是什么样呢？</p> <p><a href=https://blog.lofyer.org/wp-content/uploads/figure_3.png><img alt src=/blog/images/figure_3.png></a></p> <p>嗯，没错，多了一些调节量（超调量），且变化较之前平稳了一些。这些调节量是否适用于大批量的云计算环境还有待验证，但是以Web应用来看，这些调节量理应工作。</p> <p>另外，考虑到虚拟机在创建后某些应用可能短时间内不接受下调，所以我们可以动态地调节C的值，即PID的输出仅用作参考。</p> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2014-02-10 00:00:00">2014年2月10日</time></li> <li class=md-meta__item> 分类于 <a href=../../ class=md-meta__link>cloud-infra</a></li> <li class=md-meta__item> 需要 27 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=deploy-asterisk-on-centos><a href=../../../../2014/02/10/deploy-asterisk-on-centos/ class=toclink>Deploy Asterisk on CentOS</a></h2> <p>Get the latest packages. <strong>up to 2014-02-10</strong></p> <h2 id=rpm-uvh-httppackagesasteriskorgcentos6currentx86_64rpmsasterisknow-version-301-2_centos6noarchrpm><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#rpm-uvh-httppackagesasteriskorgcentos6currentx86_64rpmsasterisknow-version-301-2_centos6noarchrpm>rpm -Uvh http://packages.asterisk.org/centos/6/current/x86_64/RPMS/asterisknow-version-3.0.1-2_centos6.noarch.rpm</a></h2> <h2 id=yum-install-asterisk-asterisk-configs-enablerepoasterisk-12><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#yum-install-asterisk-asterisk-configs-enablerepoasterisk-12>yum install asterisk asterisk-configs --enablerepo=asterisk-12</a></h2> <h2 id=yum-install-dahdi-linux-dahdi-tools-libpri><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#yum-install-dahdi-linux-dahdi-tools-libpri>yum install dahdi-linux dahdi-tools libpri</a></h2> <h2 id=chkconfig-dahdi-on><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#chkconfig-dahdi-on>chkconfig dahdi on</a></h2> <h2 id=chkconfig-asterisk-on><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#chkconfig-asterisk-on>chkconfig asterisk on</a></h2> <h2 id=service-dahdi-start><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#service-dahdi-start>service dahdi start</a></h2> <h2 id=service-asterisk-start><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#service-asterisk-start>service asterisk start</a></h2> <p>You can use freepbx on http://localhost .</p> <h2 id=yum-install-freepbx><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#yum-install-freepbx>yum install freepbx</a></h2> <hr> <p>title: "use MAXS to control your device via ejabberd(plus ssh, jingle voice talk as a bonus)" date: 2014-02-26 categories: - "cloud-infra"</p> <hr> <p>Let's see what we have got here: A xmpp server based on ejabberd on my host: lofyer.org. Windows client: <a href=https://download.jitsi.org/jitsi/nightly/ >Jitsi(Recommended)</a>, <a href=http://www.pidgin.im/ >Pidgin</a>. (Optional)A Android client: <a href=http://www.xabber.org/ >Xabber.</a> <a href=http://f-droid.org/wiki/page/org.projectmaxs.main>MAXS</a> on my Nexus 5 Android phone.</p> <h3 id=1-prepare-the-serverdebian-7><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#1-prepare-the-serverdebian-7>1. Prepare the server(Debian 7)</a></h3> <h2 id=apt-get-install-ejabberd><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#apt-get-install-ejabberd>apt-get install ejabberd</a></h2> <h2 id=cd-etcejabberd-wget-httppeoplecollaboracomrobot101olpc-ejabberdejabberdcfg><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#cd-etcejabberd-wget-httppeoplecollaboracomrobot101olpc-ejabberdejabberdcfg>cd /etc/ejabberd/; wget http://people.collabora.com/~robot101/olpc-ejabberd/ejabberd.cfg</a></h2> <p>Change <strong>hosts</strong> and <strong>admin</strong> section to your <strong>FQDN</strong>. Here's a example:</p> <p>{hosts, ["lofyer.org"]}. {acl, admin, {user, "mypassword", "lofyer.org"}}.</p> <p>Then you should restart ejabberd, and maybe a reboot is essential.</p> <h2 id=etcinitdejabberd-restart><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#etcinitdejabberd-restart>/etc/init.d/ejabberd restart</a></h2> <h4 id=enable-jinglevoice-and-video><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#enable-jinglevoice-and-video>Enable Jingle(voice and video)</a></h4> <p>You need JingleNodes module on your server.</p> <h2 id=apt-get-install-erlang-tools><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#apt-get-install-erlang-tools>apt-get install erlang-tools</a></h2> <h2 id=git-clone-gitgitprocess-onenetexmppmainlinegit-exmpp><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#git-clone-gitgitprocess-onenetexmppmainlinegit-exmpp>git clone git://git.process-one.net/exmpp/mainline.git exmpp</a></h2> <h2 id=cd-exmpp-configure-make-make-install><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#cd-exmpp-configure-make-make-install>cd exmpp; ./configure; make; make install</a></h2> <h2 id=svn-checkout-httpjinglenodesgooglecodecomsvn-jinglenodes><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#svn-checkout-httpjinglenodesgooglecodecomsvn-jinglenodes>svn checkout http://jinglenodes.googlecode.com/svn/ jinglenodes</a></h2> <h2 id=cd-jinglenodes-configure-prefixusr-make-make-install><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#cd-jinglenodes-configure-prefixusr-make-make-install>cd jinglenodes; ./configure --prefix=/usr/; make; make install</a></h2> <p>Add following content to your ejabberd.cfg in the <strong>modules</strong> section.</p> <p>{mod_jinglenodes, [ {host, "jinglenodes.@HOST@"}, {public_ip, "192.168.1.148"}, {purge_period, 5000}, {relay_timeout, 60000} ]},</p> <h4 id=enable-web-registeroptional><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#enable-web-registeroptional>Enable web register(optional)</a></h4> <p>Add to ejabberd.cfg, 'modules' section the basic configuration:</p> <p>{modules, [ ... {mod_register_web, []}, ... ]}.</p> <p>In the 'listen' section enable the web page:</p> <p>{listen, [ ... {5281, ejabberd_http, [ tls, {certfile, "/etc/ejabberd/ejabberd.pem"}, {request_handlers, [ {["register"], mod_register_web} ]} ]}, ... ]}.</p> <h4 id=use-your-own-certificate><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#use-your-own-certificate>Use your own certificate</a></h4> <p>openssl req -new -x509 -newkey rsa:1024 -days 3650 -keyout privkey.pem -out server.pem openssl rsa -in privkey.pem -out privkey.pem cat privkey.pem &gt;&gt; server.pem rm privkey.pem</p> <p>The port numbers you should open are: 5281(http://localhost:5281/register/) 5280(http://localhost:5280/admin) and 5222(for c2s).</p> <p>Register users:</p> <h2 id=ejabberdctl-register-admin-lofyerorg-mypassword><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#ejabberdctl-register-admin-lofyerorg-mypassword>ejabberdctl register admin lofyer.org mypassword</a></h2> <h2 id=ejabberdctl-register-myphone-lofyerorg-mypassword><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#ejabberdctl-register-myphone-lofyerorg-mypassword>ejabberdctl register myphone lofyer.org mypassword</a></h2> <h2 id=ejabberdctl-register-mypc-lofyerorg-mypassword><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#ejabberdctl-register-mypc-lofyerorg-mypassword>ejabberdctl register mypc lofyer.org mypassword</a></h2> <h3 id=2-pidgin-and-maxs-test><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#2-pidgin-and-maxs-test>2. Pidgin and MAXS test</a></h3> <h3 id=pidgin-adminlofyerorg-maxs-myphonelofyerorg-by-the-way-guarantee-that-there-is-only-one-running-jabber-client-on-your-phone-during-this-period-pidgin-add-a-friend-shell-test-sms-test-and-a-msg-to-my-gf><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#pidgin-adminlofyerorg-maxs-myphonelofyerorg-by-the-way-guarantee-that-there-is-only-one-running-jabber-client-on-your-phone-during-this-period-pidgin-add-a-friend-shell-test-sms-test-and-a-msg-to-my-gf>Pidgin: admin@lofyer.org MAXS: myphone@lofyer.org By the way, guarantee that there is only one running jabber client on your phone during this period. <strong>Pidgin</strong> Add a friend <a href=http://blog.lofyer.org/ejabber-howto/pidgin/ ><img alt=pidgin src=/blog/images/pidgin.png></a> <strong>Shell test</strong> <a href=http://blog.lofyer.org/ejabber-howto/shell/ ><img alt=shell src=/blog/images/shell.png></a> <strong>SMS test</strong> <a href=http://blog.lofyer.org/ejabber-howto/sms-send/ ><img alt=SMS-SEND src=/blog/images/SMS-SEND.png></a> And a msg to my GF. <a href=http://blog.lofyer.org/ejabber-howto/sms-receive/ ><img alt=sms-receive src=/blog/images/sms-receive.jpg></a></a></h3> <p>title: "foreman/puppet/cfengine/bcfg2/chef howto" date: 2014-02-21 categories: - "linux-admin"</p> <hr> <h3 id=which-one-is-the-best-automatic-management-tool-tbd><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#which-one-is-the-best-automatic-management-tool-tbd><a href=http://uberblo.gs/2012/06/cfengine-bcfg2-chef-and-puppet title=cfengine-bcfg2-chef-and-puppet>Which one is the best automatic management tool</a> TBD</a></h3> <p>title: "Gitlab quick deploy" date: 2014-06-08 categories: - "linux-admin"</p> <hr> <p>Well, Gitweb + ssh://git@host is out of date. Even we use it for almost 2 years.</p> <p>We are migrating our repositories to Gitlab which we benefit from its "issue" a lot.</p> <p>Please follow this scripts I wrote.</p> <h3 id=httpsrawgithubusercontentcomlofyeronekey-deploymastergitlabinstallsh><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#httpsrawgithubusercontentcomlofyeronekey-deploymastergitlabinstallsh><a href=https://raw.githubusercontent.com/lofyer/onekey-deploy/master/gitlab/install.sh title="Gitlab quick deploy">https://raw.githubusercontent.com/lofyer/onekey-deploy/master/gitlab/install.sh</a></a></h3> <p>title: "Grafana+InfluxDB+Collectd/Telegraf on RPi2" date: 2017-03-06 categories: - "linux-admin"</p> <hr> <p>Grafana will provide a visual view for the sites, InfluxDB is the data box, and collectd/telegraf is the agent on the server. Here we go.</p> <p><strong>Install Grafana:</strong></p> <h2 id=download-deb-from-httpsgithubcomfg2itgrafana-on-raspberry><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#download-deb-from-httpsgithubcomfg2itgrafana-on-raspberry>Download deb from https://github.com/fg2it/grafana-on-raspberry</a></h2> <p>root@raspberrypi:~# rpm -i grafana.deb root@raspberrypi:~# service grafana-server start</p> <p><strong>Install InfluxDB:</strong> Download from <a href=https://portal.influxdata.com/downloads>https://portal.influxdata.com/downloads</a></p> <p>root@raspberrypi:~# tar xf influxdb-1.2.0_linux_armhf.tar.gz root@raspberrypi:~# cp -a influxdb-1.2.0-1/* /</p> <p>vim /etc/influxdb/influxdb.ini:</p> <p>[admin] enabled=true</p> <p>[http] enabled=true</p> <p>[collectd] enabled=true bind-address=":25826" database="collectd"</p> <p>Then run "influxdb &amp;" and check it out in http://localhost:8083, add db named "collectd".</p> <p><strong>Install Collectd:</strong></p> <p>root@raspberrypi:~# apt-get install collectd</p> <p>In /etc/collectd/collectd.conf, find :</p> <p><plugin network> <server &quot;localhost&quot; &quot;25826&quot;></server> </plugin></p> <p>Then restart collectd service.</p> <h3 id=now-you-can-visit-httplocalhost3000-to-add-influxdb-source-and-add-panel><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#now-you-can-visit-httplocalhost3000-to-add-influxdb-source-and-add-panel>Now you can visit http://localhost:3000 to add InfluxDB source and add panel.</a></h3> <p>title: "Hercules with Jason UI, emulator of IBM mainframe" date: 2017-04-26 categories: - "linux-admin"</p> <hr> <p>Hercules is an open source software implementation of the mainframe System/370 and ESA/390 architectures, in addition to the new 64-bit z/Architecture. Hercules runs under Linux, Windows (98, NT, 2000, and XP), Solaris, FreeBSD, and Mac OS X (10.3 and later).</p> <p><a href=http://lofyer.org:8081/ >Online web interface.(deprecated)</a></p> <p>Jason 1.00 is an integrated graphical frontend to the Hercules S/370, ESA/390 and z/Architecture Emulator. What, you haven't heard of Hercules before? It's a masterpiece that emulates IBM mainframes, from old good IBM System/360 and up to the modern z Series... No, it has nothing to do with IBM compatible... No, it can't emulate Xbox 360... Oh, you are asking what a mainframe is? Then probably you don't need Jason.</p> <p><a href=https://blog.lofyer.org/wp-content/uploads/Hercules-with-Jason.zip>Download Hercules with Jason</a>.</p> <h3 id=_1><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#_1><a href=https://blog.lofyer.org/wp-content/uploads/QQ截图20170426111158.png><img alt src=/blog/images/QQ截图20170426111158-1024x545.png></a></a></h3> <p>title: "Heartbeat and drbd test high availability" date: 2014-01-16 categories: - "linux-admin"</p> <hr> <p>Hosts: 192.168.1.101 ha1.lofyer.org, 2 hard drive disks, two ethernet ports 192.168.1.103 ha2.lofyer.org, almost same as ha1</p> <p>Server host, this is the IP of heartbeat service: 192.168.1.100</p> <h3 id=install><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#install>Install</a></h3> <p>The repos you need in centos</p> <p>[epel] name=Extra Packages for Enterprise Linux 6 - $basearch</p> <h2 id=baseurlhttpdownloadfedoraprojectorgpubepel6basearch><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#baseurlhttpdownloadfedoraprojectorgpubepel6basearch>baseurl=http://download.fedoraproject.org/pub/epel/6/$basearch</a></h2> <p>mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-6&amp;arch=$basearch failovermethod=priority enabled=1 gpgcheck=0 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6</p> <p>[elrepo] name=ELRepo.org Community Enterprise Linux Repository - el6 baseurl=http://elrepo.org/linux/elrepo/el6/$basearch/ mirrorlist=http://elrepo.org/mirrors-elrepo.el6 enabled=1 gpgcheck=0 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-elrepo.org protect=0</p> <h2 id=yum-install-drbd84-kmod-drbd84-heartbeat-mysql-server><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#yum-install-drbd84-kmod-drbd84-heartbeat-mysql-server>yum install drbd84 kmod-drbd84 heartbeat mysql-server</a></h2> <h3 id=setup><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#setup>Setup</a></h3> <h4 id=1-drbd-configuration-both-hosts><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#1-drbd-configuration-both-hosts>1. Drbd configuration both hosts</a></h4> <p><strong>Add following content to file: /etc/hosts</strong></p> <p>192.168.1.101 ha1.lofyer.org 192.168.1.103 ha2.lofyer.org</p> <p><strong>Disable selinux and iptables</strong></p> <h2 id=sed-i-senforcingpermissive-etcselinuxconfig><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#sed-i-senforcingpermissive-etcselinuxconfig>sed -i 's/enforcing/permissive/' /etc/selinux/config</a></h2> <h2 id=setenforce-0><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#setenforce-0>setenforce 0</a></h2> <h2 id=chkconfig-iptables-off><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#chkconfig-iptables-off>chkconfig iptables off</a></h2> <h2 id=service-iptables-stop><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#service-iptables-stop>service iptables stop</a></h2> <p><strong>Prepare the disk partion</strong></p> <h2 id=fdisk-devsdb-eof><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#fdisk-devsdb-eof>fdisk /dev/sdb &lt;&lt; EOF</a></h2> <p>n p 1</p> <p>w EOF</p> <p><strong>Configuration for mysql</strong> # mkdir db # sed -i 's/datadir=\/var\/lib\/mysql/datadir=\/db/' /etc/my.cnf <strong>Configuration for drbd</strong> file: /etc/drbd.conf</p> <p>global { minor-count 64; usage-count yes; } common { syncer { rate 1000M; } } resource ha { protocol C; handlers { pri-on-incon-degr "/usr/lib/drbd/notify-pri-on-incon-degr.sh; /usr/lib/drbd/notify-emergency-reboot.sh; echo b &gt; /proc/sysrq-trigger ; reboot -f"; pri-lost-after-sb "/usr/lib/drbd/notify-pri-lost-after-sb.sh; /usr/lib/drbd/notify-emergency-reboot.sh; echo b &gt; /proc/sysrq-trigger ; reboot -f"; local-io-error "/usr/lib/drbd/notify-local-io-error.sh; /usr/lib/drbd/notify-emergency-shutdown.sh; echo o &gt; /proc/sysrq-trigger ; halt -f"; fence-peer /usr/lib/heartbeat/drbd-peer-outdater -t 5; pri-lost "/usr/lib/drbd/notify-pri-lost.sh; /usr/lib/drbd/notify-emergency-reboot.sh; echo b &gt; /proc/sysrq-trigger ; reboot -f"; split-brain "/usr/lib/drbd/notify-split-brain.sh root"; out-of-sync "/usr/lib/drbd/notify-out-of-sync.sh root"; } startup { wfc-timeout 60; degr-wfc-timeout 120; outdated-wfc-timeout 2; } disk { on-io-error detach; fencing resource-only; } syncer { rate 1000M; } on ha1.lofyer.org { device /dev/drbd0; disk /dev/sdb1; address 192.168.1.101:7788; meta-disk internal; } on ha2.lofyer.org { device /dev/drbd0; disk /dev/sdb1; address 192.168.1.103:7788; meta-disk internal; } }</p> <p><strong>Chmod for drbd</strong></p> <p># chgrp haclient /sbin/drbdsetup # chmod o-x /sbin/drbdsetup # chmod u+s /sbin/drbdsetup # chgrp haclient /sbin/drbdmeta # chmod o-x /sbin/drbdmeta # chmod u+s /sbin/drbdmeta</p> <p><strong>Resource for drbd</strong></p> <p># modprobe drbd # dd if=/dev/zero of=/dev/hdb1 bs=1M count=100 # drbdadm create-md ha # service drbd start # chkconfig drbd on </p> <p><strong>Watch drbd status</strong></p> <h2 id=watch-n-1-service-drbd-status><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#watch-n-1-service-drbd-status>watch -n 1 service drbd status</a></h2> <p>You can see that both hosts are Secondary/Secondary.</p> <h4 id=2-drbd-configuration-on-one-of-hosts-like-ha1><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#2-drbd-configuration-on-one-of-hosts-like-ha1>2. Drbd configuration on one of hosts, like ha1</a></h4> <p><strong>Make ha1 Primary</strong></p> <p># drbdadm -- --overwrite-data-of-peer primary ha # service drbd status</p> <p>Then you should see Primary and wait for both hosts are UpToDate. <strong>Initialization for Mysql</strong> Make a</p> <h2 id=mkfsext4-devdrbd0><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#mkfsext4-devdrbd0>mkfs.ext4 /dev/drbd0</a></h2> <h2 id=mount-devdrbd0-db><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#mount-devdrbd0-db>mount /dev/drbd0 /db</a></h2> <h2 id=service-mysqld-start><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#service-mysqld-start>service mysqld start</a></h2> <p>Now you should see what you have got in /db, then umount /db, stop mysql-server and make ha1 Secondary.</p> <h2 id=service-mysqld-stop><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#service-mysqld-stop>service mysqld stop</a></h2> <h2 id=umount-devdrbd0><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#umount-devdrbd0>umount /dev/drbd0</a></h2> <h2 id=drbdadm-secondary-ha><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#drbdadm-secondary-ha>drbdadm secondary ha</a></h2> <h4 id=3-heartbeat-configuration-on-both-hosts><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#3-heartbeat-configuration-on-both-hosts>3. Heartbeat configuration on both hosts</a></h4> <p><strong>cluster authkey</strong></p> <h2 id=echo-ne-auth-1n1-sha1-dd-ifdevurandom-bs512-count1-openssl-md5-etchadauthkeys><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#echo-ne-auth-1n1-sha1-dd-ifdevurandom-bs512-count1-openssl-md5-etchadauthkeys>(echo -ne "auth 1\n1 sha1 "; dd if=/dev/urandom bs=512 count=1 | openssl md5) &gt; /etc/ha.d/authkeys</a></h2> <h2 id=cat-etchadauthkeys><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#cat-etchadauthkeys>cat /etc/ha.d/authkeys</a></h2> <p>auth 1 1 sha1 71461fc5e160d7846c2f4b524f952128</p> <h2 id=chmod-600-etchadauthkeys><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#chmod-600-etchadauthkeys>chmod 600 /etc/ha.d/authkeys</a></h2> <h2 id=scp-etchadauthkeys-node2etchad><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#scp-etchadauthkeys-node2etchad>scp /etc/ha.d/authkeys node2:/etc/ha.d/</a></h2> <p>YOU SHOULD MODIFY THE IP IN THE FILE. file: /etc/ha.d/ha.cf</p> <p>debugfile /var/log/ha-debug logfile /var/log/ha-log logfacility local0 autojoin none ucast eth0 192.168.1.101 ucast eth1 192.168.1.102 ping 192.168.1.100 respawn hacluster /usr/lib64/heartbeat/ipfail respawn hacluster /usr/lib64/heartbeat/dopd apiauth dopd gid=haclient uid=hacluster udpport 694 warntime 5 deadtime 15 initdead 60 keepalive 2 node ha1.lofyer.org node ha2.lofyer.org auto_failback off </p> <p>The service will be serve on IP 192.168.1.100. file: /etc/ha.d/haresources</p> <p>mysql.lofyer.org 192.168.1.100 drbddisk::ha Filesystem::/dev/drbd0::/db::ext4 mysql</p> <p>If you just wanna a virtual ip, use this</p> <p>hosta.vf.com IPaddr::192.168.0.100/24/eth0:0</p> <p><strong>Add mysql entry to heartbeat</strong> file: /etc/ha.d/resource.d/mysql</p> <h2 id=binbash><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#binbash>!/bin/bash</a></h2> <p>. /etc/ha.d/shellfuncs case "<span class=arithmatex>\(1" in start) res=\`/etc/init.d/mysqld start\` ret=\)</span>? ha_log $res exit <span class=arithmatex>\(ret ;; stop) res=\`/etc/init.d/mysqld stop\` ret=\)</span>? ha_log $res exit $ret ;; status) if [[ `ps -ef | grep '[m]ysqld'` &gt; 1 ]]; then echo "running" else echo "stopped" fi ;; *) echo "Usage: mysqld {start|stop|status}" exit 1 ;; esac exit 0</p> <p>Add excute permission to it.</p> <h2 id=chmod-755-etchadresourcedmysql><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#chmod-755-etchadresourcedmysql>chmod 755 /etc/ha.d/resource.d/mysql</a></h2> <p><strong>Add heartbeat service to system</strong></p> <h2 id=chkconfig-add-heartbeat><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#chkconfig-add-heartbeat>chkconfig --add heartbeat</a></h2> <h2 id=chkconfig-heartbeat-on><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#chkconfig-heartbeat-on>chkconfig heartbeat on</a></h2> <h2 id=service-heartbeat-start><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#service-heartbeat-start>service heartbeat start</a></h2> <p><em>You may need modify order of drbd and heartbeat service. In /etc/init.d/, the number 85 and 15 represent the order number which the script is to be run at start up time and shutdown time. # chkconfig: - 85 15</em></p> <h3 id=test-ha><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#test-ha>Test HA</a></h3> <hr> <p>title: "ltsp相关" date: 2013-03-15 categories: - "linux-admin"</p> <hr> <p>参考： https://help.ubuntu.com/community/UbuntuLTSP</p> <p>安装： apt-get install ltsp-server-standalone</p> <p>启动要素： nbd-server dhcpd tftp-hpa openssh-server</p> <p>绑定客户端地址： [dhcpd.conf] host client201 { hardware ethernet 08:00:27:89:70:01; fixed-address 192.168.0.201; } 另外一种是在启动pxe配置文件中指定 http://wiki.phys.ethz.ch/readme/setting_up_an_ltsp_server_for_diskless_clients</p> <p>session &amp; windows [/usr/share/xsession/*] Exec=/root/.xsession</p> <p>[/root/.xsession] #!/bin/bash gnome-session &amp; firefox logout</p> <p>获取session list [/usr/share/ldm/ldminfod] [/etc/X11/xinit/Xsession] [/etc/X11/Xsession] **failsafe [/etc/X11/xdm/Xsession] [/usr/lib/X11/xdm/Xsession] *[/usr/share/xsession]</p> <p>**default session exported by Xsession.d echo $DEFAULTS_PATH /usr/share/gconf/</p> <p>修改default session [/var/lib/tftp.../lts.conf] LDM_SESSION="gnome-session &amp;;firefox;logout"</p> <p>FatClient [/var/lib/tftp.../lts.conf] [default] LDM_DIRECTX=true</p> <p>[00:A1:08:EB:43:27] LTSP_FATCLIENT=false</p> <p>AutoLogin [/var/lib/tftp.../lts.conf] [Default] LDM_AUTOLOGIN = True</p> <p>[192.168.1.101] LDM_USERNAME = user1 LDM_PASSWORD = password1</p> <p>[192.168.1.102] LDM_USERNAME = user2 LDM_PASSWORD = password2</p> <h3 id=ltsconf-global-defaults-for-all-clients-if-you-refer-to-the-local-server-just-use-the-server-keyword-as-value-see-lts_parameterstxt-for-valid-values-default-x_color_depth24-localdevtrue-soundtrue-use_local_swaptrue-nbd_swapfalse-syslog_hostserver-xkblayoutde-screen_02shell-screen_03shell-screen_04shell-screen_05shell-screen_06shell-screen_07ldm-ldm_directxtrue-allows-greater-scalability-and-performance-turn-this-off-if-you-want-greater-security-instead-ldm_directxtrue-ldm_syslogtrue-writes-to-servers-syslog-ldm_syslogtrue><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#ltsconf-global-defaults-for-all-clients-if-you-refer-to-the-local-server-just-use-the-server-keyword-as-value-see-lts_parameterstxt-for-valid-values-default-x_color_depth24-localdevtrue-soundtrue-use_local_swaptrue-nbd_swapfalse-syslog_hostserver-xkblayoutde-screen_02shell-screen_03shell-screen_04shell-screen_05shell-screen_06shell-screen_07ldm-ldm_directxtrue-allows-greater-scalability-and-performance-turn-this-off-if-you-want-greater-security-instead-ldm_directxtrue-ldm_syslogtrue-writes-to-servers-syslog-ldm_syslogtrue>一些参考配置 [lts.conf] # Global defaults for all clients # if you refer to the local server, just use the # "server" keyword as value # see lts_parameters.txt for valid values ################ [default] X_COLOR_DEPTH=24 LOCALDEV=True SOUND=True USE_LOCAL_SWAP=True NBD_SWAP=False SYSLOG_HOST=server #XKBLAYOUT=de SCREEN_02=shell SCREEN_03=shell SCREEN_04=shell SCREEN_05=shell SCREEN_06=shell SCREEN_07=ldm # LDM_DIRECTX=True allows greater scalability and performance # Turn this off if you want greater security instead. LDM_DIRECTX=True # LDM_SYSLOG=True writes to server's syslog LDM_SYSLOG=True</a></h3> <p>title: "IPA服务器搭建" date: 2012-11-27 categories: - "linux-admin"</p> <hr> <p>IPASERVER+DNS(DDWRT)+IPACLIENT</p> <p>SERVER: ipa-server-install时这里可以不要内部dns 注意host以及domain要在dns里有记录 添加用户 ipa user-add 设置密码 ipa passwd demo DNS: 下面是ddwrt的dnsmasq配置 <code>domain=ovirt.engine local=/ovirt.engine/ expand-hosts address=/ovirtmgmt.ovirt.engine/192.168.1.106 ptr-record=106.1.168.192.in-addr.arpa,"ovirtmgmt.ovirt.engine" address=/ipa.ovirt.engine/192.168.1.108 ptr-record=108.1.168.192.in-addr.arpa,"ipa.ovirt.engine" srv-host=_kerberos-master._tcp,ipa.ovirt.engine,88,0,100 srv-host=_kerberos-master._udp,ipa.ovirt.engine,88,0,100 srv-host=_kerberos._tcp,ipa.ovirt.engine,88,0,100 srv-host=_kerberos._udp,ipa.ovirt.engine,88,0,100 srv-host=_kpasswd._tcp,ipa.ovirt.engine,464,0,100 srv-host=_kpasswd._udp,ipa.ovirt.engine,464,0,100 srv-host=_ldap._tcp,ipa.ovirt.engine,389,0,100</code> <a href=http://69.164.197.168/wp-content/uploads/2012/11/QQ截图20121127132532.png><img alt src=/blog/images/QQ截图20121127132532.png title=QQ截图20121127132532></a></p> <p>IPACLIENT: install时注意域名及主机名正确</p> <p>OVIRT: 初次使用要在SERVER运行 kinit admin</p> <h3 id=reinstall-ipa-server-install-uninstall-u-ls-ld-varlibpki-ca-if-it-exists-run-pkiremove-pki_instance_rootvarlib-pki_instance_namepki-ca-force-yum-reinstall-pki-selinux><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#reinstall-ipa-server-install-uninstall-u-ls-ld-varlibpki-ca-if-it-exists-run-pkiremove-pki_instance_rootvarlib-pki_instance_namepki-ca-force-yum-reinstall-pki-selinux>reinstall出错时： # ipa-server-install --uninstall -U # ls -ld /var/lib/pki-ca If it exists run: # pkiremove -pki_instance_root=/var/lib -pki_instance_name=pki-ca --force # yum reinstall pki-selinux</a></h3> <p>title: "Intergrate owncloud with AD(LDAP)" date: 2014-04-24 categories: - "linux-admin"</p> <hr> <p>Windows 2008R2 server with AD role built. User group: <strong>owncloudgrp</strong> User in <strong>owncloudgrp</strong>: aaa, beta Users must have <strong>logon name, first name, last name</strong> set.</p> <h3 id=configure-the-owncloud><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#configure-the-owncloud>Configure the owncloud:</a></h3> <p>Server:</p> <p><a href=http://blog.lofyer.org/intergrate-owncloud-adldap/oc1/ ><img alt=oc1 src=/blog/images/oc1.png></a></p> <p>User Filter:</p> <p><a href=http://blog.lofyer.org/intergrate-owncloud-adldap/oc2/ ><img alt=oc2 src=/blog/images/oc2.png></a></p> <p>Login Filter:</p> <p><a href=http://blog.lofyer.org/intergrate-owncloud-adldap/oc3/ ><img alt=oc3 src=/blog/images/oc3.png></a></p> <p>Group Filter: Every time you change these two sections, <strong>wait for a few seconds</strong> until more than zero users discovered.</p> <p><a href=http://blog.lofyer.org/intergrate-owncloud-adldap/oc4/ ><img alt=oc4 src=/blog/images/oc4.png></a></p> <p>Advanced - Connection Settings:</p> <p><a href=http://blog.lofyer.org/intergrate-owncloud-adldap/oc5/ ><img alt=oc5 src=/blog/images/oc5.png></a></p> <p>Advanced - Directory Settings:</p> <p><a href=http://blog.lofyer.org/intergrate-owncloud-adldap/oc6/ ><img alt=oc6 src=/blog/images/oc6.png></a></p> <p>Expert: Add internal username: sAMAccountName</p> <h3 id=_2><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#_2><a href=http://blog.lofyer.org/intergrate-owncloud-adldap/oc7/ ><img alt=oc7 src=/blog/images/oc7.png></a></a></h3> <p>title: "use Foreman/Nagios/Icinga to make life easy..." date: 2013-09-24 categories: - "linux-admin"</p> <hr> <h2 id=install-nagios-in-gentoocentos><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#install-nagios-in-gentoocentos>Install nagios in Gentoo/CentOS</a></h2> <h3 id=gentoo><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#gentoo>Gentoo</a></h3> <h2 id=emerge-nagios><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#emerge-nagios>emerge nagios</a></h2> <h4 id=option-recompile-apache-for-php-support><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#option-recompile-apache-for-php-support>Option: recompile apache for php support</a></h4> <p>add use flag "apache2" to /etc/portage/make.conf</p> <h2 id=emerge-ask-changed-use-deep-world><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#emerge-ask-changed-use-deep-world>emerge --ask --changed-use --deep @world</a></h2> <h4 id=copy-following-content-to-etcapache2vhostsd><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#copy-following-content-to-etcapache2vhostsd>Copy following content to /etc/apache2/vhosts.d/</a></h4> <p>ScriptAlias /nagios/cgi-bin "/usr/lib64/nagios/cgi-bin" <directory &quot; usr lib64 nagios cgi-bin&quot;></p> <h2 id=sslrequiressl><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#sslrequiressl>SSLRequireSSL</a></h2> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code>Options ExecCGI
AllowOverride None
Order allow,deny
Allow from all
</code></pre></div></td></tr></table></div> <h2 id=order-denyallow><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#order-denyallow>Order deny,allow</a></h2> <h2 id=deny-from-all><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#deny-from-all>Deny from all</a></h2> <h2 id=allow-from-127001><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#allow-from-127001>Allow from 127.0.0.1</a></h2> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code>AuthName &quot;Nagios Access&quot;
AuthType Basic
AuthUserFile /etc/nagios/auth.users
Require valid-user
</code></pre></div></td></tr></table></div> <p>Alias /nagios "/usr/share/nagios/htdocs" <directory &quot; usr share nagios htdocs&quot;></p> <h2 id=sslrequiressl_1><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#sslrequiressl_1>SSLRequireSSL</a></h2> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code>Options None
AllowOverride None
Order allow,deny
Allow from all
</code></pre></div></td></tr></table></div> <h2 id=order-denyallow_1><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#order-denyallow_1>Order deny,allow</a></h2> <h2 id=deny-from-all_1><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#deny-from-all_1>Deny from all</a></h2> <h2 id=allow-from-127001_1><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#allow-from-127001_1>Allow from 127.0.0.1</a></h2> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code>AuthName &quot;Nagios Access&quot;
AuthType Basic
AuthUserFile /etc/nagios/auth.users
Require nagiosadmin
</code></pre></div></td></tr></table></div> <h4 id=create-password-for-nagiosadmin><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#create-password-for-nagiosadmin>Create password for nagiosadmin</a></h4> <h2 id=htpasswd2-c-etcnagiosauthusers-nagiosadmin><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#htpasswd2-c-etcnagiosauthusers-nagiosadmin>htpasswd2 -c /etc/nagios/auth.users nagiosadmin</a></h2> <h4 id=add-nagios-to-apache-config><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#add-nagios-to-apache-config>Add NAGIOS to apache config</a></h4> <p>/etc/conf.d/apache</p> <p>APACHE2_OPTS="... -D NAGIOS -D PHP5"</p> <p>Add user nagios to apache group</p> <h2 id=usermod-a-g-nagios-apache><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#usermod-a-g-nagios-apache>usermod -a -G nagios apache</a></h2> <p>Start service</p> <h2 id=rc-service-nagios-restart><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#rc-service-nagios-restart>rc-service nagios restart</a></h2> <h2 id=rc-service-apache2-restart><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#rc-service-apache2-restart>rc-service apache2 restart</a></h2> <h3 id=centos><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#centos>CentOS</a></h3> <h2 id=yum-install-nagios><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#yum-install-nagios>yum install "nagios*"</a></h2> <h2 id=htpasswd-c-etcnagiospasswd-admin><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#htpasswd-c-etcnagiospasswd-admin>htpasswd -c /etc/nagios/passwd admin</a></h2> <h2 id=chkconfig-nagios-on><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#chkconfig-nagios-on>chkconfig nagios on</a></h2> <h2 id=chkconfig-httpd-on><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#chkconfig-httpd-on>chkconfig httpd on</a></h2> <h2 id=service-nagios-start><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#service-nagios-start>service nagios start</a></h2> <h2 id=service-httpd-start><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#service-httpd-start>service httpd start</a></h2> <h3 id=add-routershosts-add-service-add-hooks><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#add-routershosts-add-service-add-hooks>Add routers/hosts, add service, add hooks</a></h3> <h3 id=intergrate-with-ovirt><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#intergrate-with-ovirt>Intergrate with oVirt</a></h3> <h2 id=using-foreman><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#using-foreman>using Foreman</a></h2> <h3 id=install_1><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#install_1>Install</a></h3> <h3 id=use><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#use>USE</a></h3> <h3 id=intergrate-with-ovirt_1><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#intergrate-with-ovirt_1>Intergrate with oVirt</a></h3> <h3 id=tbd><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#tbd>TBD</a></h3> <p>title: "OAuth2 Guide" date: 2017-07-28 categories: - "linux-admin" - "draft"</p> <hr> <p>这是一篇OAuth2的入门短文，这就开始。</p> <p>整体可以参考<a href=https://www.ory.am/run-oauth2-server-open-source-api-security.html>Hydra OAuth2的搭建过程</a>，非常详细，过程就不讲了，直接看图更直观。</p> <p><img alt src=/blog/images/ORY%20Hydra%20Consent%20Flow.png></p> <h3 id=hostserverclientusercallback_urlopenid><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#hostserverclientusercallback_urlopenid>建议过程：在host上搭建server以后，创建client、user、callback_url，还能绑定OpenID，多好。</a></h3> <p>title: "OpenLDAP step by step how-to" date: 2014-04-14 categories: - "linux-admin"</p> <hr> <p>I need an authentication system with compatibility and many extended features(like bio-device). So, I've got AD, IPA and OpenLDAP to choose from. AD comes from MS and it is too "heavy" for the not-very-large system. IPA and OpenLDAP are almost same, but I prefer latter, since it's compatible with oVirt(This why I choose CentOS rather than debian).</p> <h2 id=the-simplest-openldap-server><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#the-simplest-openldap-server>The simplest OpenLDAP server</a></h2> <p>A basic LDAP without any security or additional features.</p> <h2 id=openldap-with-sasl><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#openldap-with-sasl>OpenLDAP with SASL</a></h2> <p>Add SASL to our LDAP.</p> <h2 id=openldap-with-samba><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#openldap-with-samba>OpenLDAP with SAMBA</a></h2> <p>To add Windows PC to our domain.</p> <h2 id=openldap-with-kerberos><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#openldap-with-kerberos>OpenLDAP with Kerberos</a></h2> <p>This is what we want finally. ============================================================</p> <h2 id=1-the-simplest-openldap-server><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#1-the-simplest-openldap-server>1. The simplest OpenLDAP server</a></h2> <p>I've got 2 ways to setup an openldap server: <strong>389-ds script</strong> and <strong>manually configure</strong>.</p> <h3 id=11-using-389-ds-script><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#11-using-389-ds-script>1.1 Using 389-ds script</a></h3> <p><a href=http://www.unixmen.com/setup-directory-serverldap-in-centos-6-4-rhel-6-4/ title="Setup 389-ds">Here's the original article.</a></p> <h4 id=preparation><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#preparation>Preparation</a></h4> <p>Before setup, this configuration should be modified. Add following:</p> <p>192.168.1.80 ldap.lofyer.org</p> <p>Add following:</p> <p>net.ipv4.tcp_keepalive_time = 30 net.ipv4.ip_local_port_range = 1024 65000 fs.file-max = 64000</p> <p>Add following:</p> <p>* soft nofile 8192 * hard nofile 8192</p> <p>Add following:</p> <p>session required /lib/security/pam_limits.so</p> <p>Then <strong>reboot</strong> the machine to make above configurations work.</p> <h4 id=setup-389-ds><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#setup-389-ds>Setup 389-ds</a></h4> <h2 id=useradd-ldapadmin><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#useradd-ldapadmin>useradd ldapadmin</a></h2> <h2 id=passwd-ldapadmin><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#passwd-ldapadmin>passwd ldapadmin</a></h2> <h2 id=yum-install-y-389-ds-openldap-clients><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#yum-install-y-389-ds-openldap-clients>yum install -y 389-ds openldap-clients</a></h2> <h2 id=setup-ds-adminpl><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#setup-ds-adminpl>setup-ds-admin.pl</a></h2> <p>Then you'll see some questions like this(sorry for the high-lighting...):</p> <p>============================================================================== This program will set up the 389 Directory and Administration Servers.</p> <p>It is recommended that you have "root" privilege to set up the software. Tips for using this program: - Press "Enter" to choose the default and go to the next screen - Type "Control-B" then "Enter" to go back to the previous screen - Type "Control-C" to cancel the setup program</p> <p>Would you like to continue with set up? [yes]: ## Press Enter ## </p> <p>============================================================================== Your system has been scanned for potential problems, missing patches, etc. The following output is a report of the items found that need to be addressed before running this software in a production environment.</p> <p>389 Directory Server system tuning analysis version 23-FEBRUARY-2012.</p> <p>NOTICE : System is i686-unknown-linux2.6.32-431.el6.i686 (1 processor).</p> <p>WARNING: 622MB of physical memory is available on the system. 1024MB is recommended for best performance on large production system.</p> <p>WARNING : The warning messages above should be reviewed before proceeding.</p> <p>Would you like to continue? [no]: yes ## Type Yes and Press Enter ##</p> <p>============================================================================== Choose a setup type: 1. Express Allows you to quickly set up the servers using the most common options and pre-defined defaults. Useful for quick evaluation of the products. 2. Typical Allows you to specify common defaults and options. 3. Custom Allows you to specify more advanced options. This is recommended for experienced server administrators only. To accept the default shown in brackets, press the Enter key.</p> <p>Choose a setup type [2]: ## Press Enter ##</p> <p>============================================================================== Enter the fully qualified domain name of the computer on which you're setting up server software. Using the form . Example: eros.example.com.</p> <p>To accept the default shown in brackets, press the Enter key.</p> <p>Warning: This step may take a few minutes if your DNS servers can not be reached or if DNS is not configured correctly. If you would rather not wait, hit Ctrl-C and run this program again with the following command line option to specify the hostname:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code>General.FullMachineName=your.hostname.domain.name
</code></pre></div></td></tr></table></div> <p>Computer name [ldap.lofyer.org]: ## Press Enter ##</p> <p>============================================================================== he servers must run as a specific user in a specific group. It is strongly recommended that this user should have no privileges on the computer (i.e. a non-root user). The setup procedure will give this user/group some permissions in specific paths/files to perform server-specific operations.</p> <p>If you have not yet created a user and group for the servers, create this user and group using your native operating system utilities.</p> <p>System User [nobody]: ldapadmin ## Enter LDAP user name created above # System Group [nobody]: ldapadmin</p> <p>============================================================================== Server information is stored in the configuration directory server. This information is used by the console and administration server to configure and manage your servers. If you have already set up a configuration directory server, you should register any servers you set up or create with the configuration server. To do so, the following information about the configuration server is required: the fully qualified host name of the form .(e.g. hostname.example.com), the port number (default 389), the suffix, the DN and password of a user having permission to write the configuration information, usually the configuration directory administrator, and if you are using security (TLS/SSL). If you are using TLS/SSL, specify the TLS/SSL (LDAPS) port number (default 636) instead of the regular LDAP port number, and provide the CA certificate (in PEM/ASCII format).</p> <p>If you do not yet have a configuration directory server, enter 'No' to be prompted to set up one. Do you want to register this software with an existing configuration directory server? [no]: ## Press Enter ##</p> <p>============================================================================== Please enter the administrator ID for the configuration directory server. This is the ID typically used to log in to the console. You will also be prompted for the password. Configuration directory server administrator ID [admin]: ## Press Enter ## Password: ## create password ## Password (confirm): ## re-type password ##</p> <p>============================================================================== The information stored in the configuration directory server can be separated into different Administration Domains. If you are managing multiple software releases at the same time, or managing information about multiple domains, you may use the Administration Domain to keep them separate.</p> <p>If you are not using administrative domains, press Enter to select the default. Otherwise, enter some descriptive, unique name for the administration domain, such as the name of the organization responsible for managing the domain.</p> <p>Administration Domain [lofyer.org]: ## Press Enter ##</p> <p>============================================================================== The standard directory server network port number is 389. However, if you are not logged as the superuser, or port 389 is in use, the default value will be a random unused port number greater than 1024. If you want to use port 389, make sure that you are logged in as the superuser, that port 389 is not in use. Directory server network port [389]: ## Press Enter ##</p> <p>============================================================================== Each instance of a directory server requires a unique identifier. This identifier is used to name the various instance specific files and directories in the file system, as well as for other uses as a server instance identifier.</p> <p>Directory server identifier [server]: ## Press Enter ##</p> <p>============================================================================== The suffix is the root of your directory tree. The suffix must be a valid DN. It is recommended that you use the dc=domaincomponent suffix convention. For example, if your domain is example.com, you should use dc=example,dc=com for your suffix. Setup will create this initial suffix for you, but you may have more than one suffix. Use the directory server utilities to create additional suffixes.</p> <p>Suffix [dc=lofyer, dc=org]: ## Press Enter ##</p> <p>=============================================================================</p> <p>Certain directory server operations require an administrative user. This user is referred to as the Directory Manager and typically has a bind Distinguished Name (DN) of cn=Directory Manager. You will also be prompted for the password for this user. The password must be at least 8 characters long, and contain no spaces. Press Control-B or type the word "back", then Enter to back up and start over. Directory Manager DN [cn=Directory Manager]: ## Press Enter ## Password: ## Enter the password ## Password (confirm): </p> <p>============================================================================== The Administration Server is separate from any of your web or application servers since it listens to a different port and access to it is restricted.</p> <p>Pick a port number between 1024 and 65535 to run your Administration Server on. You should NOT use a port number which you plan to run a web or application server on, rather, select a number which you will remember and which will not be used for anything else. Administration port [9830]: ## Press Enter ##</p> <p>============================================================================== The interactive phase is complete. The script will now set up your servers. Enter No or go Back if you want to change something.</p> <p>Are you ready to set up your servers? [yes]: ## Press Enter ## Creating directory server . . . Your new DS instance 'server' was successfully created. Creating the configuration directory server . . . Beginning Admin Server creation . . . Creating Admin Server files and directories . . . Updating adm.conf . . . Updating admpw . . . Registering admin server with the configuration directory server . . . Updating adm.conf with information from configuration directory server . . . Updating the configuration for the httpd engine . . . Starting admin server . . . output: Starting dirsrv-admin: output: [ OK ] The admin server was successfully started. Admin server was successfully created, configured, and started. Exiting . . . Log file is '/tmp/setupo1AlDy.log' </p> <p>Then make these two services start on startup.</p> <h2 id=chkconfig-dirsrv-on><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#chkconfig-dirsrv-on>chkconfig dirsrv on</a></h2> <h2 id=chkconfig-dirsrv-admin-on><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#chkconfig-dirsrv-admin-on>chkconfig dirsrv-admin on</a></h2> <p>With 389-ds scripts, you could use 389-console, please refer to the link above.</p> <h3 id=12-manually-configure><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#12-manually-configure>1.2 Manually configure</a></h3> <p><a href=https://n40lab.wordpress.com/2013/11/22/creating-a-simple-ldap-directory-with-openldap-2-4-in-centos-6-4/ title="simple ldap">Here's the original article.</a></p> <h4 id=install-the-packages><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#install-the-packages>Install the packages</a></h4> <h2 id=yum-install-openldap-clients-servers><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#yum-install-openldap-clients-servers>yum install openldap{,-clients,-servers}</a></h2> <h4 id=change-the-configuration><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#change-the-configuration>Change the configuration</a></h4> <p><em>/etc/openldap/slapd.d/cn\=config.ldif</em> Delete <strong>olcAllows: bind_v2</strong> if you want only v3. Modify <strong>olcIdleTimeout</strong> from 0 to 30 if you want close the idle connection for more than 30 seconds.</p> <p>Before next step, run this command to generate a SHA encrypted password.</p> <h2 id=slappasswd><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#slappasswd>slappasswd</a></h2> <p>New password: Re-enter new password: {SSHA}aW7TYJ3faz13RKsnr3uiCsbgi55RKhW9</p> <p>Then copy the output to your clipboard.</p> <p><em>/etc/openldap/slapd.d/cn\=config/olcDatabase\=\{2\}bdb.ldif</em> Modify <strong>olcSuffix</strong>, <strong>RootDN</strong>, <strong>olcRootPW</strong> to this:</p> <p>... olcSuffix: dc=lofyer, dc=org olcRootPW: {SSHA}aW7TYJ3faz13RKsnr3uiCsbgi55RKhW9 RootDN: cn=admin, dc=lofyer, dc=org ...</p> <h4 id=start-service><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#start-service>Start service</a></h4> <h2 id=service-slapd-start><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#service-slapd-start>service slapd start</a></h2> <h2 id=chkconfig-slpad-on><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#chkconfig-slpad-on>chkconfig slpad on</a></h2> <h4 id=add-rootdn-and-groups><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#add-rootdn-and-groups>Add rootdn and groups</a></h4> <p>dn: dc=lofyer,dc=org objectclass: dcObject objectclass: organization o: Lofyer Org dc: lofyer</p> <p>dn: ou=People,dc=lofyer,dc=org objectClass: organizationalUnit objectClass: top ou: People</p> <p>dn: ou=Groups,dc=lofyer,dc=org objectClass: organizationalUnit objectClass: top</p> <p>ou: Groups dn: cn=admin,dc=lofyer,dc=org objectclass: organizationalRole cn: admin</p> <p>Import the ldif:</p> <h2 id=ldapadd-x-d-cnadmindclofyerdcorg-w-f-etcopenldapschemalofyerorgldif><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#ldapadd-x-d-cnadmindclofyerdcorg-w-f-etcopenldapschemalofyerorgldif>ldapadd -x -D "cn=admin,dc=lofyer,dc=org" -W -f /etc/openldap/schema/lofyer.org.ldif</a></h2> <h2 id=ldapsearch-x-b-dclofyerdcorg-objectclass><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#ldapsearch-x-b-dclofyerdcorg-objectclass>ldapsearch -x -b 'dc=lofyer,dc=org' '(objectclass=*)'</a></h2> <h4 id=create-a-user><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#create-a-user>Create a user</a></h4> <p>Add following content to <em>user.ldif</em></p> <p>dn: uid=demo,ou=People,dc=lofyer,dc=org objectclass: top objectclass: person objectclass: inetOrgPerson objectclass: organizationalPerson uid: demo cn: demo sn: demo givenName: demo</p> <p>Provide a password:</p> <h2 id=ldapadd-x-w-d-cnadmindclofyerdcorg-f-userldif><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#ldapadd-x-w-d-cnadmindclofyerdcorg-f-userldif>ldapadd -x -W -D "cn=admin,dc=lofyer,dc=org" -f user.ldif</a></h2> <p>New password: Re-enter new password: Enter LDAP Password:</p> <h4 id=add-or-delete-a-member-from-groupmyteam><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#add-or-delete-a-member-from-groupmyteam>Add or delete a member from group(myteam)</a></h4> <p><strong>Add:</strong> dn: cn=myteam,ou=Groups,dc=lofyer,dc=org changetype: modify add: member member: uid=user1,ou=People,dc=lofyer,dc=org</p> <h2 id=ldapmodify-x-d-cnadmindclofyerdcorg-w-f-addldif><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#ldapmodify-x-d-cnadmindclofyerdcorg-w-f-addldif>ldapmodify -x -D "cn=admin,dc=lofyer,dc=org" -W -f add.ldif</a></h2> <p><strong>Delete:</strong></p> <p>dn: cn=myteam,ou=Groups,dc=lofyer,dc=org changetype: modify delete: member member: uid=user1,ou=People,dc=lofyer,dc=org</p> <h2 id=ldapmodify-x-d-cnadmindclofyerdcorg-w-f-deleteldif><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#ldapmodify-x-d-cnadmindclofyerdcorg-w-f-deleteldif>ldapmodify -x -D "cn=admin,dc=lofyer,dc=org" -W -f delete.ldif</a></h2> <h3 id=use-tsl><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#use-tsl>Use TSL</a></h3> <p><a href="http://www.overclockers.com/forums/showthread.php?t=726947" title="Setup ldap">Here's the original article.</a></p> <h3 id=not-necessarygenerate-ca><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#not-necessarygenerate-ca>(NOT NECESSARY)Generate CA</a></h3> <p>Follow this script.</p> <h2 id=binbash_1><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#binbash_1>!/bin/bash</a></h2> <h2 id=change-to-the-directory-and-clear-out-the-old-certs><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#change-to-the-directory-and-clear-out-the-old-certs>Change to the directory and clear out the old certs</a></h2> <p>cd /etc/openldap/certs rm -rf *</p> <h2 id=this-echo-statement-is-actually-putting-the-word-password-without-the-quotes-in-a-temporary-password-file-to-help><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#this-echo-statement-is-actually-putting-the-word-password-without-the-quotes-in-a-temporary-password-file-to-help>This echo statement is actually putting the word “password” (without the quotes) in a temporary password file to help</a></h2> <h2 id=automate-the-process-this-will-be-the-password-for-your-certificate-change-this-as-appropriate><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#automate-the-process-this-will-be-the-password-for-your-certificate-change-this-as-appropriate>automate the process. This will be the password for your certificate. Change this as appropriate</a></h2> <p>echo "mypassword" &gt; /etc/openldap/certs/password export PATH=/usr/bin/:$PATH echo falkdjfdajkasdndwndoqndwapqmhfaksj &gt;&gt; noise.txt</p> <h2 id=associate-the-password-with-the-certificates-which-will-be-generated-in-the-current-directory><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#associate-the-password-with-the-certificates-which-will-be-generated-in-the-current-directory>Associate the password with the certificates which will be generated in the current directory</a></h2> <p>certutil -N -d . -f /etc/openldap/certs/password certutil -G -d . -z noise.txt -f /etc/openldap/certs/password</p> <h2 id=generate-a-ca-certificate-for-the-389-server><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#generate-a-ca-certificate-for-the-389-server>Generate a CA certificate for the 389 server</a></h2> <p>certutil -S -n "CA certificate" -s "cn=CACert" -x -t "CT,," -m 1000 -v 120 -d . -z /etc/openldap/certs/noise.txt -f /etc/openldap/certs/password</p> <h2 id=anwsers-are-y-y><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#anwsers-are-y-y>anwsers are Y, , Y</a></h2> <h2 id=this-builds-the-server-cert><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#this-builds-the-server-cert>This builds the server cert</a></h2> <p>certutil -S -n "OpenLDAP Server" -s "cn=ldap.lofyer.org" -c "CA certificate" -t "u,u,u" -m 1001 -v 120 -d . -z /etc/openldap/certs/noise.txt -f /etc/openldap/certs/password</p> <h2 id=this-exports-the-cacert-in-case-you-need-it><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#this-exports-the-cacert-in-case-you-need-it>This exports the cacert in case you need it</a></h2> <p>pk12util -d . -o cacert.p12 -n "CA certificate"</p> <h2 id=this-exports-the-server-cert-which-you-will-need-on-the-windows-ad><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#this-exports-the-server-cert-which-you-will-need-on-the-windows-ad>This exports the server-cert which you will need on the windows AD</a></h2> <p>pk12util -d . -o servercert.p12 -n "OpenLDAP Server"</p> <h2 id=this-exports-the-ca-cert-for-ldap-clients><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#this-exports-the-ca-cert-for-ldap-clients>This exports the CA cert for ldap clients</a></h2> <p>certutil -L -d . -n "CA certificate" -a &gt; /etc/openldap/certs/cacert.pem</p> <h2 id=make-the-files-in-here-readable><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#make-the-files-in-here-readable>Make the files in here readable</a></h2> <p>chmod 644 *</p> <h2 id=set-the-system-to-use-ldaps><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#set-the-system-to-use-ldaps>Set the system to use LDAPS</a></h2> <p>sed -i 's/SLAPD_LDAPS=no/SLAPD_LDAPS=yes/g' /etc/sysconfig/ldap</p> <h2 id=add-a-firewall-exception-in-case-the-user-has-not-configured-their-firewall-properly><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#add-a-firewall-exception-in-case-the-user-has-not-configured-their-firewall-properly>Add a firewall exception in case the user has not configured their firewall properly</a></h2> <h2 id=iptables-i-input-m-state-state-new-p-tcp-dport-636-j-accept><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#iptables-i-input-m-state-state-new-p-tcp-dport-636-j-accept>iptables -I INPUT -m state --state NEW -p tcp --dport 636 -j ACCEPT</a></h2> <h2 id=etcinitdiptables-save><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#etcinitdiptables-save>/etc/init.d/iptables save</a></h2> <h2 id=restart-slapd-to-make-the-changes-take-effect><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#restart-slapd-to-make-the-changes-take-effect>Restart slapd to make the changes take effect</a></h2> <h2 id=etcinitdslapd-restart><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#etcinitdslapd-restart>/etc/init.d/slapd restart</a></h2> <p>I think you should notice that the private key password is "mypassword". Then you will get three files: <strong>cacert.p12</strong>, <strong>cacert.pem</strong>, <strong>servercert.p12</strong>. And, that's all.</p> <h2 id=2-add-sasl-to-openldap><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#2-add-sasl-to-openldap>2. Add SASL to OpenLDAP</a></h2> <p>OKay, we'll add SASL to our ldap connections.</p> <h3 id=install-cyrus-sasl-package><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#install-cyrus-sasl-package>Install cyrus-sasl package.</a></h3> <h2 id=yum-install-cyrus-sasl-gssapi><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#yum-install-cyrus-sasl-gssapi>yum install cyrus-sasl-gssapi</a></h2> <h2 id=yum-install-cyrus-sasl-ldap><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#yum-install-cyrus-sasl-ldap>yum install cyrus-sasl-ldap</a></h2> <hr> <p>title: "owncloud webdav intergration" date: 2013-01-03 categories: - "linux-admin"</p> <hr> <p>安装好owncloud后，可以使用webdav协议进行远程挂载，比如</p> <p>mount -t davfs {http://localhost/remote.php/webdav,http://localhost/files/webdav.php} /mnt</p> <p>2003上需启动webclient服务 而在2008上, webclient被集成到desktop experience组件中, 从service manager-&gt;feature中添加desktop experience,并且修改注册表HKEY_LOCAL_MACHINE-&gt;SYSTEM-&gt;CurrentControlSet-&gt;Services-&gt;WebClient-&gt;Parameters-&gt;BasicAuthLevel 的值为 2，重启服务 此时可映射网络驱动器，钩选“connect using different credentials”，输入其用户名密码即可 或者命令行</p> <p>NET USE * http://localhost/remote.php/webdav 123456 /user:admin</p> <h3 id=ps-1-owncloudapp-webdev-2-owncloudapacheapachewww-datawww-datahtaccesss><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#ps-1-owncloudapp-webdev-2-owncloudapacheapachewww-datawww-datahtaccesss>PS： 1. owncloud第三方app WebDev安装后会造成不能添加用户的麻烦 2. 修改owncloud目录权限为apache.apache或者www-data.www-data以使.htaccesss生效</a></h3> <p>title: "Using X server in Windows Linux Subsystem" date: 2016-10-09 categories: - "linux-admin"</p> <hr> <p>1. Turn on "Developer Mode" in Control panel. <a href=http://blog.lofyer.org/wp-content/uploads/developer-mode.png><img alt=developer-mode src=/blog/images/developer-mode.png></a> <a href=http://blog.lofyer.org/wp-content/uploads/sss.png><img alt=sss src=/blog/images/sss.png></a></p> <p>2. Run "bash" <a href=http://blog.lofyer.org/wp-content/uploads/bash.png><img alt=bash src=/blog/images/bash.png></a></p> <p>3. Install Xming(Xserver for Windows) <a href=https://sourceforge.net/projects/xming/ >Download</a></p> <p>4. Launch your app</p> <h2 id=export-display0><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#export-display0>export DISPLAY=:0</a></h2> <h2 id=firefox><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#firefox>firefox</a></h2> <p><a href=http://blog.lofyer.org/wp-content/uploads/launch.png><img alt=launch src=/blog/images/launch.png></a></p> <p>5. You can create a link on your desktop like this <a href=http://blog.lofyer.org/wp-content/uploads/aaa.png><img alt=aaa src=/blog/images/aaa.png></a></p> <p>and ~/.bashrc</p> <p>alias home='cd /mnt/c/Users/rex/Desktop' home export DISPLAY=:0</p> <p>Tips:</p> <h3 id=use-powershell-bash-instead-of-bash-you-can-access-your-service-in-this-way><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#use-powershell-bash-instead-of-bash-you-can-access-your-service-in-this-way>Use "powershell bash" instead of "bash", you can access your service in this way.</a></h3> <p>title: "Configure corosync and pacemaker" date: 2015-02-28 categories: - "linux-admin"</p> <hr> <p>Env: node1 eth0 192.168.0.201 node2 eth0 192.168.0.202</p> <h3 id=1-install-essential-packages><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#1-install-essential-packages>1. Install essential packages</a></h3> <p>Add following content to <em>/etc/yum.repos.d/ha.repo</em>, since you will need crmsh later:</p> <p>[haclustering] name=HA Clustering baseurl=http://download.opensuse.org/repositories/network:/ha-clustering:/Stable/CentOS_CentOS-6/ enabled=1 gpgcheck=0</p> <p>Install packages:</p> <h2 id=yum-install-pacemaker-corosync-crmsh-y><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#yum-install-pacemaker-corosync-crmsh-y>yum install pacemaker corosync crmsh -y</a></h2> <h3 id=2-configure-corosync><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#2-configure-corosync>2. Configure corosync</a></h3> <p>Using configuration files below if you need broadcast:</p> <p>service { # Load the Pacemaker Cluster Resource Manager ver: 0 name: pacemaker use_mgmtd: no use_logd: no }</p> <p>totem { version: 2 secauth: off interface { member { memberaddr: 192.168.0.201 } member { memberaddr: 192.168.0.202 } ringnumber: 0 bindnetaddr: 192.168.0.0 mcastport: 5405 ttl: 1 } transport: udpu }</p> <p>logging { fileline: off to_logfile: yes to_syslog: yes logfile: /var/log/cluster/corosync.log debug: off timestamp: on logger_subsys { subsys: AMF debug: off } }</p> <p>Here's a sample using multicast:</p> <p>service { # Load the Pacemaker Cluster Resource Manager ver: 0 name: pacemaker use_mgmtd: no use_logd: no }</p> <p>totem { version: 2</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span></pre></div></td><td class=code><div><pre><span></span><code>    # secauth: Enable mutual node authentication. If you choose to
    # enable this (&quot;on&quot;), then do remember to create a shared
    # secret with &quot;corosync-keygen&quot;.
    secauth: off

    threads: 0

    # interface: define at least one interface to communicate
    # over. If you define more than one interface stanza, you must
    # also set rrp\_mode.
    interface {
            ringnumber: 0
            bindnetaddr: 192.168.1.0
            mcastaddr: 239.255.1.1
            mcastport: 5405
            ttl: 1
    }
</code></pre></div></td></tr></table></div> <p>}</p> <p>logging { fileline: off to_stderr: no to_logfile: yes logfile: /var/log/cluster/corosync.log to_syslog: yes debug: off timestamp: on logger_subsys { subsys: AMF debug: off } }</p> <p>Note that if the <strong>ver</strong> in the <strong>service</strong> section of pacemaker is <strong>0</strong>, pacemaker will be loaded automatically, or else you will start the pacemaker service manually.</p> <p>Copy this configuration file to the other host and start the service:</p> <h2 id=scp-etccorosynccorosyncconf-root1921680202etccorosynccorosyncconf><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#scp-etccorosynccorosyncconf-root1921680202etccorosynccorosyncconf>scp /etc/corosync/corosync.conf root@192.168.0.202:/etc/corosync/corosync.conf</a></h2> <p>On 192.168.0.201:</p> <h2 id=chkconfig-corosync-on><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#chkconfig-corosync-on>chkconfig corosync on</a></h2> <h2 id=service-corosync-start><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#service-corosync-start>service corosync start</a></h2> <p>On 192.168.0.202:</p> <h2 id=chkconfig-corosync-on_1><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#chkconfig-corosync-on_1>chkconfig corosync on</a></h2> <h2 id=service-corosync-start_1><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#service-corosync-start_1>service corosync start</a></h2> <h3 id=3-configure-corosync-using-crmsh><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#3-configure-corosync-using-crmsh>3. Configure corosync using crmsh</a></h3> <p>Add virtual IP to your cluster:</p> <h2 id=crm-configure><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#crm-configure>crm configure</a></h2> <p>crm(live)configure# primitive vip1 ocf<img alt=💓 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f493.svg title=:heartbeat:>IPaddr2 params ip=192.168.0.209 cidr_netmask=24 op monitor interval=10s crm(live)configure# property stonith-enabled=false # To prevent split-brain crm(live)configure# property no-quorum-policy=stop # To prevent split-brain crm(live)configure# commit</p> <p>Test:</p> <p>crm(live)configure# migrate vip1 crm(live)configure# unmigrate vip1</p> <h3 id=you-will-see-1921680209-migrating-between-these-two-nodes><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#you-will-see-1921680209-migrating-between-these-two-nodes>You will see 192.168.0.209 migrating between these two nodes.</a></h3> <p>title: "Deploy Skype for Business Server 2015" date: 2015-08-12 categories: - "cloud-infra"</p> <hr> <h2 id=server-preparation><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#server-preparation>Server Preparation</a></h2> <p>ad(ad.virtfan.com): Windows Server 2012 R2 lync(lync.virtfan.com): Windows Server 2012 R2 Following instruction is for <strong>LAN</strong>.</p> <p>Ref: <a href=https://technet.microsoft.com/en-us/library/dn933900.aspx>https://technet.microsoft.com/en-us/library/dn933900.aspx</a> <a href=http://lync.community.ge/post/2012/07/18/Install-Lync-2013-in-windows-server-2008-r2-(Part-1).aspx>Install lync 2013 server in win2008r2</a></p> <h2 id=procedure><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#procedure>Procedure</a></h2> <p>1. After a fresh installation of Windows Server 2012 R2, we will <strong>update</strong> it to latest. 2. We need create an AD DS with AD CS in ad.virtfan.com. So that we can retrieve CA to complete our deployment. 3. Then we start setting up Skype Server in lync.virtfan.com(in domain virtfan.com). 4. Set up DNS, add more users, use lync to communicate.</p> <h3 id=ad-preparation><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#ad-preparation>AD Preparation</a></h3> <p>Following steps are in ad.virtfan.com. 1. Assign a static IP. Change computer name to ad. <a href=http://blog.lofyer.org/deploy-skype-for-business-server-2015/%e5%b1%8f%e5%b9%95%e5%bf%ab%e7%85%a7-2015-08-13-%e4%b8%8a%e5%8d%8811-42-27/ ><img alt="屏幕快照 2015-08-13 上午11.42.27" src=/blog/images/屏幕快照-2015-08-13-上午11.42.27-1024x632.png></a> 2. Add Active Directory Domain Service and DNS Roles. Create a new forest(virtfan.com) with level Windows 2008 R2. <a href=http://blog.lofyer.org/deploy-skype-for-business-server-2015/%e5%b1%8f%e5%b9%95%e5%bf%ab%e7%85%a7-2015-08-13-%e4%b8%8a%e5%8d%8811-59-27/ ><img alt="屏幕快照 2015-08-13 上午11.59.27" src=/blog/images/屏幕快照-2015-08-13-上午11.59.27-300x172.png></a> 3. Add Active Directory Certificate Service Role with all the six features checked. <a href=http://blog.lofyer.org/deploy-skype-for-business-server-2015/%e5%b1%8f%e5%b9%95%e5%bf%ab%e7%85%a7-2015-08-13-%e4%b8%8b%e5%8d%8812-07-28/ ><img alt="屏幕快照 2015-08-13 下午12.07.28" src=/blog/images/屏幕快照-2015-08-13-下午12.07.28-300x128.png></a> 4. (Optional)Run gpmc.msc, right click on the Default Domain Policy to edit. Change Password Complexity to False. Run gpupdate /force to update the group policy. <a href=http://blog.lofyer.org/deploy-skype-for-business-server-2015/%e5%b1%8f%e5%b9%95%e5%bf%ab%e7%85%a7-2015-08-13-%e4%b8%8b%e5%8d%8812-15-33/ ><img alt="屏幕快照 2015-08-13 下午12.15.33" src=/blog/images/屏幕快照-2015-08-13-下午12.15.33-1024x543.png></a></p> <h3 id=skype-server-preparation><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#skype-server-preparation>Skype Server Preparation</a></h3> <p>Following steps are in lync.virtfan.com. <strong>Make sure you have got more than 32GB space in C:</strong>. 1. Assign a static IP, change name to lync and join domain virtfan.com. Add following features: <em>.Net Framework 3.5, .Net Framework 4.5 -&gt; WCF Services -&gt; HTTP Activation, Media Foundation, Remote Server Administration Tools -&gt; Role Administration Tools -&gt; AD DS and AD LDS Tools -&gt; Windows Identity Foundation 3.5</em> 2. Add IIS Role with following features: <em>静态内容、默认文档、HTTP 错误、ASP.NET、.NET 扩展性、Internet 服务器 API (ISAPI)扩展、ISAPI 筛选器、HTTP 日志记录、日志记录工具、跟踪、客户端证书映射身份验证、Windows 身份验证、请求筛选、静态内容压缩、动态内容压缩、IIS 管理控制台、IIS 管理脚本和工具</em> 3. <strong>Logon as VIRTFAN\Administrator</strong> and add feature .Net3.5. 4. Install KB2982006. 5. Mount Skype Business 2015 ISO and run Setup to install.</p> <h3 id=setting-up-skype-server><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#setting-up-skype-server>Setting up Skype Server</a></h3> <p>Following steps are in lync.virtfan.com and logon as VIRTFAN\Administrator and add feature .Net3.5. 1. Create a directory in C:\share, make it sharable and writable. 2. Run Skype for Business Server 部署向导(Deploy Wizard) from Start menu. <a href=http://blog.lofyer.org/deploy-skype-for-business-server-2015/%e5%b1%8f%e5%b9%95%e5%bf%ab%e7%85%a7-2015-08-13-%e4%b8%8b%e5%8d%881-47-56/ ><img alt="屏幕快照 2015-08-13 下午1.47.56" src=/blog/images/屏幕快照-2015-08-13-下午1.47.56.png></a> 3. Then we will are going to follow the steps in Prepare Active Directory. <a href=http://blog.lofyer.org/deploy-skype-for-business-server-2015/%e5%b1%8f%e5%b9%95%e5%bf%ab%e7%85%a7-2015-08-13-%e4%b8%8b%e5%8d%881-51-16/ ><img alt="屏幕快照 2015-08-13 下午1.51.16" src=/blog/images/屏幕快照-2015-08-13-下午1.51.16.png></a> 4. Click Prepare the first Standard Edition Server. It will create database. 5. Install management utilities. 6. Run Skype for Business Server topology generator from Start menu to generate a topology. <a href=http://blog.lofyer.org/deploy-skype-for-business-server-2015/%e5%b1%8f%e5%b9%95%e5%bf%ab%e7%85%a7-2015-08-13-%e4%b8%8b%e5%8d%882-31-16/ ><img alt="屏幕快照 2015-08-13 下午2.31.16" src=/blog/images/屏幕快照-2015-08-13-下午2.31.16.png></a> 7. Create a new topology like this: <a href=http://blog.lofyer.org/deploy-skype-for-business-server-2015/%e5%b1%8f%e5%b9%95%e5%bf%ab%e7%85%a7-2015-08-13-%e4%b8%8b%e5%8d%882-37-53/ ><img alt="屏幕快照 2015-08-13 下午2.37.53" src=/blog/images/屏幕快照-2015-08-13-下午2.37.53.png></a> <a href=http://blog.lofyer.org/deploy-skype-for-business-server-2015/%e5%b1%8f%e5%b9%95%e5%bf%ab%e7%85%a7-2015-08-13-%e4%b8%8b%e5%8d%882-38-07/ ><img alt="屏幕快照 2015-08-13 下午2.38.07" src=/blog/images/屏幕快照-2015-08-13-下午2.38.07.png></a> <a href=http://blog.lofyer.org/deploy-skype-for-business-server-2015/%e5%b1%8f%e5%b9%95%e5%bf%ab%e7%85%a7-2015-08-13-%e4%b8%8b%e5%8d%882-39-23/ ><img alt="屏幕快照 2015-08-13 下午2.39.23" src=/blog/images/屏幕快照-2015-08-13-下午2.39.23.png></a> <a href=http://blog.lofyer.org/deploy-skype-for-business-server-2015/%e5%b1%8f%e5%b9%95%e5%bf%ab%e7%85%a7-2015-08-13-%e4%b8%8b%e5%8d%882-40-04/ ><img alt="屏幕快照 2015-08-13 下午2.40.04" src=/blog/images/屏幕快照-2015-08-13-下午2.40.04.png></a> <a href=http://blog.lofyer.org/deploy-skype-for-business-server-2015/%e5%b1%8f%e5%b9%95%e5%bf%ab%e7%85%a7-2015-08-13-%e4%b8%8b%e5%8d%882-40-47/ ><img alt="屏幕快照 2015-08-13 下午2.40.47" src=/blog/images/屏幕快照-2015-08-13-下午2.40.47.png></a> <a href=http://blog.lofyer.org/deploy-skype-for-business-server-2015/%e5%b1%8f%e5%b9%95%e5%bf%ab%e7%85%a7-2015-08-13-%e4%b8%8b%e5%8d%882-41-15/ ><img alt="屏幕快照 2015-08-13 下午2.41.15" src=/blog/images/屏幕快照-2015-08-13-下午2.41.15.png></a> <a href=http://blog.lofyer.org/deploy-skype-for-business-server-2015/%e5%b1%8f%e5%b9%95%e5%bf%ab%e7%85%a7-2015-08-13-%e4%b8%8b%e5%8d%882-41-44/ ><img alt="屏幕快照 2015-08-13 下午2.41.44" src=/blog/images/屏幕快照-2015-08-13-下午2.41.44.png></a> <a href=http://blog.lofyer.org/deploy-skype-for-business-server-2015/%e5%b1%8f%e5%b9%95%e5%bf%ab%e7%85%a7-2015-08-13-%e4%b8%8b%e5%8d%882-42-14/ ><img alt="屏幕快照 2015-08-13 下午2.42.14" src=/blog/images/屏幕快照-2015-08-13-下午2.42.14.png></a> <a href=http://blog.lofyer.org/deploy-skype-for-business-server-2015/%e5%b1%8f%e5%b9%95%e5%bf%ab%e7%85%a7-2015-08-13-%e4%b8%8b%e5%8d%882-42-49/ ><img alt="屏幕快照 2015-08-13 下午2.42.49" src=/blog/images/屏幕快照-2015-08-13-下午2.42.49.png></a> <a href=http://blog.lofyer.org/deploy-skype-for-business-server-2015/%e5%b1%8f%e5%b9%95%e5%bf%ab%e7%85%a7-2015-08-13-%e4%b8%8b%e5%8d%882-43-32/ ><img alt="屏幕快照 2015-08-13 下午2.43.32" src=/blog/images/屏幕快照-2015-08-13-下午2.43.32.png></a> <a href=http://blog.lofyer.org/deploy-skype-for-business-server-2015/%e5%b1%8f%e5%b9%95%e5%bf%ab%e7%85%a7-2015-08-13-%e4%b8%8b%e5%8d%882-43-58/ ><img alt="屏幕快照 2015-08-13 下午2.43.58" src=/blog/images/屏幕快照-2015-08-13-下午2.43.58.png></a> <a href=http://blog.lofyer.org/deploy-skype-for-business-server-2015/%e5%b1%8f%e5%b9%95%e5%bf%ab%e7%85%a7-2015-08-13-%e4%b8%8b%e5%8d%882-44-27/ ><img alt="屏幕快照 2015-08-13 下午2.44.27" src=/blog/images/屏幕快照-2015-08-13-下午2.44.27.png></a> Click Finish and right click on the Skype for Business Server to edit property. Fill in the admin url like: <em>https://admin.virtfan.com</em> Select a fronted server as central server. <a href=http://blog.lofyer.org/deploy-skype-for-business-server-2015/%e5%b1%8f%e5%b9%95%e5%bf%ab%e7%85%a7-2015-08-13-%e4%b8%8b%e5%8d%882-46-44/ ><img alt="屏幕快照 2015-08-13 下午2.46.44" src=/blog/images/屏幕快照-2015-08-13-下午2.46.44.png></a> 8. Publish topology. 9. Click Install or update Skype for Business Server System. And follow its guide. <a href=http://blog.lofyer.org/deploy-skype-for-business-server-2015/%e5%b1%8f%e5%b9%95%e5%bf%ab%e7%85%a7-2015-08-13-%e4%b8%8b%e5%8d%882-52-18/ ><img alt="屏幕快照 2015-08-13 下午2.52.18" src=/blog/images/屏幕快照-2015-08-13-下午2.52.18.png></a> 10. When you are in Step.3(Assign Certificate). Click Request to request certificate from ad.virtfan.com. <a href=http://blog.lofyer.org/deploy-skype-for-business-server-2015/%e5%b1%8f%e5%b9%95%e5%bf%ab%e7%85%a7-2015-08-13-%e4%b8%8b%e5%8d%882-53-49/ ><img alt="屏幕快照 2015-08-13 下午2.53.49" src=/blog/images/屏幕快照-2015-08-13-下午2.53.49.png></a> <a href=http://blog.lofyer.org/deploy-skype-for-business-server-2015/%e5%b1%8f%e5%b9%95%e5%bf%ab%e7%85%a7-2015-08-13-%e4%b8%8b%e5%8d%882-54-39/ ><img alt="屏幕快照 2015-08-13 下午2.54.39" src=/blog/images/屏幕快照-2015-08-13-下午2.54.39.png></a> <a href=http://blog.lofyer.org/deploy-skype-for-business-server-2015/%e5%b1%8f%e5%b9%95%e5%bf%ab%e7%85%a7-2015-08-13-%e4%b8%8b%e5%8d%882-54-39/ ><img alt="屏幕快照 2015-08-13 下午2.54.39" src=/blog/images/屏幕快照-2015-08-13-下午2.54.39.png></a> 11. Run start-cspool from cmd to start the server. Warning is OK, error is not OK. 12. Define your DNS and port-forwarding(443) so that we can use Skype from WAN.</p> <p>https://meet.virtfan.com -&gt; lync.virtfan.com's IP https://lync.virtfan.com -&gt; lync.virtfan.com's IP https://dialin.virtfan.com -&gt; lync.virtfan.com's IP https://admin.virtfan.com -&gt; lync.virtfan.com's IP (optional)https://ad.virtfan.com -&gt; ad.virtfan.com's IP</p> <p>13. Add domain users and assign users via https://admin.virtfan.com. <a href=http://blog.lofyer.org/deploy-skype-for-business-server-2015/%e5%b1%8f%e5%b9%95%e5%bf%ab%e7%85%a7-2015-08-13-%e4%b8%8b%e5%8d%883-10-58/ ><img alt="屏幕快照 2015-08-13 下午3.10.58" src=/blog/images/屏幕快照-2015-08-13-下午3.10.58-1024x538.png></a></p> <h2 id=lyncskype-client><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#lyncskype-client>Lync/Skype Client</a></h2> <p>1. Install Lync/Skype within Microsoft Office 2013 or Office365. 2. Download and install CA from https://ad.virtfan.com/certsrv/ or you can put it somewhere else. 3. Configure your client like this: <a href=http://blog.lofyer.org/deploy-skype-for-business-server-2015/lync/ ><img alt=lync src=/blog/images/lync.png></a> 4. Click Logon.</p> <p>Here you go!</p> <h2 id=wan><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#wan>WAN</a></h2> <p>If you are using servers behind a firewall or a router, you should add something like this. 1. On your DNS provider, set these 6 A records lync/admin/dialin/meet/lyncdiscover/lyncdiscoverinternal.virtfan.com to your WAN IP. 2. Port forward from 443,5601 to lync server LAN IP. (Alternative)2. If you are using Apache virtualhost, you'll need export certificate and its private key of lync.virtfan.com to the Apache server with <a href=https://github.com/iSECPartners/jailbreak-Windows.git>jailbreak</a> and configure all 6 domain names like this:</p> <h2 id=vi-apacheconfdsslconf><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#vi-apacheconfdsslconf>vi /apache/conf.d/ssl.conf</a></h2> <p>... <virtualhost \*:443> ServerName skype.virtfan.com SSLEngine on SSLProxyEngine on SSLCertificateFile /etc/httpd/conf.d/lync-ca/lync.virtfan.com.cer SSLCertificateKeyFile /etc/httpd/conf.d/lync-ca/lync.virtfan.com.key ProxyRequests Off ProxyPass / https://skype.virtfan.com/ ProxyPassReverse / https://skype.virtfan.com/ </virtualhost> ...</p> <h2 id=vi-etchttpdconfdvproxyconf><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#vi-etchttpdconfdvproxyconf>vi /etc/httpd/conf.d/vproxy.conf</a></h2> <p><virtualhost \*:80> ServerName lyncdiscover.virtfan.com ProxyRequests Off ProxyPass / http://lyncdiscover.virtfan.com/ ProxyPassReverse / http://lyncdiscover.virtfan.com/ </virtualhost></p> <p><virtualhost \*:80> ServerName lyncdiscoverinternal.virtfan.com ProxyRequests Off ProxyPass / http://lyncdiscoverinternal.virtfan.com/ ProxyPassReverse / http://lyncdiscoverinternal.virtfan.com/ </virtualhost></p> <h2 id=vi-etchosts><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#vi-etchosts>vi /etc/hosts</a></h2> <p>... 192.168.122.222 admin.virtfan.com 192.168.122.222 lync.virtfan.com 192.168.122.222 dialin.virtfan.com 192.168.122.222 skype.virtfan.com 192.168.122.222 meet.virtfan.com 192.168.122.222 lyncdiscover.virtfan.com 192.168.122.222 lyncdiscoverinternal.virtfan.com ...</p> <p>And configure iptables:</p> <h2 id=iptables-t-nat-a-prerouting-p-tcp-dport-5061-j-dnat-to-destination-1921681222225061><a class=toclink href=../../../../2014/02/10/deploy-asterisk-on-centos/#iptables-t-nat-a-prerouting-p-tcp-dport-5061-j-dnat-to-destination-1921681222225061>iptables -t nat -A PREROUTING -p tcp --dport 5061 -j DNAT --to-destination 192.168.122.222:5061</a></h2> <p>3. DO NOT ADD "Internal Server" in your lync client, "External Server" will be enough.</p> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2013-05-03 00:00:00">2013年5月3日</time></li> <li class=md-meta__item> 分类于 <a href=../../ class=md-meta__link>cloud-infra</a></li> <li class=md-meta__item> 需要 1 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=kvmmybox><a href=../../../../2013/05/03/%E8%AE%BE%E8%AE%A1kvm%E5%89%8D%E7%AB%AFmybox/ class=toclink>设计，kvm前端，mybox</a></h2> <p>正好趁现在有设计欲的时候给自己的git服务器换个首页。 kvm前端的脚本已完成，瞬间不想写gui的了，虽然ncurses很好用。。要不先这样，反正都是用来调virt和spice的系统</p> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2012-10-18 00:00:00">2012年10月18日</time></li> <li class=md-meta__item> 分类于 <a href=../../ class=md-meta__link>cloud-infra</a></li> <li class=md-meta__item> 需要 5 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=ovirt><a href=../../../../2012/10/18/ovirt-notes/ class=toclink>oVirt相关</a></h2> <p>Ovirt Just make some notes: # need net qemu-kvm -m 1024 -localtime -M pc -smp 2 -drive file=ovirt.qcow2,cache=writeback,boot=on -boot d -name kvm-ovirt,process=ovirt -usb -usbdevice tablet Ovirt provided a fedora.iso with node in it. Ao is building the engine.</p> <h2 id=on-virtfan-spicec-h-localhost-p-5910><a class=toclink href=../../../../2012/10/18/ovirt-notes/#on-virtfan-spicec-h-localhost-p-5910>on virtfan spicec -h localhost -p 5910</a></h2> <p>node应该是自动加入engine的，结果是现在能加入，但是不能安装 nmap后engine确实是有8443，node只有22，安装过程是交互的（node通过外网获取安装包，返回状态到engine）</p> <p>改变端口为443，按照troubleshooting更改engine上的nfs服务。f17上nfs默认建立服务为v4，要改为v3，并且添加group和user id分别为36的vdsm与kvm，用提供的脚本测试下。 <a href=http://wiki.ovirt.org/wiki/Troubleshooting_NFS_Storage_Issues title="fix the nfs">Troubleshooting_NFS_Storage_Issues</a></p> <p>ok，等明天加入节点就可以了。</p> <p>Building ovirt from source <a href=http://wiki.ovirt.org/wiki/Building_oVirt_engine title="with cmdline">with cmdline</a> <a href=http://wiki.ovirt.org/wiki/Building_Ovirt_Engine/IDE title="within an ide">within an ide</a> <a href=https://community.jboss.org/en/tools/blog/2011/02/21/getting-started-with-jboss-tools-jboss-maven-integration-and-weld title="install jboss maven plugin on eclipse">install jboss maven plugin on eclipse</a></p> <p>here's the engine arch <a href=http://69.164.197.168/wp-content/uploads/2012/10/Engine-arch.png><img alt src=/blog/images/Engine-arch.png title=Engine-arch></a></p> <p>and here's the engine-core arch <a href=http://69.164.197.168/wp-content/uploads/2012/10/Engine-arch2.png><img alt src=/blog/images/Engine-arch2.png title=Engine-arch2></a></p> <h3 id=engine-manage-domainipa-serverwindowsactivedirectoryengineipa-ipa-server><a class=toclink href=../../../../2012/10/18/ovirt-notes/#engine-manage-domainipa-serverwindowsactivedirectoryengineipa-ipa-server>运行engine-manage-domain需要ipa-server，类似windows的ActiveDirectory，需要不同于engine的主机上安装ipa <a href=http://blog.jaurola.fi/2011/12/28/implementing-ipa-server-with-windowslinux-environment title=ipa-server>安装ipa-server</a></a></h3> <p>title: "Add nat to ovirt via vdsm hooks" date: 2014-05-04 categories: - "cloud-infra"</p> <hr> <p>OK, I do not like control group very much for now.</p> <h3 id=comment-device-section-in-control-group-config-sorry-for-my-laziness><a class=toclink href=../../../../2012/10/18/ovirt-notes/#comment-device-section-in-control-group-config-sorry-for-my-laziness>Comment device section in control group config, sorry for my laziness...</a></h3> <p>mount { cpuset = /cgroup/cpuset; cpu = /cgroup/cpu; cpuacct = /cgroup/cpuacct; memory = /cgroup/memory;</p> <h2 id=devices-cgroupdevices><a class=toclink href=../../../../2012/10/18/ovirt-notes/#devices-cgroupdevices>devices = /cgroup/devices;</a></h2> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code>    freezer = /cgroup/freezer;
</code></pre></div></td></tr></table></div> <h2 id=net_cls-cgroupnet_cls><a class=toclink href=../../../../2012/10/18/ovirt-notes/#net_cls-cgroupnet_cls>net_cls = /cgroup/net_cls;</a></h2> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code>    blkio   = /cgroup/blkio;
</code></pre></div></td></tr></table></div> <p>}</p> <h3 id=enable-ip-forward><a class=toclink href=../../../../2012/10/18/ovirt-notes/#enable-ip-forward>Enable ip forward</a></h3> <p>net.ipv4.ip_forward = 1</p> <p><strong>Reboot the host</strong></p> <h3 id=connect-to-virsh-to-enable-libvirts-default-virbr0nat><a class=toclink href=../../../../2012/10/18/ovirt-notes/#connect-to-virsh-to-enable-libvirts-default-virbr0nat>Connect to virsh to enable libvirt's default virbr0(NAT)</a></h3> <p>If you don't know the password for your account, just use command below to create one.</p> <h2 id=saslpasswd2-a-libvirt-root><a class=toclink href=../../../../2012/10/18/ovirt-notes/#saslpasswd2-a-libvirt-root>saslpasswd2 -a libvirt root</a></h2> <p>Create a nat network.</p> <p>nat b42e377d-e849-4c36-bd98-3d090def5ecc </p> <h2 id=virsh-net-create-etclibvirtqemunetworksnatxml><a class=toclink href=../../../../2012/10/18/ovirt-notes/#virsh-net-create-etclibvirtqemunetworksnatxml>virsh net-create /etc/libvirt/qemu/networks/nat.xml</a></h2> <h2 id=virsh-net-autostart-nat><a class=toclink href=../../../../2012/10/18/ovirt-notes/#virsh-net-autostart-nat>virsh net-autostart nat</a></h2> <h2 id=virsh-net-start-nat><a class=toclink href=../../../../2012/10/18/ovirt-notes/#virsh-net-start-nat>virsh net-start nat</a></h2> <h3 id=create-tun-device-and-add-it-to-virbr0><a class=toclink href=../../../../2012/10/18/ovirt-notes/#create-tun-device-and-add-it-to-virbr0>Create tun device and add it to virbr0</a></h3> <p><strong>UPDATE: This could be ignored if you use extnet.py</strong></p> <h2 id=tunctl-t-nat0-u-qemu><a class=toclink href=../../../../2012/10/18/ovirt-notes/#tunctl-t-nat0-u-qemu>tunctl -t nat0 -u qemu</a></h2> <h2 id=brctl-addif-virbr1-nat0><a class=toclink href=../../../../2012/10/18/ovirt-notes/#brctl-addif-virbr1-nat0>brctl addif virbr1 nat0</a></h2> <h3 id=add-hook-file-to-vdsm><a class=toclink href=../../../../2012/10/18/ovirt-notes/#add-hook-file-to-vdsm>Add hook file to vdsm</a></h3> <p><strong>UPDATE: use extnet from github with a little modification (Only the first vNIC will be NAT, the second one still keeps its way).</strong></p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span></pre></div></td><td class=code><div><pre><span></span><code>#!/usr/bin/python

import os
import sys
import traceback
import xml.dom
import hooking

def replaceSource(interface, newnet):
    source, = interface.getElementsByTagName(&#39;source&#39;)
    source.removeAttribute(&#39;bridge&#39;)
    source.setAttribute(&#39;network&#39;, newnet)
    interface.setAttribute(&#39;type&#39;, &#39;network&#39;)

def main():
    params = &quot;default&quot;
    os.environ.\_\_setitem\_\_(&quot;extnet&quot;,params)
    newnet = os.environ.get(&#39;extnet&#39;)
    if newnet is not None:
        doc = hooking.read\_domxml()
        interface = doc.getElementsByTagName(&#39;interface&#39;)[0]
        replaceSource(interface, newnet)
        hooking.write\_domxml(doc)
def test():

    interface = xml.dom.minidom.parseString(&quot;&quot;&quot;
    &quot;&quot;&quot;).getElementsByTagName(&#39;interface&#39;)[0]

    print &quot;Interface before forcing network: %s&quot; % \\
        interface.toxml(encoding=&#39;UTF-8&#39;)

    replaceSource(interface, &#39;yipee&#39;)
    print &quot;Interface after forcing network: %s&quot; % \\
        interface.toxml(encoding=&#39;UTF-8&#39;)

if \_\_name\_\_ == &#39;\_\_main\_\_&#39;:
    try:
        if &#39;--test&#39; in sys.argv:
            test()
        else:
            main()
    except:
        hooking.exit\_hook(&#39;extnet hook: [unexpected error]: %s\\n&#39; %
                          traceback.format\_exc()) 
</code></pre></div></td></tr></table></div> <p><strong>QEMU-CMD way:</strong></p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span></pre></div></td><td class=code><div><pre><span></span><code>import os
import sys
import hooking
import traceback
import json
import shutil

def addQemuNs(domXML):
    domain = domXML.getElementsByTagName(&#39;domain&#39;)[0]
    domain.setAttribute(&#39;xmlns:qemu&#39;,
                        &#39;http://libvirt.org/schemas/domain/qemu/1.0&#39;)

def injectQemuCmdLine(domXML, qc):
    domain = domXML.getElementsByTagName(&#39;domain&#39;)[0]
    qctag = domXML.createElement(&#39;qemu:commandline&#39;)

    for cmd in qc:
        qatag = domXML.createElement(&#39;qemu:arg&#39;)
        qatag.setAttribute(&#39;value&#39;, cmd)

        qctag.appendChild(qatag)

    domain.appendChild(qctag)
domxml = hooking.read\_domxml()

# Get vm uuid, just in case

cur\_vm\_uuid = domxml.getElementsByTagName(&#39;uuid&#39;)[0].firstChild.nodeValue

macaddr = &quot;94:de:80:ea:30:f5&quot;
natname = &quot;nat0&quot;
params = &#39;[&quot;-netdev&quot;,&quot;tap,ifname=%s,script=no,id=hostnet0,downscript=no&quot;,&quot;-device&quot;,&quot;virtio-net-pci,mac=%s,netdev=hostnet0,bus=pci.0,addr=0x10&quot;]&#39; % (natname, macaddr)
os.environ.\_\_setitem\_\_(&quot;qemu\_cmdline&quot;,params)

# Modify Qemu Parameter

if &#39;qemu\_cmdline&#39; in os.environ:
    try:
        domxml = hooking.read\_domxml()

        qemu\_cmdline = json.loads(os.environ[&#39;qemu\_cmdline&#39;])
        addQemuNs(domxml)
        injectQemuCmdLine(domxml, qemu\_cmdline)

        hooking.write\_domxml(domxml)
    except:
        sys.stderr.write(&#39;qemu\_cmdline: [unexpected error]: %s\\n&#39;
                         % traceback.format\_exc())
        sys.exit(2)
</code></pre></div></td></tr></table></div> <h3 id=then-you-should-start-the-vm-without-any-nic-if-you-are-using-natpy><a class=toclink href=../../../../2012/10/18/ovirt-notes/#then-you-should-start-the-vm-without-any-nic-if-you-are-using-natpy>Then you should start the vm <strong>WITHOUT ANY NIC</strong> if you are using <em>nat.py</em>.</a></h3> <p>title: "Migrate vm from ESXi to oVirt" date: 2014-04-25 categories: - "cloud-infra"</p> <hr> <p>oVirt: v3.3, CentOS, 192.168.1.111 ESXi: 5.x, 192.168.1.135</p> <p><strong>For Windows vm, do this</strong> <a href=http://pve.proxmox.com/wiki/Migration_of_servers_to_Proxmox_VE#VMware_to_Proxmox_VE_.28KVM.29>http://pve.proxmox.com/wiki/Migration_of_servers_to_Proxmox_VE#VMware_to_Proxmox_VE_.28KVM.29</a> Before you begin make a copy of the VMware image. <strong>Remove VMware tools</strong> Start the Windows virtual machine on VMware and remove the VMware tools via the Windows control panel. Reboot. <strong>Enable IDE</strong> Start the Windows virtual machine on VMware and execute the mergeide.reg (File:<a href=http://blog.lofyer.org/migrate-vm-esxi-ovirt/mergeide/ >Mergeide</a>). Now the registry is changed that your Windows can boot from IDE, necessary for KVM. Make sure Atapi.sys, Intelide.sys, Pciide.sys, and Pciidex.sys are in the %SystemRoot%\System32\Drivers folder. If any are missing they can be extracted from %SystemRoot%\Driver Cache\I386\Driver.cab which can be opened in Windows file Exlorer like a directory and then the missing files can be copied out. <a href=https://support.microsoft.com/en-us/kb/314082>see Microsoft KB article for details.</a> <strong>Shutdown Windows.</strong></p> <ol> <li>Create a nfs export domain on your oVirt datacenter.</li> </ol> <p>/vdsm/export 0.0.0.0/0.0.0.0(rw)</p> <ol> <li>Install virt-v2v on CentOS and add authentication.</li> </ol> <h2 id=yum-install-virt-v2v><a class=toclink href=../../../../2012/10/18/ovirt-notes/#yum-install-virt-v2v>yum install virt-v2v</a></h2> <p>machine 192.168.1.135 login root password 1234567</p> <p>Change permission of <em>.netrc</em> as saying of manual or you will get a warning with wrong permission.</p> <h2 id=chmod-600-netrc><a class=toclink href=../../../../2012/10/18/ovirt-notes/#chmod-600-netrc>chmod 600 ~/.netrc</a></h2> <ol> <li>Import myvm. <strong>Make sure that your vm in ESXi is powered off.</strong></li> </ol> <h2 id=virt-v2v-ic-esx1921681135no_verify1-o-rhev-os-1921681111virtfanexport-network-mgmtnet-myvm><a class=toclink href=../../../../2012/10/18/ovirt-notes/#virt-v2v-ic-esx1921681135no_verify1-o-rhev-os-1921681111virtfanexport-network-mgmtnet-myvm>virt-v2v -ic esx://192.168.1.135/?no_verify=1 -o rhev -os 192.168.1.111:/virtfan/export --network mgmtnet myvm</a></h2> <p>myvm_myvm: 100% [====================================================]D 0h04m48s</p> <p>virt-v2v: myvm configured with virtio drivers.</p> <ol> <li>Import myvm from export domain to data domain.</li> </ol> <p><strong>Import.</strong></p> <p><a href=http://blog.lofyer.org/migrate-vm-esxi-ovirt/import/ ><img alt=import src=/blog/images/import.png></a></p> <p><strong>Run.</strong></p> <p><a href=http://blog.lofyer.org/migrate-vm-esxi-ovirt/run/ ><img alt=run src=/blog/images/run.png></a></p> <h3 id=vdsm-2012-10-29><a class=toclink href=../../../../2012/10/18/ovirt-notes/#vdsm-2012-10-29>"VDSM" "2012-10-29"</a></h3> <p>不喜欢java，就是不喜欢。。但还是要干的。。 4000多个文件构建UML图的话有点困难，都是小类，看了些tools的代码，然后转到vdsm内容，通讯方式是xml-rpc，当初我猜对了。</p> <p>vdsm是oVirt的节点代理，功能可订制，也可移植到其他管理平台，基于KVM，储存VM各种暂态数据 vdsm提供的api通过xmlrpc使用，架构如下</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span></pre></div></td><td class=code><div><pre><span></span><code>------------+------VDSM-------+------+-----
            |                 |      |
    sysfs---+                 |      |
      LVM---+              libvirt   |
net-tools---+              qmp|      |Virtio serial
      xxx---+             ---+      +-------------/
           ...                |      |
                      -------/        \-------
                     /                        \
                    |  KVM-QEMU VM             |
                     \________________________/
</code></pre></div></td></tr></table></div> <p>主要包括vdsm,vdsm_cli,vds_bootstrap,vdsm_reg,vdsm_hooks 其中lifecycle hooks有针对vdsm和vm在before和after期间 bootstrap用于验证兼容性，包括网络，cpu，认证等，目前只支持RH自家产品</p> </div> </article> <nav class=md-pagination> <a href=../../ class=md-pagination__link>1</a> <span class=md-pagination__current>2</span> </nav> </div> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2008 - 2024 lofyer </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../../../..", "features": ["search.suggest", "search.highlight", "navigation.tabs", "navigation.tabs.sticky", "navigation.tracking", "navigation.prune", "navigation.instant", "navigation.instant.progess"], "search": "../../../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script> <script src=../../../../../assets/javascripts/bundle.525ec568.min.js></script> <script src=../../../../../javascripts/config.js></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> </body> </html>