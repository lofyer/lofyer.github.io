<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content=lofyer><link href=https://docs.lofyer.org/blog/category/inthecloud/ rel=canonical><link href=../hpc/ rel=prev><link href=../linux-admin/ rel=next><link rel=icon href=../../../images/favicon.ico><meta name=generator content="mkdocs-1.6.0, mkdocs-material-9.5.26"><title>inthecloud - Lofyer's Blog</title><link rel=stylesheet href=../../../assets/stylesheets/main.6543a935.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.06af60db.min.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#inthecloud class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../.. title="Lofyer's Blog" class="md-header__button md-logo" aria-label="Lofyer's Blog" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Lofyer's Blog </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> inthecloud </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> </form> <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=查找> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/lofyer/lofyer.github.io title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> lofyer/lofyer.github.io </div> </a> </div> </nav> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Index </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../ class=md-tabs__link> 博客 </a> </li> <li class=md-tabs__item> <a href=../../../datanote/ class=md-tabs__link> Docs </a> </li> <li class=md-tabs__item> <a href=../../../about/about/ class=md-tabs__link> About </a> </li> <li class=md-tabs__item> <a href=../../../template_password/ class=md-tabs__link> [密码保护]Template </a> </li> <li class=md-tabs__item> <a href=../../../tags/ class=md-tabs__link> Tags </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="Lofyer's Blog" class="md-nav__button md-logo" aria-label="Lofyer's Blog" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> Lofyer's Blog </label> <div class=md-nav__source> <a href=https://github.com/lofyer/lofyer.github.io title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> lofyer/lofyer.github.io </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> Index </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex> <span class=md-ellipsis> 博客 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> 博客 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../ class=md-nav__link> <span class=md-ellipsis> 首页 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../archive/2023/ class=md-nav__link> <span class=md-ellipsis> 归档 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3 checked> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex=0> <span class=md-ellipsis> 分类 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=true> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> 分类 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../lab/ class=md-nav__link> <span class=md-ellipsis> Lab </span> </a> </li> <li class=md-nav__item> <a href=../abm/ class=md-nav__link> <span class=md-ellipsis> abm </span> </a> </li> <li class=md-nav__item> <a href=../ai/ class=md-nav__link> <span class=md-ellipsis> ai </span> </a> </li> <li class=md-nav__item> <a href=../cloud-infra/ class=md-nav__link> <span class=md-ellipsis> cloud-infra </span> </a> </li> <li class=md-nav__item> <a href=../collect/ class=md-nav__link> <span class=md-ellipsis> collect </span> </a> </li> <li class=md-nav__item> <a href=../devices/ class=md-nav__link> <span class=md-ellipsis> devices </span> </a> </li> <li class=md-nav__item> <a href=../diary/ class=md-nav__link> <span class=md-ellipsis> diary </span> </a> </li> <li class=md-nav__item> <a href=../draft/ class=md-nav__link> <span class=md-ellipsis> draft </span> </a> </li> <li class=md-nav__item> <a href=../filecoin/ class=md-nav__link> <span class=md-ellipsis> filecoin </span> </a> </li> <li class=md-nav__item> <a href=../followmyheart/ class=md-nav__link> <span class=md-ellipsis> followmyheart </span> </a> </li> <li class=md-nav__item> <a href=../fpga/ class=md-nav__link> <span class=md-ellipsis> fpga </span> </a> </li> <li class=md-nav__item> <a href=../hpc/ class=md-nav__link> <span class=md-ellipsis> hpc </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> inthecloud </span> </a> </li> <li class=md-nav__item> <a href=../linux-admin/ class=md-nav__link> <span class=md-ellipsis> linux-admin </span> </a> </li> <li class=md-nav__item> <a href=../modeling/ class=md-nav__link> <span class=md-ellipsis> modeling </span> </a> </li> <li class=md-nav__item> <a href=../my-books/ class=md-nav__link> <span class=md-ellipsis> my-books </span> </a> </li> <li class=md-nav__item> <a href=../mylife/ class=md-nav__link> <span class=md-ellipsis> mylife </span> </a> </li> <li class=md-nav__item> <a href=../new-world/ class=md-nav__link> <span class=md-ellipsis> new-world </span> </a> </li> <li class=md-nav__item> <a href=../others/ class=md-nav__link> <span class=md-ellipsis> others </span> </a> </li> <li class=md-nav__item> <a href=../ovs/ class=md-nav__link> <span class=md-ellipsis> ovs </span> </a> </li> <li class=md-nav__item> <a href=../tech/ class=md-nav__link> <span class=md-ellipsis> tech </span> </a> </li> <li class=md-nav__item> <a href=../%E4%BA%91%E8%AE%A1%E7%AE%97/ class=md-nav__link> <span class=md-ellipsis> 云计算 </span> </a> </li> <li class=md-nav__item> <a href=../%E5%8D%9A%E6%96%87/ class=md-nav__link> <span class=md-ellipsis> 博文 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../datanote/ class=md-nav__link> <span class=md-ellipsis> Docs </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../../../about/about/ class=md-nav__link> <span class=md-ellipsis> About </span> </a> </li> <li class=md-nav__item> <a href=../../../template_password/ class=md-nav__link> <span class=md-ellipsis> [密码保护]Template </span> </a> </li> <li class=md-nav__item> <a href=../../../tags/ class=md-nav__link> <span class=md-ellipsis> Tags </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <div class=md-content__inner> <header class=md-typeset> <h1 id=inthecloud>inthecloud</h1> </header> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2014-05-22 00:00:00">2014年5月22日</time></li> <li class=md-meta__item> 分类于 <a href=./ class=md-meta__link>inthecloud</a></li> <li class=md-meta__item> 需要 1 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=15-ovirt-shell><a href=../../2014/05/22/15-ovirt-shell/ class=toclink>15. ovirt-shell</a></h2> <p>和许多虚拟化平台一样，ovirt也有自己的shell，并且在功能上有自己的特点。</p> <h3 id=ovirt-shell><a class=toclink href=../../2014/05/22/15-ovirt-shell/#ovirt-shell>连接ovirt-shell</a></h3> <h2 id=yum-install-ovirt-engine-cli><a class=toclink href=../../2014/05/22/15-ovirt-shell/#yum-install-ovirt-engine-cli>yum install ovirt-engine-cli</a></h2> <h2 id=ovirt-shell-l-https1921681190-u-admininternal-i><a class=toclink href=../../2014/05/22/15-ovirt-shell/#ovirt-shell-l-https1921681190-u-admininternal-i>ovirt-shell -l https://192.168.1.190 -u admin@internal -I</a></h2> <p>连接以后，可双击tab以自动补全。 <strong>你可以看出来，在ovirt中，vm、host、cluster等均可以看作“对象”，而其操作比如“start”、“stop”等可看作方法。</strong></p> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2014-05-17 00:00:00">2014年5月17日</time></li> <li class=md-meta__item> 分类于 <a href=./ class=md-meta__link>inthecloud</a></li> <li class=md-meta__item> 需要 1 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=21-hadoopstorm><a href=../../2014/05/17/21-hadoopstorm-%E4%BB%8B%E7%BB%8D/ class=toclink>21. Hadoop/Storm 介绍</a></h2> <p>终于到这一章了。 <strong>期望这一章的读者不要盲目跟风，找到适合自己的便好。</strong></p> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2014-05-11 00:00:00">2014年5月11日</time></li> <li class=md-meta__item> 分类于 <a href=./ class=md-meta__link>inthecloud</a></li> <li class=md-meta__item> 需要 1 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=14-ovirt><a href=../../2014/05/11/14-ovirt%E4%BD%BF%E7%94%A8%E8%BF%9B%E9%98%B6/ class=toclink>14. oVirt使用进阶</a></h2> <h3 id=ovirt-shell><a class=toclink href=../../2014/05/11/14-ovirt%E4%BD%BF%E7%94%A8%E8%BF%9B%E9%98%B6/#ovirt-shell>ovirt-shell</a></h3> <p>使用ovirt-shell在一定程度上适合于某些场景。</p> <h2 id=ovirt-shell-i-u-admininternal-l-httpsserver_ipapi><a class=toclink href=../../2014/05/11/14-ovirt%E4%BD%BF%E7%94%A8%E8%BF%9B%E9%98%B6/#ovirt-shell-i-u-admininternal-l-httpsserver_ipapi>ovirt-shell -I -u admin@internal -l https://server_ip/api</a></h2> <p>============================================================================ &gt;&gt;&gt; connected to oVirt manager 3.4.0.0 &lt;&lt;&lt; ============================================================================</p> <p>++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code>                         Welcome to oVirt shell
</code></pre></div></td></tr></table></div> <p>++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</p> <p>[oVirt shell (connected)]#</p> <h3 id=hooks><a class=toclink href=../../2014/05/11/14-ovirt%E4%BD%BF%E7%94%A8%E8%BF%9B%E9%98%B6/#hooks>主机hooks</a></h3> <p>参考<a href=https://github.com/oVirt/vdsm/tree/master/vdsm_hooks>vdsm-hooks</a>。</p> <h3 id=_1><a class=toclink href=../../2014/05/11/14-ovirt%E4%BD%BF%E7%94%A8%E8%BF%9B%E9%98%B6/#_1>集群策略</a></h3> <p><a href=http://www.ovirt.org//blog/images/2/2a/Scheduler-Deep-Dive-oVirt.pdf>参考这个PDF</a>。</p> <h3 id=libguestfs><a class=toclink href=../../2014/05/11/14-ovirt%E4%BD%BF%E7%94%A8%E8%BF%9B%E9%98%B6/#libguestfs>libguestfs扩容</a></h3> <p><strong>LVM扩容</strong> <strong>普通扩容</strong></p> <h3 id=ui-plugin><a class=toclink href=../../2014/05/11/14-ovirt%E4%BD%BF%E7%94%A8%E8%BF%9B%E9%98%B6/#ui-plugin>UI plugin</a></h3> <p><strong>ShellInABox</strong></p> <h3 id=_2><a class=toclink href=../../2014/05/11/14-ovirt%E4%BD%BF%E7%94%A8%E8%BF%9B%E9%98%B6/#_2>平台插件</a></h3> <p><strong>Foreman</strong> <strong>OpenStack Network</strong> <strong>OpenStack Image</strong></p> <h3 id=_3><a class=toclink href=../../2014/05/11/14-ovirt%E4%BD%BF%E7%94%A8%E8%BF%9B%E9%98%B6/#_3>手动创建导出域</a></h3> <p>构造目录，形如：</p> <h2 id=tree-exports><a class=toclink href=../../2014/05/11/14-ovirt%E4%BD%BF%E7%94%A8%E8%BF%9B%E9%98%B6/#tree-exports>tree exports</a></h2> <p>. ├── 37e0e64b-5445-4bc3-8675-ceff4637e8e3/ │   ├── dom_md/ │   │   ├── ids │   │   ├── inbox │   │   ├── leases │   │   ├── metadata │   │   └── outbox │   ├── /blog/images/ │   └── master/ │   ├── tasks/ │   └── vms/ └── __DIRECT_IO_TEST__</p> <p>创建_leases_文件：</p> <h2 id=echo-2d2d2d2d2d2d465245452d2d2d2d2d2d3030303030303030303030303030><a class=toclink href=../../2014/05/11/14-ovirt%E4%BD%BF%E7%94%A8%E8%BF%9B%E9%98%B6/#echo-2d2d2d2d2d2d465245452d2d2d2d2d2d3030303030303030303030303030>echo 2d2d2d2d2d2d465245452d2d2d2d2d2d3030303030303030303030303030</a></h2> <p>303000000000000000000000000000000000000000000000000000000000 000000000000000000000000000000000000000000000000000000000000 000000000000000000000000000000000000000000000000000000000000 000000000000000000000000000000000000000000000000000000000000 000000000000000000000000000000000000000000000000000000000000 000000000000000000000000000000000000000000000000000000000000 000000000000000000000000000000000000000000000000000000000000 000000000000000000000000000000000000000000000000000000000000 000000000000000000000000000000000000000000000000000000000000 000000000000000000000000000000000000000000000000000000000000 000000000000000000000000000000000000000000000000000000000000 000000000000000000000000000000000000000000000000000000000000 000000000000000000000000000000000000000000000000000000000000 000000000000000000000000000000000000000000000000000000000000 000000000000000000000000000000000000000000000000000000000000 000000000000000000000000000000000000000000000000000000000000 0000 | xxd -r -p &gt; leases</p> <p>添加如下内容至_metadata_文件：</p> <p>CLASS=Backup DESCRIPTION=Export IOOPTIMEOUTSEC=10 LEASERETRIES=3 LEASETIMESEC=60 LOCKPOLICY= LOCKRENEWALINTERVALSEC=5 MASTER_VERSION=0 POOL_UUID= REMOTE_PATH=192.168.1.108:/home/nfs_exports ROLE=Regular SDUUID=37e0e64b-5445-4bc3-8675-ceff4637e8e3 TYPE=NFS VERSION=0</p> <h2 id=_sha_cksum5737f1270bf93fdd660fea819655b01a34c315b9><a class=toclink href=../../2014/05/11/14-ovirt%E4%BD%BF%E7%94%A8%E8%BF%9B%E9%98%B6/#_sha_cksum5737f1270bf93fdd660fea819655b01a34c315b9>_SHA_CKSUM=5737f1270bf93fdd660fea819655b01a34c315b9</a></h2> <p>使用如下脚本（参考源码中packaging/setup/plugins/ovirt-engine-setup/config/iso_domain.py）计算SHA校验值，并将其填入_metadata_中的_SHA_CKSUM段：</p> <h2 id=usrbinpython><a class=toclink href=../../2014/05/11/14-ovirt%E4%BD%BF%E7%94%A8%E8%BF%9B%E9%98%B6/#usrbinpython>!/usr/bin/python</a></h2> <p>import hashlib from optparse import OptionParser</p> <p>if __name__ == "__main__": parser = OptionParser() (options, args) = parser.parse_args() if len(args) != 1: parser.error("Missing metadata file") f = open(args[0], "r") mds = {} for line in f: line = line.strip() if not line or line.startswith('#'): continue try: key,value = line.split('=', 1) if key == '_SHA_CKSUM': continue mds[key] = value except Exception, e: continue f.close() #print mds csum = hashlib.sha1() keys = mds.keys() keys.sort() for key in keys: value = mds[key] line = "%s=%s" % (key, value) csum.update(line) print(csum.hexdigest())</p> <p>更改权限：</p> <h2 id=chown-r-vdsmkvm-exports><a class=toclink href=../../2014/05/11/14-ovirt%E4%BD%BF%E7%94%A8%E8%BF%9B%E9%98%B6/#chown-r-vdsmkvm-exports>chown -R vdsm.kvm exports</a></h2> <p>然后可以作为空导出域进行导入。</p> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2014-05-08 00:00:00">2014年5月8日</time></li> <li class=md-meta__item> 分类于 <a href=./ class=md-meta__link>inthecloud</a></li> <li class=md-meta__item> 需要 1 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=13><a href=../../2014/05/08/13-%E5%AE%8C%E5%96%84%E5%B9%B3%E5%8F%B0/ class=toclink>13. 完善平台</a></h2> <p>我想，你看到这的话应该已经有了一个数据中心、几个宿主机，也可能有一个虚拟机（engine），还差一个存储虚拟机镜像的地方就可以具有基本功能的oVirt平台了。</p> <p>Ok, here we go.</p> <h3 id=_1><a class=toclink href=../../2014/05/08/13-%E5%AE%8C%E5%96%84%E5%B9%B3%E5%8F%B0/#_1>添加节点（宿主机）</a></h3> <p>对于第11节的普通oVirt、第12节的ha平台，你可能需要添加更多节点以支持更好的SLA（service level agreement）。 添加节点目前有三种方式，一种是通过oVirt的节点ISO直接安装再加入，另一种是直接将现有CentOS或者Fedora转化为节点，另外还可以指定使用外部节点（Foreman），在此我们使用第二种方法。</p> <p><a href=http://blog.lofyer.org/6-4-complete-ovirt/add_node_1/ ><img alt=add_node_1 src=/blog/images/add_node_1.png></a></p> <h3 id=_2><a class=toclink href=../../2014/05/08/13-%E5%AE%8C%E5%96%84%E5%B9%B3%E5%8F%B0/#_2>添加存储域</a></h3> <p>存储域有3种，Data（数据域）、ISO（ISO域）、Export（导出域）。 其中，数据域是为必需，在创建任何虚拟机之前需要有一个可用的数据域用于存储虚拟磁盘以及快照文件；ISO域中可以存放ISO和VFD格式的系统镜像或者驱动文件；导出域用于导出或导入OVF格式的虚机。 而根据数据域的存储类型，我们有5种（NFS、POSIX兼容、Glusterfs、iSCSI、光纤）可选，在此，建议（为什么？）选择glusterfs导出的NFS。</p> <p><em>此图可以换掉</em> <a href=http://blog.lofyer.org/6-4-complete-ovirt/add_storage_1/ ><img alt=add_storage_1 src=/blog/images/add_storage_1.png></a></p> <p><strong>注意</strong>：确保存储域权限为36:36，也即vdsm.kvm。</p> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2014-05-07 00:00:00">2014年5月7日</time></li> <li class=md-meta__item> 分类于 <a href=./ class=md-meta__link>inthecloud</a></li> <li class=md-meta__item> 需要 5 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=11-ovirt><a href=../../2014/05/07/11-%E6%90%AD%E5%BB%BAovirt%E8%99%9A%E6%8B%9F%E5%8C%96%E5%B9%B3%E5%8F%B0/ class=toclink>11. 搭建oVirt虚拟化平台</a></h2> <p>对于初次使用oVirt的用户，建议使用此种搭建方式，<strong>太折腾的话就吓走好多目标读者了</strong>。</p> <p>使用之前的四台机器，分别为gs1.lofyer.org，gs2.lofyer.org，gs3.lofyer.org和gs4.lofyer.org，其中，将gs1作为管理机安装ovirt-engine，其余三台作为节点（node），存储使用已经创建好的glusterfs。</p> <h3 id=_1><a class=toclink href=../../2014/05/07/11-%E6%90%AD%E5%BB%BAovirt%E8%99%9A%E6%8B%9F%E5%8C%96%E5%B9%B3%E5%8F%B0/#_1>准备</a></h3> <p><strong>存储可以使用之前的glusterfs，方式为NFS_V3，注意将brick的权限设置为vdsm.kvm或者36:36。</strong></p> <h2 id=gluster-volume-create-gluster-vol1-replica-2-gs1examplecomgluster_brick0-gs2examplecomgluster_brick0-gs3examplecomgluster_brick0-gs4examplecomgluster_brick0-gs1examplecomgluster_brick1-gs2examplecomgluster_brick1-gs3examplecomgluster_brick1-gs4examplecomgluster_brick1-force><a class=toclink href=../../2014/05/07/11-%E6%90%AD%E5%BB%BAovirt%E8%99%9A%E6%8B%9F%E5%8C%96%E5%B9%B3%E5%8F%B0/#gluster-volume-create-gluster-vol1-replica-2-gs1examplecomgluster_brick0-gs2examplecomgluster_brick0-gs3examplecomgluster_brick0-gs4examplecomgluster_brick0-gs1examplecomgluster_brick1-gs2examplecomgluster_brick1-gs3examplecomgluster_brick1-gs4examplecomgluster_brick1-force>gluster volume create gluster-vol1 replica 2 gs1.example.com:/gluster_brick0 gs2.example.com:/gluster_brick0 gs3.example.com:/gluster_brick0 gs4.example.com:/gluster_brick0 gs1.example.com:/gluster_brick1 gs2.example.com:/gluster_brick1 gs3.example.com:/gluster_brick1 gs4.example.com:/gluster_brick1 force</a></h2> <p><a href=http://blog.lofyer.org/11-cloud-ha-ovirt/gluster-ovirt/ ><img alt=gluster-ovirt src=/blog/images/gluster-ovirt.png></a></p> <p><strong>由于engine以及node的网络服务依赖于network而非NetworkManager，我们需要启用前者禁用后者，在每一台服务器上都进行如下类似配置修改网络。</strong></p> <p>NAME=eth0 DEVICE=eth0 ONBOOT=yes BOOTPROTO=static</p> <h2 id=ip><a class=toclink href=../../2014/05/07/11-%E6%90%AD%E5%BB%BAovirt%E8%99%9A%E6%8B%9F%E5%8C%96%E5%B9%B3%E5%8F%B0/#ip>注意修改此处的IP</a></h2> <p>IPADDR=192.168.10.101 NETMASK=255.255.255.0 GATEWAY=192.168.10.1 DNS1=192.168.10.1</p> <h2 id=chkconfig-networkmanager-off><a class=toclink href=../../2014/05/07/11-%E6%90%AD%E5%BB%BAovirt%E8%99%9A%E6%8B%9F%E5%8C%96%E5%B9%B3%E5%8F%B0/#chkconfig-networkmanager-off>chkconfig NetworkManager off</a></h2> <h2 id=chkconfig-network-on><a class=toclink href=../../2014/05/07/11-%E6%90%AD%E5%BB%BAovirt%E8%99%9A%E6%8B%9F%E5%8C%96%E5%B9%B3%E5%8F%B0/#chkconfig-network-on>chkconfig network on</a></h2> <h2 id=service-networkmanager-stop-service-network-restart><a class=toclink href=../../2014/05/07/11-%E6%90%AD%E5%BB%BAovirt%E8%99%9A%E6%8B%9F%E5%8C%96%E5%B9%B3%E5%8F%B0/#service-networkmanager-stop-service-network-restart>service NetworkManager stop; service network restart</a></h2> <h3 id=repo><a class=toclink href=../../2014/05/07/11-%E6%90%AD%E5%BB%BAovirt%E8%99%9A%E6%8B%9F%E5%8C%96%E5%B9%B3%E5%8F%B0/#repo>添加repo</a></h3> <h2 id=yum-localinstall-httpresourcesovirtorgreleasesovirt-releasenoarchrpm><a class=toclink href=../../2014/05/07/11-%E6%90%AD%E5%BB%BAovirt%E8%99%9A%E6%8B%9F%E5%8C%96%E5%B9%B3%E5%8F%B0/#yum-localinstall-httpresourcesovirtorgreleasesovirt-releasenoarchrpm>yum localinstall http://resources.ovirt.org/releases/ovirt-release.noarch.rpm</a></h2> <h2 id=yum-install-ovirt-hosted-engine-setup><a class=toclink href=../../2014/05/07/11-%E6%90%AD%E5%BB%BAovirt%E8%99%9A%E6%8B%9F%E5%8C%96%E5%B9%B3%E5%8F%B0/#yum-install-ovirt-hosted-engine-setup>yum install ovirt-hosted-engine-setup</a></h2> <p>或者手动添加：</p> <p>[ovirt-stable] name=Latest oVirt Releases baseurl=http://ovirt.org/releases/stable/rpm/EL/$releasever/ enabled=1 skip_if_unavailable=1 gpgcheck=0</p> <p>[ovirt-3.4-stable] name=Latest oVirt 3.4.z Releases baseurl=http://ovirt.org/releases/3.4/rpm/EL/$releasever/ enabled=1 skip_if_unavailable=1 gpgcheck=0</p> <p>[epel] name=Extra Packages for Enterprise Linux 6 - $basearch</p> <h2 id=baseurlhttpdownloadfedoraprojectorgpubepel6basearch><a class=toclink href=../../2014/05/07/11-%E6%90%AD%E5%BB%BAovirt%E8%99%9A%E6%8B%9F%E5%8C%96%E5%B9%B3%E5%8F%B0/#baseurlhttpdownloadfedoraprojectorgpubepel6basearch>baseurl=http://download.fedoraproject.org/pub/epel/6/$basearch</a></h2> <p>mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-6&amp;arch=$basearch failovermethod=priority enabled=1 includepkgs=epel-release,python-uinput,puppet,python-lockfile,python-cpopen,python-ordereddict,python-pthreading,python-inotify,python-argparse,novnc,python-ply,python-kitchen,python-daemon,python-websockify,livecd-tools,spice-html5,mom gpgcheck=0</p> <p>[ovirt-glusterfs-epel] name=GlusterFS is a clustered file-system capable of scaling to several petabytes. baseurl=http://download.gluster.org/pub/gluster/glusterfs/LATEST/EPEL.repo/epel-<span class=arithmatex>\(releasever/\)</span>basearch/ enabled=1 skip_if_unavailable=1 gpgcheck=0</p> <p>[ovirt-glusterfs-noarch-epel] name=GlusterFS is a clustered file-system capable of scaling to several petabytes. baseurl=http://download.gluster.org/pub/gluster/glusterfs/LATEST/EPEL.repo/epel-$releasever/noarch enabled=1 skip_if_unavailable=1 gpgcheck=0</p> <h3 id=_2><a class=toclink href=../../2014/05/07/11-%E6%90%AD%E5%BB%BAovirt%E8%99%9A%E6%8B%9F%E5%8C%96%E5%B9%B3%E5%8F%B0/#_2>安装管理节点。</a></h3> <p>在gs1上运行如下命令。</p> <h2 id=yum-install-ovirt-engine><a class=toclink href=../../2014/05/07/11-%E6%90%AD%E5%BB%BAovirt%E8%99%9A%E6%8B%9F%E5%8C%96%E5%B9%B3%E5%8F%B0/#yum-install-ovirt-engine>yum install ovirt-engine</a></h2> <h2 id=engine-setup-offline><a class=toclink href=../../2014/05/07/11-%E6%90%AD%E5%BB%BAovirt%E8%99%9A%E6%8B%9F%E5%8C%96%E5%B9%B3%E5%8F%B0/#engine-setup-offline>engine-setup --offline</a></h2> <p>[ INFO ] Stage: Initializing [ INFO ] Stage: Environment setup Configuration files: ['/etc/ovirt-engine-setup.conf.d/10-packaging.conf'] Log file: /var/log/ovirt-engine/setup/ovirt-engine-setup-20140508054649.log Version: otopi-1.2.0 (otopi-1.2.0-1.el6) [ INFO ] Stage: Environment packages setup [ INFO ] Stage: Programs detection [ INFO ] Stage: Environment setup [ INFO ] Stage: Environment customization</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span></pre></div></td><td class=code><div><pre><span></span><code>      --== PRODUCT OPTIONS ==--


      --== PACKAGES ==--


      --== NETWORK CONFIGURATION ==--

      Host fully qualified DNS name of this server \[gs1.lofyer.org\]: 
      Setup can automatically configure the firewall on this system.
      Note: automatic configuration of the firewall may overwrite current settings.
      Do you want Setup to configure the firewall? (Yes, No) \[Yes\]: 
      The following firewall managers were detected on this system: iptables
      Firewall manager to configure (iptables): iptables
</code></pre></div></td></tr></table></div> <p>[ INFO ] iptables will be configured as firewall manager.</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span></pre></div></td><td class=code><div><pre><span></span><code>      --== DATABASE CONFIGURATION ==--

      Where is the Engine database located? (Local, Remote) \[Local\]: 
      Setup can configure the local postgresql server automatically for the engine to run. This may conflict with existing applications.
      Would you like Setup to automatically configure postgresql and create Engine database, or prefer to perform that manually? (Automatic, Manual) \[Automatic\]:

      --== OVIRT ENGINE CONFIGURATION ==--

      Application mode (Both, Virt, Gluster) \[Both\]: 
      Default storage type: (NFS, FC, ISCSI, POSIXFS) \[NFS\]: 
      Engine admin password: 
      Confirm engine admin password:

      --== PKI CONFIGURATION ==--

      Organization name for certificate \[lofyer.org\]:

      --== APACHE CONFIGURATION ==--

      Setup can configure apache to use SSL using a certificate issued from the internal CA.
      Do you wish Setup to configure that, or prefer to perform that manually? (Automatic, Manual) \[Automatic\]: 
      Setup can configure the default page of the web server to present the application home page. This may conflict with existing applications.
      Do you wish to set the application as the default page of the web server? (Yes, No) \[Yes\]:

      --== SYSTEM CONFIGURATION ==--

      Configure WebSocket Proxy on this machine? (Yes, No) \[Yes\]: 
      Configure an NFS share on this server to be used as an ISO Domain? (Yes, No) \[Yes\]: no

      --== MISC CONFIGURATION ==--


      --== END OF CONFIGURATION ==--
</code></pre></div></td></tr></table></div> <p>[ INFO ] Stage: Setup validation</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span></pre></div></td><td class=code><div><pre><span></span><code>      --== CONFIGURATION PREVIEW ==--

      Engine database name                    : engine
      Engine database secured connection      : False
      Engine database host                    : localhost
      Engine database user name               : engine
      Engine database host name validation    : False
      Engine database port                    : 5432
      PKI organization                        : lofyer.org
      Application mode                        : both
      Firewall manager                        : iptables
      Update Firewall                         : True
      Configure WebSocket Proxy               : True
      Host FQDN                               : gs1.lofyer.org
      Datacenter storage type                 : nfs
      Configure local Engine database         : True
      Set application as default page         : True
      Configure Apache SSL                    : True

      Please confirm installation settings (OK, Cancel) \[OK\]: ok
</code></pre></div></td></tr></table></div> <p>[ INFO ] Stage: Transaction setup [ INFO ] Stopping engine service [ INFO ] Stopping websocket-proxy service [ INFO ] Stage: Misc configuration [ INFO ] Stage: Package installation [ INFO ] Stage: Misc configuration [ INFO ] Initializing PostgreSQL [ INFO ] Creating PostgreSQL 'engine' database [ INFO ] Configuring PostgreSQL [ INFO ] Creating Engine database schema [ INFO ] Creating CA [ INFO ] Configuring WebSocket Proxy [ INFO ] Generating post install configuration file '/etc/ovirt-engine-setup.conf.d/20-setup-ovirt-post.conf' [ INFO ] Stage: Transaction commit [ INFO ] Stage: Closing up</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span></pre></div></td><td class=code><div><pre><span></span><code>      --== SUMMARY ==--

      SSH fingerprint: 1B:FD:08:A2:FD:83:20:8A:65:F5:0D:F6:CB:BF:46:C7
      Internal CA 28:7E:D6:6B:F7:F2:6C:B5:60:27:44:C3:7F:3C:22:63:E5:68:DD:F4
      Web access is enabled at:
          http://gs1.lofyer.org:80/ovirt-engine
          https://gs1.lofyer.org:443/ovirt-engine
      Please use the user &quot;admin&quot; and password specified in order to login into oVirt Engine

      --== END OF SUMMARY ==--
</code></pre></div></td></tr></table></div> <p>[ INFO ] Starting engine service [ INFO ] Restarting httpd [ INFO ] Generating answer file '/var/lib/ovirt-engine/setup/answers/20140508054842-setup.conf' [ INFO ] Stage: Clean up Log file is located at /var/log/ovirt-engine/setup/ovirt-engine-setup-20140508054649.log [ INFO ] Stage: Pre-termination [ INFO ] Stage: Termination [ INFO ] Execution of setup completed successfully</p> <p>至此，管理节点安装结束。</p> <p>接下来，加入节点以及存储域，请参考第13节。</p> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2014-04-29 00:00:00">2014年4月29日</time></li> <li class=md-meta__item> 分类于 <a href=./ class=md-meta__link>inthecloud</a></li> <li class=md-meta__item> 需要 7 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=12-ovirthosted-engine><a href=../../2014/04/29/12-%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8ovirthosted-engine/ class=toclink>12. 搭建高可用oVirt（hosted engine）</a></h2> <p>笔者写此文时oVirt已经更新到3.4。</p> <p>在此，我们会用到之前创建的distributed-replicate存储，这样可用保证系统服务的高度可用性有所提高。</p> <p>有以下几点需要注意：</p> <blockquote> <p>1. 宿主机的CPU架构需要为Westmere（Westmere E56xx/L56xx/X56xx）、Nehalem（Intel Core i7 9xx）、Penryn（Intel Core 2 Duo P9xxx）或者Conroe（Intel Celeron_4x0）中的之一，否则集群类型会与宿主机类型不兼容导致数据中心启动失败。</p> <p>CPU Family table 参阅 <a href=https://software.intel.com/en-us/articles/intel-architecture-and-processor-identification-with-cpuid-model-and-family-numbers title="cpu family table">Intel Architecture and Processor Identification With CPUID Model and Family Numbers</a></p> <p>2. 建议参考第11节提前安装含有oVirt管理的虚拟机，硬盘格式为RAW，从而在安装管理机时作为OVF导入或者覆盖虚拟磁盘，减少失败风险时间。</p> </blockquote> <h3 id=_1><a class=toclink href=../../2014/04/29/12-%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8ovirthosted-engine/#_1>准备</a></h3> <p><strong>每台机器上都要添加作为虚拟机运行的engine的FQDN，此处为ha.lofyer.org。</strong></p> <h2 id=echo-e-19216810100thalofyerorg-etchosts><a class=toclink href=../../2014/04/29/12-%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8ovirthosted-engine/#echo-e-19216810100thalofyerorg-etchosts>echo -e '192.168.10.100\tha.lofyer.org' &gt;&gt; /etc/hosts</a></h2> <p><strong>存储可以使用之前的glusterfs，方式为NFS_V3，注意将brick的权限设置为vdsm.kvm或者36:36。</strong></p> <h2 id=gluster-volume-create-gluster-vol1-replica-2-gs1examplecomgluster_brick0-gs2examplecomgluster_brick0-gs3examplecomgluster_brick0-gs4examplecomgluster_brick0-gs1examplecomgluster_brick1-gs2examplecomgluster_brick1-gs3examplecomgluster_brick1-gs4examplecomgluster_brick1-force><a class=toclink href=../../2014/04/29/12-%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8ovirthosted-engine/#gluster-volume-create-gluster-vol1-replica-2-gs1examplecomgluster_brick0-gs2examplecomgluster_brick0-gs3examplecomgluster_brick0-gs4examplecomgluster_brick0-gs1examplecomgluster_brick1-gs2examplecomgluster_brick1-gs3examplecomgluster_brick1-gs4examplecomgluster_brick1-force>gluster volume create gluster-vol1 replica 2 gs1.example.com:/gluster_brick0 gs2.example.com:/gluster_brick0 gs3.example.com:/gluster_brick0 gs4.example.com:/gluster_brick0 gs1.example.com:/gluster_brick1 gs2.example.com:/gluster_brick1 gs3.example.com:/gluster_brick1 gs4.example.com:/gluster_brick1 force</a></h2> <p><a href=http://blog.lofyer.org/11-cloud-ha-ovirt/gluster-ovirt/ ><img alt=gluster-ovirt src=/blog/images/gluster-ovirt.png></a></p> <p><strong>由于engine以及node的网络服务依赖于network而非NetworkManager，我们需要启用前者禁用后者，在每一台服务器上都进行如下类似配置修改网络。</strong></p> <p>NAME=eth0 DEVICE=eth0 ONBOOT=yes BOOTPROTO=static</p> <h2 id=ip><a class=toclink href=../../2014/04/29/12-%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8ovirthosted-engine/#ip>注意修改此处的IP</a></h2> <p>IPADDR=192.168.10.101 NETMASK=255.255.255.0 GATEWAY=192.168.10.1 DNS1=192.168.10.1</p> <h2 id=chkconfig-networkmanager-off><a class=toclink href=../../2014/04/29/12-%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8ovirthosted-engine/#chkconfig-networkmanager-off>chkconfig NetworkManager off</a></h2> <h2 id=chkconfig-network-on><a class=toclink href=../../2014/04/29/12-%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8ovirthosted-engine/#chkconfig-network-on>chkconfig network on</a></h2> <h2 id=service-networkmanager-stop-service-network-restart><a class=toclink href=../../2014/04/29/12-%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8ovirthosted-engine/#service-networkmanager-stop-service-network-restart>service NetworkManager stop; service network restart</a></h2> <h3 id=repo><a class=toclink href=../../2014/04/29/12-%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8ovirthosted-engine/#repo>添加repo</a></h3> <h2 id=yum-localinstall-httpresourcesovirtorgreleasesovirt-releasenoarchrpm><a class=toclink href=../../2014/04/29/12-%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8ovirthosted-engine/#yum-localinstall-httpresourcesovirtorgreleasesovirt-releasenoarchrpm>yum localinstall http://resources.ovirt.org/releases/ovirt-release.noarch.rpm</a></h2> <h2 id=yum-install-ovirt-hosted-engine-setup><a class=toclink href=../../2014/04/29/12-%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8ovirthosted-engine/#yum-install-ovirt-hosted-engine-setup>yum install ovirt-hosted-engine-setup</a></h2> <p>或者手动添加：</p> <p>[ovirt-stable] name=Latest oVirt Releases baseurl=http://ovirt.org/releases/stable/rpm/EL/$releasever/ enabled=1 skip_if_unavailable=1 gpgcheck=0</p> <p>[ovirt-3.4-stable] name=Latest oVirt 3.4.z Releases baseurl=http://ovirt.org/releases/3.4/rpm/EL/$releasever/ enabled=1 skip_if_unavailable=1 gpgcheck=0</p> <p>[epel] name=Extra Packages for Enterprise Linux 6 - $basearch</p> <h2 id=baseurlhttpdownloadfedoraprojectorgpubepel6basearch><a class=toclink href=../../2014/04/29/12-%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8ovirthosted-engine/#baseurlhttpdownloadfedoraprojectorgpubepel6basearch>baseurl=http://download.fedoraproject.org/pub/epel/6/$basearch</a></h2> <p>mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-6&amp;arch=$basearch failovermethod=priority enabled=1 includepkgs=epel-release,python-uinput,puppet,python-lockfile,python-cpopen,python-ordereddict,python-pthreading,python-inotify,python-argparse,novnc,python-ply,python-kitchen,python-daemon,python-websockify,livecd-tools,spice-html5,mom gpgcheck=0</p> <p>[ovirt-glusterfs-epel] name=GlusterFS is a clustered file-system capable of scaling to several petabytes. baseurl=http://download.gluster.org/pub/gluster/glusterfs/LATEST/EPEL.repo/epel-<span class=arithmatex>\(releasever/\)</span>basearch/ enabled=1 skip_if_unavailable=1 gpgcheck=0</p> <p>[ovirt-glusterfs-noarch-epel] name=GlusterFS is a clustered file-system capable of scaling to several petabytes. baseurl=http://download.gluster.org/pub/gluster/glusterfs/LATEST/EPEL.repo/epel-$releasever/noarch enabled=1 skip_if_unavailable=1 gpgcheck=0</p> <h3 id=hosted-engine><a class=toclink href=../../2014/04/29/12-%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8ovirthosted-engine/#hosted-engine>安装hosted-engine</a></h3> <h2 id=yum-install-ovirt-hosted-engine-setup_1><a class=toclink href=../../2014/04/29/12-%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8ovirthosted-engine/#yum-install-ovirt-hosted-engine-setup_1>yum install ovirt-hosted-engine-setup</a></h2> <p>回答一些列问题，如下所示：</p> <h2 id=hosted-engine-deploy><a class=toclink href=../../2014/04/29/12-%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8ovirthosted-engine/#hosted-engine-deploy>hosted-engine --deploy</a></h2> <p>[ INFO ] Stage: Initializing Continuing will configure this host for serving as hypervisor and create a VM where you have to install oVirt Engine afterwards. Are you sure you want to continue? (Yes, No)[Yes]: yes [ INFO ] Generating a temporary VNC password. [ INFO ] Stage: Environment setup Configuration files: [] Log file: /var/log/ovirt-hosted-engine-setup/ovirt-hosted-engine-setup-20140508182241.log Version: otopi-1.2.0 (otopi-1.2.0-1.el6) [ INFO ] Hardware supports virtualization [ INFO ] Bridge ovirtmgmt already created [ INFO ] Stage: Environment packages setup [ INFO ] Stage: Programs detection [ INFO ] Stage: Environment setup [ INFO ] Stage: Environment customization</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code>      --== STORAGE CONFIGURATION ==--

      During customization use CTRL-D to abort.
      Please specify the storage you would like to use (nfs3, nfs4)\[nfs3\]:
</code></pre></div></td></tr></table></div> <h2 id=hosted-engine_1><a class=toclink href=../../2014/04/29/12-%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8ovirthosted-engine/#hosted-engine_1>此处的存储域只存储hosted-engine的相关文件，不作为主数据域</a></h2> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code>      Please specify the full shared storage connection path to use (example: host:/path): 192.168.10.101:/gluster-vol1/ovirt\_data/hosted\_engine
</code></pre></div></td></tr></table></div> <p>[ INFO ] Installing on first host Please provide storage domain name. [hosted_storage]: Local storage datacenter name is an internal name and currently will not be shown in engine's admin UI.Please enter local datacenter name [hosted_datacenter]: </p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code>      --== SYSTEM CONFIGURATION ==--


      --== NETWORK CONFIGURATION ==--

      iptables was detected on your computer, do you wish setup to configure it? (Yes, No)\[Yes\]: no
      Please indicate a pingable gateway IP address \[192.168.10.1\]:

      --== VM CONFIGURATION ==--
</code></pre></div></td></tr></table></div> <h2 id=engine><a class=toclink href=../../2014/04/29/12-%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8ovirthosted-engine/#engine>虚拟engine的安装方式</a></h2> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span></pre></div></td><td class=code><div><pre><span></span><code>      Please specify the device to boot the VM from (cdrom, disk, pxe) \[cdrom\]: 
      The following CPU types are supported by this host:
         - model\_Conroe: Intel Conroe Family
      Please specify the CPU type to be used by the VM \[model\_Conroe\]: 
      Please specify path to installation media you would like to use \[None\]: /tmp/centos.iso
      Please specify the number of virtual CPUs for the VM \[Defaults to minimum requirement: 2\]: 
      Please specify the disk size of the VM in GB \[Defaults to minimum requirement: 25\]: 
      You may specify a MAC address for the VM or accept a randomly generated default \[00:16:3e:59:9b:e2\]: 
      Please specify the memory size of the VM in MB \[Defaults to minimum requirement: 4096\]: 4096
      Please specify the console type you would like to use to connect to the VM (vnc, spice) \[vnc\]:

      --== HOSTED ENGINE CONFIGURATION ==--

      Enter the name which will be used to identify this host inside the Administrator Portal \[hosted\_engine\_1\]: 
      Enter &#39;admin@internal&#39; user password that will be used for accessing the Administrator Portal: 
      Confirm &#39;admin@internal&#39; user password: 
      Please provide the FQDN for the engine you would like to use.
      This needs to match the FQDN that you will use for the engine installation within the VM.
      Note: This will be the FQDN of the VM you are now going to create,
      it should not point to the base host or to any other existing machine.
      Engine FQDN: ha.lofyer.org
</code></pre></div></td></tr></table></div> <p>[WARNING] Failed to resolve ha.lofyer.org using DNS, it can be resolved only locally Please provide the name of the SMTP server through which we will send notifications [localhost]: Please provide the TCP port number of the SMTP server [25]: Please provide the email address from which notifications will be sent [root@localhost]: Please provide a comma-separated list of email addresses which will get notifications [root@localhost]: [ INFO ] Stage: Setup validation</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span></pre></div></td><td class=code><div><pre><span></span><code>      --== CONFIGURATION PREVIEW ==--

      Engine FQDN                        : ha.lofyer.org
      Bridge name                        : ovirtmgmt
      SSH daemon port                    : 22
      Gateway address                    : 192.168.10.1
      Host name for web application      : hosted\_engine\_1
      Host ID                            : 1
      Image size GB                      : 25
      Storage connection                 : 192.168.10.101:/gluster-vol1/ovirt\_data/hosted\_data/
      Console type                       : vnc
      Memory size MB                     : 4096
      MAC address                        : 00:16:3e:59:9b:e2
      Boot type                          : cdrom
      Number of CPUs                     : 2
      ISO image (for cdrom boot)         : /tmp/centos.iso
      CPU Type                           : model\_Conroe

      Please confirm installation settings (Yes, No)\[No\]: yes
</code></pre></div></td></tr></table></div> <p>[ INFO ] Generating answer file '/etc/ovirt-hosted-engine/answers.conf' [ INFO ] Stage: Transaction setup [ INFO ] Stage: Misc configuration [ INFO ] Stage: Package installation [ INFO ] Stage: Misc configuration [ INFO ] Configuring libvirt [ INFO ] Configuring VDSM [ INFO ] Starting vdsmd [ INFO ] Waiting for VDSM hardware info [ INFO ] Waiting for VDSM hardware info [ INFO ] Waiting for VDSM hardware info [ INFO ] Waiting for VDSM hardware info [ INFO ] Creating Storage Domain [ INFO ] Creating Storage Pool [ INFO ] Connecting Storage Pool [ INFO ] Verifying sanlock lockspace initialization [ INFO ] Initializing sanlock lockspace [ INFO ] Initializing sanlock metadata [ INFO ] Creating VM Image [ INFO ] Disconnecting Storage Pool [ INFO ] Start monitoring domain [ INFO ] Configuring VM [ INFO ] Updating hosted-engine configuration [ INFO ] Stage: Transaction commit [ INFO ] Stage: Closing up The following network ports should be opened: tcp:5900 tcp:5901 udp:5900 udp:5901 An example of the required configuration for iptables can be found at: /etc/ovirt-hosted-engine/iptables.example In order to configure firewalld, copy the files from /etc/ovirt-hosted-engine/firewalld to /etc/firewalld/services and execute the following commands: firewall-cmd -service hosted-console [ INFO ] Creating VM You can now connect to the VM with the following command: /usr/bin/remote-viewer vnc://localhost:5900 Use temporary password "2067OGHU" to connect to vnc console. Please note that in order to use remote-viewer you need to be able to run graphical applications. This means that if you are using ssh you have to supply the -Y flag (enables trusted X11 forwarding). Otherwise you can run the command from a terminal in your preferred desktop environment. If you cannot run graphical applications you can connect to the graphic console from another host or connect to the console using the following command: virsh -c qemu+tls://192.168.1.150/system console HostedEngine If you need to reboot the VM you will need to start it manually using the command: hosted-engine --vm-start You can then set a temporary password using the command: hosted-engine --add-console-password The VM has been started. Install the OS and shut down or reboot it. To continue please make a selection:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code>      (1) Continue setup - VM installation is complete
      (2) Reboot the VM and restart installation
      (3) Abort setup
</code></pre></div></td></tr></table></div> <h2 id=terminalremote-viewer-vnc192168101015900123hosted-engine-add-console-passwordcdromgs1enginemount-t-nfs-1921681010119216810101gluster-vol1ovirt_datahosted_data-mnt-engineraw-mntovirt_datahosted_datavm_uuid><a class=toclink href=../../2014/04/29/12-%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8ovirthosted-engine/#terminalremote-viewer-vnc192168101015900123hosted-engine-add-console-passwordcdromgs1enginemount-t-nfs-1921681010119216810101gluster-vol1ovirt_datahosted_data-mnt-engineraw-mntovirt_datahosted_datavm_uuid>需要在另外一个有图形能力的terminal中运行"remote-viewer vnc://192.168.10.101:5900"连接虚拟机并关闭（密码在第123行），如有需要可运行"hosted-engine --add-console-password"更换控制台密码。如果之前选择cdrom进行安装的话，此处可以在gs1上用已经安装好engine的虚拟磁盘进行覆盖，类似"mount -t nfs 192.168.10.101:192.168.10.101:/gluster-vol1/ovirt_data/hosted_data/ /mnt; engine.raw /mnt/ovirt_data/hosted_data/.../vm_UUID"</a></h2> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code>      (1, 2, 3)\[1\]: 1
      Waiting for VM to shut down...
</code></pre></div></td></tr></table></div> <p>[ INFO ] Creating VM You can now connect to the VM with the following command: /usr/bin/remote-viewer vnc://localhost:5900 Use temporary password "2067OGHU" to connect to vnc console. Please note that in order to use remote-viewer you need to be able to run graphical applications. This means that if you are using ssh you have to supply the -Y flag (enables trusted X11 forwarding). Otherwise you can run the command from a terminal in your preferred desktop environment. If you cannot run graphical applications you can connect to the graphic console from another host or connect to the console using the following command: virsh -c qemu+tls://192.168.1.150/system console HostedEngine If you need to reboot the VM you will need to start it manually using the command: hosted-engine --vm-start You can then set a temporary password using the command: hosted-engine --add-console-password Please install and setup the engine in the VM. You may also be interested in installing ovirt-guest-agent-common package in the VM. To continue make a selection from the options below: (1) Continue setup - engine installation is complete (2) Power off and restart the VM (3) Abort setup</p> <h2 id=engine-setup-offlineengine><a class=toclink href=../../2014/04/29/12-%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8ovirthosted-engine/#engine-setup-offlineengine>此处参考第一次操作，连接虚拟机控制台后进行"engine-setup --offline"以安装engine</a></h2> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code>      (1, 2, 3)\[1\]: 1
</code></pre></div></td></tr></table></div> <p>[ INFO ] Engine replied: DB Up!Welcome to Health Status! [ INFO ] Waiting for the host to become operational in the engine. This may take several minutes... [ INFO ] Still waiting for VDSM host to become operational... [ INFO ] The VDSM Host is now operational Please shutdown the VM allowing the system to launch it as a monitored service.</p> <h2 id=_2><a class=toclink href=../../2014/04/29/12-%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8ovirthosted-engine/#_2>到此，需要连接虚拟机控制台关闭虚拟机</a></h2> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code>      The system will wait until the VM is down.
</code></pre></div></td></tr></table></div> <p>[ INFO ] Enabling and starting HA services Hosted Engine successfully set up [ INFO ] Stage: Clean up [ INFO ] Stage: Pre-termination [ INFO ] Stage: Termination</p> <p>此时，运行"hosted-engine --vm-start"启动engine。</p> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2014-04-24 00:00:00">2014年4月24日</time></li> <li class=md-meta__item> 分类于 <a href=./ class=md-meta__link>inthecloud</a></li> <li class=md-meta__item> 需要 1 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=10-ovirt><a href=../../2014/04/24/10-ovirt%E7%AE%80%E4%BB%8B/ class=toclink>10. oVirt简介</a></h2> <p>Welcome to the core!</p> <p>云计算目前主流实现有SaaS（Software-as-a-service）、PaaS（Platform-as-a-service）和IaaS（Infrastructure-as-a-service）。IaaS和PaaS都算作基础件，SaaS可以与基础件自由组合或者单独使用。</p> <p>图</p> <p>虚拟化技术已经很受重视而且被推到了一个浪尖。如今诸多开源虚拟化平台，比如XenServer、CloudStack、OpenStack、Eucalyptus、oVirt、OpenVZ等，我们都看花了眼，些许慌乱不知哪个适合自己了。</p> <p>各平台实现方式：全虚拟化，半虚拟化，TBD</p> <p>我在写这篇文档的时候，只对oVirt略知一二，其他平台（XenServer、OpenStack）稍懂皮毛，再剩下的我就没怎么用过了。那么，只挑最熟悉的来讲吧。</p> <p>IaaS云计算平台，综合来说具有以下特性：</p> <p><strong>虚拟化</strong></p> <p>虚拟化作为云计算平台的核心，是资源利用的主要形式之一。网络、存储、CPU乃至GPU等主要通过虚拟主机进行实体化。</p> <p><strong>分布式</strong></p> <p>分布式可利用共享的存储，通过网络将资源进行整合，是实现资源化的必备条件。</p> <p><strong>高可用</strong></p> <p>对于规模庞大的云平台，提供管理节点、重要服务的高度可用性是十分必要的。笔者在写这篇文章时，oVirt 3.4已经可以做到管理节点的高度可用。</p> <p><strong>兼容性</strong></p> <p>云计算平台众多，各家有各家的特点，同一数据中心部署不同的平台的可能性极大，因此，主要服务（比如虚拟网络、存储、虚机等）要有一定兼容性，比如oVirt可以利用OpenStack的Nouveau提供的虚拟网络、Foreman可以方便地在oVirt上部署新机器等。</p> <p>另外，也有DeltaCloud、libvirt等API，用户可以利用它们自由地实现自己的云综合管理工具。</p> <p><strong>资源池化</strong></p> <p>网络、存储、CPU或者GPU可以综合或者单独划分资源池，通过配额进行分配，从而保证其合理利用。</p> <p><strong>安全性</strong></p> <p>现代企业对于安全性的要求已经十分苛刻，除去传统数据加密、访问控制，甚至对于社会工程也要有一定防护能力；用户数据具有对非企业管理员具有防护性能，即使将虚拟机磁盘文件拷贝出来也不能直接获取其内容。</p> <p><strong>需求导向性</strong></p> <p>在计算水平上，优质资源最先提供给重要服务；服务水平上，平台具有可定制能力。</p> <h3 id=ovirt><a class=toclink href=../../2014/04/24/10-ovirt%E7%AE%80%E4%BB%8B/#ovirt>oVirt物理层视图</a></h3> <p><strong>管理独占一台物理机</strong></p> <p><a href=http://blog.lofyer.org/cloud-6-1-ovirt-description/normal/ ><img alt=Normal src=/blog/images/Normal.png></a></p> <p>高可用管理机</p> <p><a href=http://blog.lofyer.org/cloud-6-1-ovirt-description/ha/ ><img alt=HA src=/blog/images/HA.png></a></p> <h3 id=_1><a class=toclink href=../../2014/04/24/10-ovirt%E7%AE%80%E4%BB%8B/#_1>内容预览</a></h3> <p>第11（6-2）搭建管理引擎； 第12（6-3）搭建高可用管理引擎； 第13（6-4）加入节点，构建一个完整的云平台； 第14（6-5）应用进阶；</p> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2014-04-21 00:00:00">2014年4月21日</time></li> <li class=md-meta__item> 分类于 <a href=./ class=md-meta__link>inthecloud</a></li> <li class=md-meta__item> 需要 2 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=9-glusterfs><a href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/ class=toclink>9. glusterfs应用示例及技巧</a></h2> <h3 id=_1><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#_1>文件权限</a></h3> <p>glusterfs在创建卷时会更改砖块所有者为root.root，对于某些应用请注意更改砖块目录所有者（比如在_/etc/rc.local_中添加chown，不要更改砖块下隐藏目录.glusterfs）。</p> <h3 id=_2><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#_2>砖块分割</a></h3> <p>前文所述的砖块划分方式在某些场景下不是很好，可以在/brickX下创建目录，比如data1，同时在创建glusterfs卷的时候使用HOST:/brickX/data1作为砖块，以合理利用存储空间。</p> <h3 id=normalreplicastriped><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#normalreplicastriped>normal、replica、striped卷组合</a></h3> <p>砖块的划分排序：striped（normal）优先，replica在striped（normal）基础上做冗余；计算大小时，同一replica组中的brick进行合并（多个算作一个），一个striped组可看做一个有效块，。 假设我们有4个主机，8个砖块，每个砖块都是5GB，如下图，</p> <p><a href=http://blog.lofyer.org/5-4-gluster-trick/brick-base/ ><img alt=brick-base src=/blog/images/brick-base.png></a></p> <p>创建卷时，使用如下命令：</p> <h2 id=gluster-volume-create-gluster-vol1-stripe-2-replica-2-host1brick1-host1brick2-host2brick1-host2brick2-host3brick1-host3brick2-host4brick1-host4brick2-force><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#gluster-volume-create-gluster-vol1-stripe-2-replica-2-host1brick1-host1brick2-host2brick1-host2brick2-host3brick1-host3brick2-host4brick1-host4brick2-force>gluster volume create gluster-vol1 stripe 2 replica 2 host1:/brick1 host1:/brick2 host2:/brick1 host2:/brick2 host3:/brick1 host3:/brick2 host4:/brick1 host4:/brick2 force</a></h2> <p>则会进行下列组合：</p> <p><a href=http://blog.lofyer.org/5-4-gluster-trick/brick-1/ ><img alt=brick-1 src=/blog/images/brick-1.png></a></p> <p>创建卷时，使用如下命令：</p> <h2 id=gluster-volume-create-gluster-vol1-stripe-2-replica-2-host1brick1-host2brick1-host3brick1-host4brick1-host1brick2-host2brick2-host3brick2-host4brick2-force><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#gluster-volume-create-gluster-vol1-stripe-2-replica-2-host1brick1-host2brick1-host3brick1-host4brick1-host1brick2-host2brick2-host3brick2-host4brick2-force>gluster volume create gluster-vol1 stripe 2 replica 2 host1:/brick1 host2:/brick1 host3:/brick1 host4:/brick1 host1:/brick2 host2:/brick2 host3:/brick2 host4:/brick2 force</a></h2> <p>则会进行下列组合（注意颜色，可改为实虚线）：</p> <p><a href=http://blog.lofyer.org/5-4-gluster-trick/brick-2/ ><img alt=brick-2 src=/blog/images/brick-2.png></a></p> <h3 id=nfs><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#nfs>作为nfs挂载</a></h3> <p><strong>由于glusterfs占用了2049端口，所以其与nfs server一般不能共存于同一台服务器，除非更改nfs服务端口。</strong></p> <p>mount -t nfs -o vers=3 server1:/volume1 /mnt</p> <h3 id=cifs><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#cifs>作为cifs挂载</a></h3> <p>先在某一服务器或者客户端将起挂载，再以cifs方式导出</p> <p>[glustertest] comment = For testing a Gluster volume exported through CIFS path = /mnt/glusterfs read only = no guest ok = yes</p> <h3 id=_3><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#_3>进阶手册</a></h3> <h4 id=1-split-brain><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#1-split-brain>1. 裂脑(split-brain)修复</a></h4> <p>裂脑发生以后，各节点信息可能会出现不一致。可以通过以下步骤查看并修复。</p> <p><strong>定位裂脑文件</strong> 通过命令</p> <h2 id=gluster-volume-heal-info-split-brain><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#gluster-volume-heal-info-split-brain>gluster volume heal info split-brain</a></h2> <p>或者查看在客户端仍然是Input/Output错误的文件。 <strong>关闭已经打开的文件或者虚机</strong> <strong>确定正确副本</strong> <strong>恢复扩展属性</strong></p> <h4 id=2><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#2>2. 砖块重用</a></h4> <p>当一个volume正在使用时，你删除了其中一个brick，会出现“/bricks/app or a prefix of it is already part of a volume”，对于3.3版本以后的glusterfs有此问题。 解决方法：</p> <h2 id=setfattr-x-trustedglusterfsvolume-id-brick_path><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#setfattr-x-trustedglusterfsvolume-id-brick_path>setfattr -x trusted.glusterfs.volume-id $brick_path</a></h2> <h2 id=setfattr-x-trustedgfid-brick_path><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#setfattr-x-trustedgfid-brick_path>setfattr -x trusted.gfid $brick_path</a></h2> <h2 id=rm-rf-brick_pathglusterfs><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#rm-rf-brick_pathglusterfs>rm -rf $brick_path/.glusterfs</a></h2> <h4 id=3><a class=toclink href=../../2014/04/21/9-glusterfs%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%8F%8A%E6%8A%80%E5%B7%A7/#3>3. 扩展</a></h4> <p>对于中等以上规模的部署，需要使用dns服务器去解析各个节点以免去修改hosts文件的麻烦。</p> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2014-04-11 00:00:00">2014年4月11日</time></li> <li class=md-meta__item> 分类于 <a href=./ class=md-meta__link>inthecloud</a></li> <li class=md-meta__item> 需要 5 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=8-glusterfs><a href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/ class=toclink>8. 搭建glusterfs作为基础存储</a></h2> <p>既然要搭建一个稳健的基础，那么glusterfs在此使用distributed striped replicated方式，这里使用4台预装CentOS 6(SELINUX设置为permissive)的机器。</p> <p><a href=http://blog.lofyer.org/5-3-glusterfs-howto/distributed_striped_replicated_volume-2/ ><img alt=Distributed_Striped_Replicated_Volume src=/blog/images/Distributed_Striped_Replicated_Volume1.png></a></p> <h3 id=dnshosts><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#dnshosts>添加DNS或者修改hosts文件</a></h3> <p>鉴于笔者所在环境中暂时没有配置独立的DNS，此处先修改hosts文件以完成配置（每台机器上都如此设置）：</p> <h2 id=echo-e-19216810101tgs1examplecomn19216810102tgs2examplecomn19216810103tgs3examplecomn19216810104tgs4examplecom-etchosts><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#echo-e-19216810101tgs1examplecomn19216810102tgs2examplecomn19216810103tgs3examplecomn19216810104tgs4examplecom-etchosts>echo -e "192.168.10.101\tgs1.example.com\n192.168.10.102\tgs2.example.com\n192.168.10.103\tgs3.example.com\n192.168.10.104\tgs4.example.com" &gt;&gt; /etc/hosts</a></h2> <h3 id=repo><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#repo>添加repo</a></h3> <p>[epel] name=Extra Packages for Enterprise Linux 6 - $basearch</p> <h2 id=baseurlhttpdownloadfedoraprojectorgpubepel6basearch><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#baseurlhttpdownloadfedoraprojectorgpubepel6basearch>baseurl=http://download.fedoraproject.org/pub/epel/6/$basearch</a></h2> <p>mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-6&amp;arch=$basearch failovermethod=priority enabled=1 gpgcheck=0 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6</p> <p>[glusterfs-epel] name=GlusterFS is a clustered file-system capable of scaling to several petabytes. baseurl=http://download.gluster.org/pub/gluster/glusterfs/LATEST/EPEL.repo/epel-<span class=arithmatex>\(releasever/\)</span>basearch/ enabled=1 skip_if_unavailable=1 gpgcheck=1 gpgkey=http://download.gluster.org/pub/gluster/glusterfs/LATEST/EPEL.repo/pub.key</p> <p>[glusterfs-noarch-epel] name=GlusterFS is a clustered file-system capable of scaling to several petabytes. baseurl=http://download.gluster.org/pub/gluster/glusterfs/LATEST/EPEL.repo/epel-$releasever/noarch enabled=1 skip_if_unavailable=1 gpgcheck=1 gpgkey=http://download.gluster.org/pub/gluster/glusterfs/LATEST/EPEL.repo/pub.key</p> <p>[glusterfs-source-epel] name=GlusterFS is a clustered file-system capable of scaling to several petabytes. - Source baseurl=http://download.gluster.org/pub/gluster/glusterfs/LATEST/EPEL.repo/epel-$releasever/SRPMS enabled=0 skip_if_unavailable=1 gpgcheck=1 gpgkey=http://download.gluster.org/pub/gluster/glusterfs/LATEST/EPEL.repo/pub.key</p> <h3 id=_1><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#_1>准备磁盘</a></h3> <p>每一个节点都可以看做gluster server，安装xfs用户空间工具：</p> <h2 id=yum-install-y-glusterfs-glusterfs-fuse-glusterfs-server-xfsprogs><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#yum-install-y-glusterfs-glusterfs-fuse-glusterfs-server-xfsprogs>yum install -y glusterfs glusterfs-fuse glusterfs-server xfsprogs</a></h2> <h2 id=etcinitdglusterd-start><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#etcinitdglusterd-start>/etc/init.d/glusterd start</a></h2> <h2 id=etcinitdglusterfsd-start><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#etcinitdglusterfsd-start>/etc/init.d/glusterfsd start</a></h2> <h2 id=chkconfig-glusterfsd-on><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#chkconfig-glusterfsd-on>chkconfig glusterfsd on</a></h2> <h2 id=chkconfig-glusterd-on><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#chkconfig-glusterd-on>chkconfig glusterd on</a></h2> <p>假如每台机器除系统盘之外都有2块1T SATA硬盘。 对其进行分区，创建逻辑卷，格式化并挂载：</p> <h2 id=fdisk-devsdx-eof><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#fdisk-devsdx-eof>fdisk /dev/sdX &lt;&lt; EOF</a></h2> <p>n p 1</p> <p>w EOF</p> <p>直接使用物理盘：</p> <h2 id=mkfsxfs-i-size-512-devsdb1><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#mkfsxfs-i-size-512-devsdb1>mkfs.xfs -i size 512 /dev/sdb1</a></h2> <h2 id=mkfsxfs-i-size-512-devsdc1><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#mkfsxfs-i-size-512-devsdc1>mkfs.xfs -i size 512 /dev/sdc1</a></h2> <h2 id=mkdir-gluster_brick0><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#mkdir-gluster_brick0>mkdir /gluster_brick0</a></h2> <h2 id=mkdir-gluster_brick1><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#mkdir-gluster_brick1>mkdir /gluster_brick1</a></h2> <h2 id=echo-e-devsdb1tgluster_brick0txfstdefaultst0-0ndevsdc1tgluster_brick1txfstdefaultst0-0-etcfstab><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#echo-e-devsdb1tgluster_brick0txfstdefaultst0-0ndevsdc1tgluster_brick1txfstdefaultst0-0-etcfstab>echo -e "/dev/sdb1\t/gluster_brick0\txfs\tdefaults\t0 0\n/dev/sdc1\t/gluster_brick1\txfs\tdefaults\t0 0" &gt;&gt; /etc/fstab</a></h2> <h2 id=mount-a><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#mount-a>mount -a</a></h2> <p>或者使用逻辑卷：</p> <h2 id=pvcreate-devsdb1-devsdc1><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#pvcreate-devsdb1-devsdc1>pvcreate /dev/sdb1 /dev/sdc1</a></h2> <h2 id=vgcreate-vg_gluster-devsdb1-devsdc1><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#vgcreate-vg_gluster-devsdb1-devsdc1>vgcreate vg_gluster /dev/sdb1 /dev/sdc1</a></h2> <h2 id=lvcreate-name-lv_gluster-size-2500g-vg_gluster><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#lvcreate-name-lv_gluster-size-2500g-vg_gluster>lvcreate --name lv_gluster --size 2500G vg_gluster</a></h2> <h2 id=mkfsxfs-i-size-512-devvg_gluster-lv_gluster><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#mkfsxfs-i-size-512-devvg_gluster-lv_gluster>mkfs.xfs -i size 512 /dev/vg_gluster-lv_gluster</a></h2> <h2 id=mkdir-gluster_brick><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#mkdir-gluster_brick>mkdir /gluster_brick</a></h2> <h2 id=echo-e-devmappervg_gluster-lv_glustertgluster_bricktxfstdefaultst0-0-etcfstab><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#echo-e-devmappervg_gluster-lv_glustertgluster_bricktxfstdefaultst0-0-etcfstab>echo -e "/dev/mapper/vg_gluster-lv_gluster\t/gluster_brick\txfs\tdefaults\t0 0" &gt;&gt; /etc/fstab</a></h2> <h2 id=mount-a_1><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#mount-a_1>mount -a</a></h2> <p><em>为什么要用XFS？</em> XFS具有元数据日志功能，可以快速恢复数据；同时，可以在线扩容及碎片整理。其他文件系统比如EXT3，EXT4未做充分测试。</p> <h3 id=volume><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#volume>配置节点，添加volume</a></h3> <p>在其中任何一台机器上，比如gs2.example.com，执行：</p> <h2 id=gluster><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#gluster>gluster</a></h2> <blockquote> <p>peer probe gs1.example.com peer probe gs2.example.com</p> </blockquote> <p>添加brick至volume，<strong>合理调整砖块顺序</strong>：</p> <h2 id=gluster_1><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#gluster_1>gluster</a></h2> <blockquote> <p>volume create gluster-vol1 stripe 2 replica 2 gs1.example.com:/gluster_brick0 gs1.example.com:/gluster_brick1 gs2.example.com:/gluster_brick0 gs2.example.com:/gluster_brick1 gs3.example.com:/gluster_brick0 gs3.example.com:/gluster_brick1 gs4.example.com:/gluster_brick0 gs4.example.com:/gluster_brick1 force volume start gluster-vol1 volume status Status of volume: gluster-vol1 Gluster process Port Online Pid</p> </blockquote> <hr> <p>Brick gs1.example.com:/gluster_brick0 49152 Y 1984 Brick gs1.example.com:/gluster_brick1 49153 Y 1995 Brick gs2.example.com:/gluster_brick0 49152 Y 1972 Brick gs2.example.com:/gluster_brick1 49153 Y 1983 Brick gs3.example.com:/gluster_brick0 49152 Y 1961 Brick gs3.example.com:/gluster_brick1 49153 Y 1972 Brick gs4.example.com:/gluster_brick0 49152 Y 1975 Brick gs4.example.com:/gluster_brick1 49153 Y 1986 NFS Server on localhost 2049 Y 1999 Self-heal Daemon on localhost N/A Y 2006 NFS Server on gs2.example.com 2049 Y 2007 Self-heal Daemon on gs2.example.com N/A Y 2014 NFS Server on gs2.example.com 2049 Y 1995 Self-heal Daemon on gs2.example.com N/A Y 2002 NFS Server on gs3.example.com 2049 Y 1986 Self-heal Daemon on gs3.example.com N/A Y 1993</p> <h3 id=task-status-of-volume-gluster-vol1><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#task-status-of-volume-gluster-vol1>Task Status of Volume gluster-vol1</a></h3> <p>There are no active volume tasks</p> <blockquote> <p>volume info all gluster volume info all</p> </blockquote> <p>Volume Name: gluster-vol1 Type: Distributed-Striped-Replicate Volume ID: bc8e102c-2b35-4748-ab71-7cf96ce083f3 Status: Started Number of Bricks: 2 x 2 x 2 = 8 Transport-type: tcp Bricks: Brick1: gs1.example.com:/gluster_brick0 Brick2: gs1.example.com:/gluster_brick1 Brick3: gs2.example.com:/gluster_brick0 Brick4: gs2.example.com:/gluster_brick1 Brick5: gs3.example.com:/gluster_brick0 Brick6: gs3.example.com:/gluster_brick1 Brick7: gs4.example.com:/gluster_brick0 Brick8: gs4.example.com:/gluster_brick1</p> <h3 id=glusterfs><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#glusterfs>客户端挂载glusterfs</a></h3> <p>当用glusterfs-fuse挂载时，客户端的hosts文件里需要有gluster server中的任一节点做解析：</p> <p>127.0.0.1 localhost.localdomain localhost ::1 localhost6.localdomain6 localhost6</p> <p>192.168.1.81 gs1.example.com</p> <p>安装glusterfuse，将gluster卷作为glusterfs挂载，并写入1M文件查看其在各砖块分配：</p> <h2 id=yum-install-glusterfs-glusterfs-fuse><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#yum-install-glusterfs-glusterfs-fuse>yum install glusterfs glusterfs-fuse</a></h2> <h2 id=mountglusterfs-192168181gluster-vol1-mnt><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#mountglusterfs-192168181gluster-vol1-mnt>mount.glusterfs 192.168.1.81:/gluster-vol1 /mnt</a></h2> <h2 id=cd-mnt><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#cd-mnt>cd /mnt</a></h2> <h2 id=dd-ifdevzero-ofaimg-bs1k-count1k><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#dd-ifdevzero-ofaimg-bs1k-count1k>dd if=/dev/zero of=a.img bs=1k count=1k</a></h2> <h2 id=cp-aimg-bimg-cp-aimg-cimg-cp-aimg-dimg><a class=toclink href=../../2014/04/11/8-%E6%90%AD%E5%BB%BAglusterfs%E4%BD%9C%E4%B8%BA%E5%9F%BA%E7%A1%80%E5%AD%98%E5%82%A8/#cp-aimg-bimg-cp-aimg-cimg-cp-aimg-dimg>cp a.img b.img; cp a.img c.img; cp a.img d.img</a></h2> <p>在四台服务端分别查看：</p> <p>[root@gs1 ~]# ls -lh /gluster_brick* /gluster_brick0: total 1.0M -rw-r--r--. 2 root root 512K Apr 22 17:13 a.img -rw-r--r--. 2 root root 512K Apr 22 17:13 d.img /gluster_brick1: total 1.0M -rw-r--r--. 2 root root 512K Apr 22 17:13 a.img -rw-r--r--. 2 root root 512K Apr 22 17:13 d.img</p> <p>[root@gs2 ~]# ls -lh /gluster_brick* /gluster_brick0: total 1.0M -rw-r--r--. 2 root root 512K Apr 22 17:13 a.img -rw-r--r--. 2 root root 512K Apr 22 17:13 d.img /gluster_brick1: total 1.0M -rw-r--r--. 2 root root 512K Apr 22 17:13 a.img -rw-r--r--. 2 root root 512K Apr 22 17:13 d.img</p> <p>[root@gs3 ~]# ls -lh /gluster_brick* /gluster_brick0: total 1.0M -rw-r--r--. 2 root root 512K Apr 22 17:13 b.img -rw-r--r--. 2 root root 512K Apr 22 17:13 c.img /gluster_brick1: total 1.0M -rw-r--r--. 2 root root 512K Apr 22 17:13 b.img -rw-r--r--. 2 root root 512K Apr 22 17:13 c.img</p> <p>[root@gs4 ~]# ls -lh /gluster_brick* /gluster_brick0: total 1.0M -rw-r--r--. 2 root root 512K Apr 22 17:13 b.img -rw-r--r--. 2 root root 512K Apr 22 17:13 c.img /gluster_brick1: total 1.0M -rw-r--r--. 2 root root 512K Apr 22 17:13 b.img -rw-r--r--. 2 root root 512K Apr 22 17:13 c.img</p> <p>至此，所有配置结束，下一篇说一下使用以及部分trick。</p> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2014-04-03 00:00:00">2014年4月3日</time></li> <li class=md-meta__item> 分类于 <a href=./ class=md-meta__link>inthecloud</a></li> <li class=md-meta__item> 需要 1 分钟阅读时间 </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=6-fuse><a href=../../2014/04/03/6--fuse/ class=toclink>6. FUSE</a></h2> <p>既然是文件系统，那就不得不了解一下FUSE。</p> <p>FUSE全名Filesystem in Userspace，是在类UNIX系统下的一个机制，可以让普通用户创建修改访问文件系统。功能大体就是连接内核接口与用户控件程序的一座“桥”，目前普遍存在于多个操作系统中，比如Linux、BSD、Solaris、OSX、Android等。</p> <p><a href=http://blog.lofyer.org/5-1-1-fuse/490px-fuse_structure-svg/ ><img alt=490px-FUSE_structure.svg src=/blog/images/490px-FUSE_structure.svg_.png></a> <strong>图5-1</strong></p> <p>FUSE来源于AVFS，不同于传统文件系统从磁盘读写数据，FUSE在文件系统或磁盘中有“转换”的角色，本身并不会存储数据。</p> <p>在Linux系统中的实现有很多，比如即将要用到的glusterfs-fuse。</p> </div> </article> <nav class=md-pagination> <span class=md-pagination__current>1</span> <a href=page/2/ class=md-pagination__link>2</a> </nav> </div> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2008 - 2022 lofyer </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["search.suggest", "search.highlight", "navigation.tabs", "navigation.tabs.sticky", "navigation.tracking", "navigation.prune"], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script> <script src=../../../assets/javascripts/bundle.ad660dcc.min.js></script> <script src=../../../javascripts/config.js></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> </body> </html>